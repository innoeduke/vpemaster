<div id="usageWarningModal" class="modal usage-warning-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-exclamation-triangle"></i> Deletion Blocked</h2>
            <span class="close" onclick="closeUsageWarningModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="usageWarningMessage"></p>
            <div class="usage-list-container">
                <table id="usageWarningTable" class="premium-table">
                    <thead>
                        <tr>
                            <th>Meeting</th>
                            <th>Session Title</th>
                            <th>Owner</th>
                        </tr>
                    </thead>
                    <tbody id="usageWarningBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <p class="usage-footer">Please reassign or delete these logs before deleting the session type.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="deleteAllLogsBtn" onclick="deleteAllBlockingLogs()">
                <i class="fas fa-trash-alt"></i> Delete ALL
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeUsageWarningModal()">Close</button>
        </div>
    </div>
</div>

<script>
let currentUsageId = null;
let currentUsageType = null;

function closeUsageWarningModal() {
    const modal = document.getElementById('usageWarningModal');
    if (modal) modal.style.display = 'none';
    currentUsageId = null;
    currentUsageType = null;
}

function showUsageWarningModal(message, logs, id, type) {
    const modal = document.getElementById('usageWarningModal');
    const msgEl = document.getElementById('usageWarningMessage');
    const tbody = document.getElementById('usageWarningBody');
    const footerLabel = document.querySelector('.usage-footer');
    
    if (!modal || !msgEl || !tbody) return;
    
    currentUsageId = id;
    currentUsageType = type || 'session';
    msgEl.textContent = message;
    tbody.innerHTML = '';
    
    if (footerLabel) {
        footerLabel.textContent = currentUsageType === 'session' 
            ? "Please reassign or delete these logs before deleting the session type."
            : "Please reassign or unassign these roles before deleting the role.";
    }
    
    logs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><a href="/agenda?meeting_number=${log.meeting_number}" class="usage-meeting-link" target="_blank">#${log.meeting_number}</a></td>
            <td>${log.session_title}</td>
            <td><span class="usage-owner">${log.owner_name || 'Unassigned'}</span></td>
        `;
        tbody.appendChild(tr);
    });
    
    modal.style.display = 'flex';
}

function deleteAllBlockingLogs() {
    if (!currentUsageId) {
        alert('ID not found.');
        return;
    }
    
    const confirmMsg = currentUsageType === 'session'
        ? 'Are you sure you want to delete ALL session logs of this type? This action cannot be undone.'
        : 'Are you sure you want to clear ALL meeting assignments for this role? This will unassign the role from all meetings listed below.';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    const endpoint = currentUsageType === 'session'
        ? `/settings/sessions/delete-logs/${currentUsageId}`
        : `/settings/roles/delete-logs/${currentUsageId}`;
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeUsageWarningModal();
            location.reload();
        } else {
            alert(data.message || 'An error occurred while clearing the usage.');
        }
    })
    .catch(error => {
        console.error('Usage clearing error:', error);
        alert('An error occurred while clearing the usage.');
    });
}
</script>
