{% extends "base.html" %}
{% block title %}User Profile{% endblock %}
{% block flash_messages %}{% endblock %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% set flashes = messages %}
{% if flashes %}
<div class="flash-container-inline" style="max-width: 700px; margin: 20px auto 0 auto;">
  {% for category, message in flashes %}
  <div class="flash {{ category }}">
    {{ message }}
    <span class="close-flash" onclick="this.parentElement.remove();">&times;</span>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="tabs-container" style="max-width: 700px; margin: 0 auto; margin-top: 40px;">
  <div class="nav-tabs">
    <button class="nav-item active" onclick="openTab(event, 'basic-info')" id="tab-basic-info">Basic
      Information</button>
    {% if is_own_profile or can_reset_password %}
    <button class="nav-item" onclick="openTab(event, 'reset-password')" id="tab-reset-password">Reset Password</button>
    {% endif %}
  </div>
</div>

<div id="basic-info" class="tab-content" style="display: block;">
  <h2 style="text-align: center; margin-top: 20px; margin-bottom: 20px">
    Basic Information
  </h2>
  <form id="profile-form" method="POST" action="{{ url_for('auth_bp.profile') }}" enctype="multipart/form-data"
    style="max-width: 700px; margin: 0 auto">
    <div class="profile-avatar-container">
      <div id="avatar-placeholder" class="avatar-placeholder"
        style="display: {% if user.contact and user.contact.Avatar_URL %}none{% else %}flex{% endif %};">
        <i class="fas fa-user"></i>
      </div>
      {% if user.contact and user.contact.Avatar_URL %}
      {# Check if the URL is already a full path (legacy) or just a filename (new) #}
      {% set avatar_path = user.contact.Avatar_URL %}
      {% if '/' not in avatar_path %}
        {% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
      {% endif %}
      <img src="{{ url_for('static', filename=avatar_path) }}" alt="Avatar" class="profile-avatar"
        onerror="this.style.display='none'; document.getElementById('avatar-placeholder').style.display='flex';">
      {% endif %}

      {% if can_edit_profile %}
      <div class="avatar-upload-section">
        <label for="profile_photo_input" class="btn-upload">Change Photo</label>
        <input type="file" id="profile_photo_input" name="profile_photo" accept="image/*" 
               onchange="validateAvatar(this)" style="display: none;" />
      </div>
      {% endif %}
    </div>

    <input type="hidden" name="action" value="update_profile" />
    
    <div class="profile-form">
      <!-- Section 1: Basic Information -->
      <div class="profile-section">
        <h3 class="section-title">Basic Information</h3>
        <!-- Username & Role - side by side at top -->
        <div class="field-row-pair">
          <div class="field-row">
            <span class="field-label">Username</span>
            <span class="field-value">
              {{ user.username }}
              {% if user.contact and user.contact.DTM %}<sup class="dtm-superscript">DTM</sup>{% endif %}
            </span>
          </div>
          <div class="field-row">
            <span class="field-label">Role</span>
            <span class="field-value">
              {% set role = user.primary_role %}
              {% set role_class = 'role-' ~ role.award_category if (role and role.award_category) else 'role-other' %}
              {% if role and role.type == 'officer' %}{% set role_class = 'role-officer' %}{% endif %}
              <span class="roster-role-tag {{ role_class }}">{{ user.primary_role_name }}</span>
            </span>
          </div>
        </div>

        <!-- Name row - side by side -->
        <div class="field-row-pair">
          <div class="field-row editable">
            <span class="field-label">First Name</span>
            <div class="field-input-wrapper">
              <input type="text" id="first_name" name="first_name" class="field-input"
                value="{{ user.first_name if user.first_name else '' }}"
                {% if not can_edit_profile %}disabled{% endif %} />
            </div>
          </div>
          <div class="field-row editable">
            <span class="field-label">Last Name</span>
            <div class="field-input-wrapper">
              <input type="text" id="last_name" name="last_name" class="field-input"
                value="{{ user.last_name if user.last_name else '' }}"
                {% if not can_edit_profile %}disabled{% endif %} />
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: Contact Information -->
      <div class="profile-section">
        <h3 class="section-title">Contact Information</h3>
        <!-- Email - full width -->
        <div class="field-row editable">
          <span class="field-label">Email</span>
          <div class="field-input-wrapper">
            <input type="email" id="email" name="email" class="field-input"
              value="{{ user.email if user.email else '' }}"
              autocomplete="email" {% if not can_edit_profile %}disabled{% endif %} />
          </div>
        </div>

        <!-- Phone - full width -->
        <div class="field-row editable">
          <span class="field-label">Phone</span>
          <div class="field-input-wrapper">
            <input type="text" id="phone_number" name="phone_number" class="field-input"
              value="{{ user.contact.Phone_Number if user.contact.Phone_Number else '' }}"
              autocomplete="tel" {% if not can_edit_profile %}disabled{% endif %} />
          </div>
        </div>
      </div>

      {% if user.contact %}
      <!-- Section 3: Toastmasters -->
      <div class="profile-section">
        <h3 class="section-title">Toastmasters</h3>
        <!-- Home Club -->
        <div class="field-row">
          <span class="field-label">Home Club</span>
          <span class="field-value">
            {% if user.home_club %}{{ user.home_club.club_name }}{% else %}<span class="text-muted">None</span>{% endif %}
          </span>
        </div>

        <!-- Member ID & Mentor - side by side -->
        <div class="field-row-pair">
          <div class="field-row">
            <span class="field-label">Member ID</span>
            <span class="field-value">{{ user.contact.Member_ID if user.contact.Member_ID else '' }}</span>
          </div>
          <div class="field-row">
            <span class="field-label">Mentor</span>
            <span class="field-value">{{ user.contact.mentor.Name if user.contact.mentor else '' }}</span>
          </div>
        </div>

        <!-- Credential & Next Project - side by side -->
        <div class="field-row-pair">
          <div class="field-row">
            <span class="field-label">Credential</span>
            <span class="field-value">{{ user.contact.credentials if user.contact.credentials else '' }}</span>
          </div>
          <div class="field-row">
            <span class="field-label">Next Project</span>
            <span class="field-value">{{ user.contact.Next_Project if user.contact.Next_Project else '' }}</span>
          </div>
        </div>
      </div>

      <!-- Section 4: About Me -->
      <div class="profile-section">
        <h3 class="section-title">About Me</h3>
        <!-- Bio -->
        <div class="field-row editable bio-row">
          <div class="field-input-wrapper">
            <textarea id="bio" name="bio" class="field-textarea" rows="4"
              {% if not can_edit_profile %}disabled{% endif %}>{{ user.contact.Bio if user.contact.Bio else '' }}</textarea>
          </div>
        </div>
      </div>
      {% else %}
      <div class="profile-section">
        <div class="field-row">
          <em>This user account is not linked to a contact record.</em>
        </div>
      </div>
      {% endif %}
    </div>
    {% if can_edit_profile %}
    <div class="form-actions" style="margin-top: 10px">
      <button type="submit" id="update-profile-btn" class="btn btn-primary" disabled>Update Profile</button>
    </div>
    {% endif %}
  </form>
</div>

{% if is_own_profile or can_reset_password %}
<div id="reset-password" class="tab-content" style="display: none;">
  <h2 style="text-align: center; margin-top: 20px; margin-bottom: 20px">
    Reset Password
  </h2>
  
  <form method="POST" action="{% if is_own_profile %}{{ url_for('auth_bp.profile', tab='password') }}{% else %}{{ url_for('auth_bp.profile', contact_id=user.contact.id, tab='password') }}{% endif %}"
    style="max-width: 700px; margin: 0 auto">
    <input type="hidden" name="action" value="reset_password" />
    <div class="profile-form">
      <div class="profile-section">
        <div class="field-row editable vertical-value">
          <label for="new_password" class="field-label">New Password</label>
          <div class="field-input-wrapper">
            <input type="password" id="new_password" name="new_password" class="field-input" 
                   autocomplete="new-password" required minlength="8" />
            <span class="note">Minimum 8 characters.</span>
          </div>
        </div>
        <div class="field-row editable vertical-value">
          <label for="confirm_password" class="field-label">Confirm Password</label>
          <div class="field-input-wrapper">
            <input type="password" id="confirm_password" name="confirm_password" class="field-input" 
                   autocomplete="new-password" required minlength="8" />
          </div>
        </div>
      </div>
    </div>
    <div class="form-actions" style="margin-top: 10px; display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
      {% if not is_own_profile and can_reset_password %}
      <button type="submit" name="admin_reset" value="true" class="btn btn-warning" formnovalidate onclick="return confirm('Are you sure you want to reset the password to \'toastmasters\'?');">
          Reset to "toastmasters"
      </button>
      {% endif %}
      <button type="submit" class="btn btn-success">Save</button>
    </div>
  </form>
</div>
{% endif %}

<script>
  function validateAvatar(input) {
    if (input.files && input.files.length > 0) {
      const file = input.files[0];
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        alert('File is too large. Max size is 5MB.');
        input.value = ''; // Clear the input
        return;
      }
      input.form.submit();
    }
  }

  function openTab(evt, tabName) {
    var i, tabcontent, tablinks;

    // Hide all tab content
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    // Remove active class from all tab links
    tablinks = document.getElementsByClassName("nav-item");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the specific tab content and add active class to the button
    document.getElementById(tabName).style.display = "block";
    if (evt) {
      evt.currentTarget.className += " active";
    } else {
      // Fallback if no event passed (manual trigger)
      document.getElementById('tab-' + tabName).className += " active";
    }

    // Update URL without reloading
    const url = new URL(window.location);
    if (tabName === 'reset-password') {
      url.searchParams.set('tab', 'password');
    } else {
      url.searchParams.delete('tab');
    }
    window.history.replaceState({}, '', url);
  }

  // Check URL parameters on load
  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');

    if (tab === 'password') {
      openTab(null, 'reset-password');
    }
    
    // Track changes for Update Profile button
    const profileForm = document.getElementById('profile-form');
    const updateBtn = document.getElementById('update-profile-btn');
    
    if (profileForm && updateBtn) {
      profileForm.addEventListener('input', function() {
        updateBtn.disabled = false;
      });
      
      // Also handle change for selects or other elements if necessary
      profileForm.addEventListener('change', function() {
        updateBtn.disabled = false;
      });

      profileForm.addEventListener('submit', function() {
        // Set a tiny timeout to ensure the form actually submits before disabling
        // This provides the "reset to initial state" feel before page reload
        setTimeout(() => {
          updateBtn.disabled = true;
        }, 50);
      });
    }
  });
</script>
{% endblock %}