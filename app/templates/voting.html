{% extends "base.html" %}
{% from "components/meeting_filter.html" import render_meeting_filter %}

{% block title %}Voting{% endblock %}

{% block content %}
<div class="booking-container">
	<div class="booking-filter-container">
		{{ render_meeting_filter(upcoming_meetings|sort(attribute=0, reverse=True), selected_meeting_number, label=None,
		base_url='/voting', render_outer_container=False) }}
	</div>

	{% if selected_meeting %}

	{% if selected_meeting.status == 'running' and not has_voted %}
	<div class="voting-instruction-alert">
		<span><i class="fas fa-info-circle"></i><strong> Select your winners!</strong>
			<p>Click a candidate to cast your vote for each category.</p>
		</span>
	</div>
	{% endif %}

	{# ============================================= #}
	{# ================ MACRO DEFINITIONS ================ #}
	{# ============================================= #}

	{# Macro to render a single role row in the table #}
	{% macro render_role_row(role, status, is_admin_view, selected_meeting_number, user_role, has_voted,
	can_track_progress,
	voting_disabled=False) %}
	<tr data-session-id="{{ role.session_id }}" data-role-key="{{ role.role_key }}"
		class="{% if role.award_type %}voted{% endif %}">
		<td class="role-cell">
			<div class="role-cell-content">
				<i class="fas {{ role.icon }}"></i>
				<div class="role-display-text">
					<span>{{ role.role }}</span>
					{% if role.speaker_name %}<span class="speaker-for">for {{ role.speaker_name }}</span>{% endif %}
				</div>
			</div>
		</td>
		{# Status cell: avatar and vote bricks #}
		<td class="status-cell">
			<div class="status-cell-content">
				<div class="role-avatar" {% if role.owner_name %}title="{{ role.owner_name }}" {% endif %}>
					{% if role.owner_avatar_url %}
					<img src="{{ url_for('static', filename=role.owner_avatar_url) }}" alt="User Avatar">
					{% else %}
					<i class="fas fa-user-circle"></i>
					{% endif %}
				</div>
				{% if is_admin_view and role.vote_count and role.vote_count > 0 and (can_track_progress or status ==
				'finished') %}
				<div class="vote-bricks-container" title="{{ role.vote_count }} Votes">
					{% for n in range(role.vote_count) %}
					<div class="vote-brick"></div>
					{% endfor %}
				</div>
				{% endif %}
			</div>
		</td>

		{# Name cell #}
		<td class="assign-cell">
			<div class="owner-display">{{ role.owner_name or 'Unassigned' }}</div>
		</td>

		{# Action Icons cell #}
		<td class="icon-cell">
			{% if status == 'running' %}
			{% set can_vote = role.owner_id and role.award_category and (role.award_category_open or role.award_type) %}

			{% if (role.owner_id and role.award_category) and can_vote %}
			{% if voting_disabled %}
			<button type="button" class="icon-btn" disabled style="color: #ccc; cursor: not-allowed;"
				title="Not enough candidates to vote">
				<i class="fas fa-vote-yea"></i>
			</button>
			{% else %}
			{% set should_show = role.award_type %}
			<button type="button"
				class="icon-btn {% if role.award_type %}icon-btn-voted{% endif %} {% if not should_show %}vote-auto-hide{% endif %}"
				title="Vote" {% if has_voted %}disabled style="cursor: default;" {% else
				%}onclick="handleVoteClick(this)" {% endif %} data-meeting-number="{{ selected_meeting_number }}"
				data-contact-id="{{ role.owner_id }}" data-award-category="{{ role.award_category }}">
				<i class="fas fa-vote-yea"></i>
			</button>
			{% endif %}
			{% endif %}
			{% elif status == 'finished' %}
			{% if role.award_type %}
			<span class="icon-btn icon-btn-voted" style="cursor: default;" title="{{ role.award_type }} Winner">
				<i class="fas fa-award"></i>&nbsp;
				<span class="winner-label">{{ role.award_type|replace('-', ' ')|title }}</span>
			</span>
			{% endif %}
			{% endif %}
		</td>
	</tr>
	{% endmacro %}

	{# Macro to render role tables with accordion #}
	{% macro render_role_tables(roles, sorted_role_groups, status, is_admin_view, selected_meeting_number, user_role,
	has_voted, can_track_progress) %}

	{% set use_accordion = (status in ['running']) or (status == 'finished' and is_admin_view) %}
	{% set default_open = False %}

	{% if use_accordion %}
	<div class="award-accordion">
		{% for category, items in sorted_role_groups %}
		{% if items and category and category != 'none' %}
		{% set category_voted = items|selectattr('award_type')|list|length > 0 %}
		{% set category_meta = {
		'speaker': {'num': 1, 'title': 'Best Speaker'},
		'evaluator': {'num': 2, 'title': 'Best Evaluator'},
		'role-taker': {'num': 3, 'title': 'Best Role Taker'},
		'table-topic': {'num': 4, 'title': 'Best Table Topic Speaker'}
		} %}
		{% set meta = category_meta.get(category, {'num': '', 'title': (category or 'Other')|replace('-', ' ')|title + '
		Roles'}) %}

		<div class="accordion-item" data-category="{{ category or 'other' }}">
			{% set voting_disabled = False %}
			{% set candidate_count = items | selectattr('owner_id') | list | length %}
			{% if category in ['speaker', 'evaluator'] and candidate_count < 3 %} {% set voting_disabled=True %} {% elif
				category=='table-topic' and candidate_count < 5 %} {% set voting_disabled=True %} {% endif %} <button
				class="accordion-header {{ 'active' if default_open else '' }} {{ 'voted' if category_voted else '' }} {{ 'disabled' if voting_disabled else '' }}"
				{% if voting_disabled %}disabled title="Not enough candidates to vote" {% endif %}>
				<div class="header-left" style="display: flex; align-items: center; gap: 15px;">
					{% if meta.num %}
					<div class="question-number">{{ meta.num }}</div>
					{% endif %}
					<span class="question-text">{{ meta.title }}</span>
				</div>
				<div class="accordion-header-right">
					{% if category_voted %}
					<span class="voted-label">
						<i class="fas fa-trophy"></i> VOTED
					</span>
					{% endif %}
					{% if voting_disabled %}
					<span style="font-size: 0.8em; color: #777; margin-right: 10px;">
						{% if category == 'table-topic' %}(Candidates < 5){% else %}(Candidates < 3){% endif %} </span>
							{% endif %}
							<i class="fas fa-chevron-down"></i>
				</div>
				</button>
				<div class="accordion-content" {% if default_open %}style="max-height: none;" {% endif %}>
					<table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">
						<tbody>
							{% for role in items %}
							{{ render_role_row(role, status, is_admin_view, selected_meeting_number, user_role,
							has_voted, can_track_progress, voting_disabled) }}
							{% endfor %} </tbody>
					</table>
				</div>
		</div>
		{% endif %}
		{% endfor %}
	</div>


	{% else %}
	{# Finished member view #}
	<table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">
		<tbody>
			{% set ns = namespace(displayed_awards=[]) %}
			{% for role in roles %}
			{% if role.award_type and role.award_type not in ns.displayed_awards %}
			{{ render_role_row(role, status, is_admin_view, selected_meeting_number, user_role, has_voted,
			can_track_progress) }}
			{% set ns.displayed_awards = ns.displayed_awards + [role.award_type] %}
			{% endif %}
			{% endfor %}
		</tbody>
	</table>
	{% endif %}
	{% endmacro %}


	{# ============================================= #}
	{# =============== MAIN VIEW LOGIC =============== #}
	{# ============================================= #}

	{% if selected_meeting.status not in ['running', 'finished'] %}
	<p style="font-family: 'Montserrat', sans-serif; font-size: 2em; text-align: center;">Meeting #{{
		selected_meeting_number }} is not yet started.</p>
	<div style="text-align: center; margin-top: 20px;">
		<img src="{{ url_for('static', filename='images/voting_open_soon.webp') }}" alt="Voting opens soon"
			style="max-width: 100%; height: auto; border: 5px solid #c5c5c5; border-radius: 15px;">
	</div>
	{% else %}
	{% if (has_voted and not can_track_progress and selected_meeting.status == 'running') or (selected_meeting.status ==
	'finished' and not is_admin_view) %}
	<div id="thank-you-message" style="text-align: center; margin-top: 40px; padding: 20px;">
		<i class="fas fa-check-circle" style="font-size: 4em; color: #28a745; margin-bottom: 20px;"></i>
		<h2>Thank You!</h2>
		<p>Your votes have been submitted.</p>
	</div>
	{% else %}
	{{ render_role_tables(roles, sorted_role_groups, selected_meeting.status, is_admin_view,
	selected_meeting_number, user_role, has_voted, can_track_progress) }}

	{% if selected_meeting.status == 'running' %}
	<div class="meeting-rating-section">
		<div class="rating-question" style="justify-content: flex-start; gap: 15px;">
			<div class="question-number">5</div>
			<div class="question-text">How likely are you to recommend this meeting to a friend or colleague?</div>
		</div>
		<div class="rating-scale">
			{% for i in range(11) %}
			<button type="button" class="rating-btn" data-score="{{ i }}" {% if has_voted %}disabled
				style="cursor: default;" {% else %}onclick="handleRatingClick(this)" {% endif %}>{{ i
				}}</button>
			{% endfor %}
		</div>
		<div class="rating-labels">
			<span>Not at all likely</span>
			<span>Extremely likely</span>
		</div>
	</div>

	<div class="feedback-section">
		<div class="feedback-question">
			<div class="question-number">6</div>
			<div class="question-text">Meeting Feedback / Comments</div>
		</div>
		<div class="feedback-input-container">
			<textarea id="feedback-input" class="feedback-input" placeholder="Enter your answer" rows="4" {% if
				has_voted %}disabled{% else %}oninput="handleFeedbackInput(this)" {% endif %}></textarea>
		</div>
	</div>
	{% endif %}
	{% endif %}

	{% if selected_meeting.status == 'running' and not has_voted %}
	<div id="batch-vote-actions" style="text-align: center; margin-top: 20px; padding-bottom: 30px;">
		<button id="done-voting-btn" class="btn btn-primary btn-lg" style="box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
			disabled>
			Submit
		</button>
	</div>
	<div id="thank-you-message" style="display: none; text-align: center; margin-top: 40px; padding: 20px;">
		<i class="fas fa-check-circle" style="font-size: 4em; color: #28a745; margin-bottom: 20px;"></i>
		<h2>Thank You!</h2>
		<p>Your votes have been submitted.</p>
	</div>
	{% endif %}
	{% endif %}
	{% else %}
	<p>Please select a meeting to view voting options.</p>
	{% endif %}

</div>

<script>
	// Pass Python data to global JS variables used by voting.js
	var isAdminView = {{ is_admin_view| tojson }};
	var selectedMeetingNumber = {{ selected_meeting_number| tojson }};
	var userRole = {{ user_role| tojson }};
	var canTrackProgress = {{ can_track_progress| tojson }};
	var initialMeetingRating = {{ meeting_rating_score| tojson }};
	var initialMeetingFeedback = {{ meeting_feedback_comment| tojson }};
</script>
<script src="{{ url_for('static', filename='js/voting.js') }}"></script>
{% endblock %}