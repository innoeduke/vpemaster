{% macro render_meeting_filter(meetings, selected_id, base_url='', label='', data_format='tuple',
extra_classes='', extra_style='', select_id='meeting-filter', is_disabled=False, render_outer_container=True, show_icon=True) %}

{% set ns = namespace(selected_text='', selected_value='') %}
{% for item in meetings %}
    {% if data_format == 'tuple' %}
        {% set val = item[0] %}
        {% set date = item[1] %}
        {% set status = item[2] if item|length > 2 else none %}
        {% set num = item[3] if item|length > 3 else item[0] %}
    {% else %}
        {% set val = item.id %}
        {% set num = item.Meeting_Number %}
        {% set date = item.Meeting_Date %}
        {% set status = item.status if item.status else none %}
    {% endif %}

    {% if selected_id and val|string == selected_id|string %}
        {% set ns.selected_value = val %}
        {% set status_icon = '' %}
        {% if status == 'unpublished' %}{% set status_icon = 'ğŸ”’' %}
        {% elif status == 'not started' %}{% set status_icon = 'â–¶ï¸' %}
        {% elif status == 'running' %}{% set status_icon = 'ğŸ”´' %}
        {% elif status == 'finished' %}{% set status_icon = 'âœ…' %}
        {% elif status == 'cancelled' %}{% set status_icon = 'ğŸš«' %}{% endif %}
        {% set ns.selected_text = '#' ~ num ~ ' - ' ~ (date.strftime('%B %d, %Y') if date else 'No Date') %}
    {% endif %}
{% endfor %}

{% if render_outer_container %}
<div class="{{ 'inline-filter-group' if label else 'booking-filter-container' }} {{ extra_classes }}"
    style="display: flex; align-items: center; gap: 0.5rem; {{ extra_style }}">
    {% endif %}
    
    <div class="filter-controls-inner">
        {% if label %}
        <label for="{{ select_id }}-search" class="filter-label">{{ label }}</label>
        {% endif %}

        <div class="meeting-autocomplete-container" id="{{ select_id }}-autocomplete-container">
            <button id="{{ select_id }}-prev" type="button" class="nav-btn nav-btn-left prev-meeting" title="Previous Meeting">
            <i class="fas fa-caret-left"></i>
            </button>
            <div class="search-input-wrapper">
                {% if show_icon %}
                <i class="fas fa-search search-icon"></i>
                {% endif %}
                <input type="text" id="{{ select_id }}-search" class="autocomplete-search-input" 
                       placeholder="Search meeting..." value="{{ ns.selected_text }}"
                       autocomplete="off" {% if is_disabled %}disabled{% endif %}>
                <i class="fas fa-caret-down dropdown-icon"></i>
            </div>
            
            <div id="{{ select_id }}-results" class="autocomplete-results-dropdown" style="display: none;">
                {% for item in meetings %}
                    {% if data_format == 'tuple' %}
                        {% set val = item[0] %}
                        {% set date = item[1] %}
                        {% set status = item[2] if item|length > 2 else none %}
                        {% set num = item[3] if item|length > 3 else item[0] %}
                    {% else %}
                        {% set val = item.id %}
                        {% set num = item.Meeting_Number %}
                        {% set date = item.Meeting_Date %}
                        {% set status = item.status if item.status else none %}
                    {% endif %}

                    {% set status_icon = '' %}
                    {% set status_label = '' %}
                    {% if status == 'unpublished' %}
                        {% set status_icon = 'ğŸ”’' %}{% set status_label = 'Unpublished' %}
                    {% elif status == 'not started' %}
                        {% set status_icon = 'â–¶ï¸' %}{% set status_label = 'Not Started' %}
                    {% elif status == 'running' %}
                        {% set status_icon = 'ğŸ”´' %}{% set status_label = 'Running' %}
                    {% elif status == 'finished' %}
                        {% set status_icon = 'âœ…' %}{% set status_label = 'Finished' %}
                    {% elif status == 'cancelled' %}
                        {% set status_icon = 'ğŸš«' %}{% set status_label = 'Cancelled' %}
                    {% endif %}
                    
                    {% set item_text = '#' ~ num ~ ' - ' ~ (date.strftime('%B %d, %Y') if date else 'No Date') %}
                    
                    <div class="autocomplete-result-item" data-value="{{ val }}" data-text="{{ item_text }}">
                        <span class="status-icon" title="{{ status_label }}">{{ status_icon }}</span>
                        <span class="meeting-num">#{{ num }}</span>
                        <span class="meeting-date">{{ date.strftime('%b %d, %Y') if date else 'No Date' }}</span>
                        {% if status_label %}
                        <span class="status-tag status-{{ status|replace(' ', '-') }}">{{ status_label }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            {# Hidden real select to maintain compatibility with existing JS #}
            <select id="{{ select_id }}" {% if base_url %}onchange="window.location.href = '{{ base_url }}/' + this.value;"
                {% endif %} style="display: none;" {% if is_disabled %}disabled{% endif %}>
                {% for item in meetings %}
                    {% if data_format == 'tuple' %}
                        {% set val = item[0] %}
                    {% else %}
                        {% set val = item.id %}
                    {% endif %}
                    <option value="{{ val }}" {% if ns.selected_value|string == val|string %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
            </select>
            <button id="{{ select_id }}-next" type="button" class="nav-btn nav-btn-right next-meeting" title="Next Meeting">
                <i class="fas fa-caret-right"></i>
            </button>
        </div>
    </div>

    {% if render_outer_container %}
</div>
{% endif %}

<script>
(function() {
    const container = document.getElementById('{{ select_id }}-autocomplete-container');
    const input = document.getElementById('{{ select_id }}-search');
    const results = document.getElementById('{{ select_id }}-results');
    const realSelect = document.getElementById('{{ select_id }}');
    const items = results.querySelectorAll('.autocomplete-result-item');
    const prevBtn = document.getElementById('{{ select_id }}-prev');
    const nextBtn = document.getElementById('{{ select_id }}-next');
    let highlightedIndex = -1;

    if (!input || !results || !realSelect) return;

    function showResults() {
        results.style.display = 'block';
        filterItems();
    }

    function hideResults() {
        setTimeout(() => {
            results.style.display = 'none';
        }, 200);
    }

    function filterItems() {
        const query = input.value.toLowerCase();
        let firstVisible = -1;
        let visibleCount = 0;
        items.forEach((item, index) => {
            const text = item.innerText.toLowerCase();
            if (text.includes(query)) {
                item.style.display = 'flex';
                visibleCount++;
                if (firstVisible === -1) firstVisible = index;
            } else {
                item.style.display = 'none';
            }
        });
        results.style.display = visibleCount > 0 ? 'block' : 'none';
        highlightedIndex = -1;
        updateHighlight();
    }

    function updateHighlight() {
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === highlightedIndex);
            if (index === highlightedIndex) {
                item.scrollIntoView({ block: 'nearest' });
            }
        });
    }

    function selectItem(item) {
        const value = item.dataset.value;
        const text = item.dataset.text;
        input.value = text;
        realSelect.value = value;
        
        // Trigger change event for any listeners
        realSelect.dispatchEvent(new Event('change'));
        
        hideResults();
        updateBtnState();
    }

    function updateBtnState() {
        if (prevBtn) prevBtn.disabled = realSelect.selectedIndex <= 0;
        if (nextBtn) nextBtn.disabled = realSelect.selectedIndex >= realSelect.options.length - 1;
        
        // Optional: Add visual opacity for disabled state
        if (prevBtn) prevBtn.style.opacity = prevBtn.disabled ? '0.3' : '1';
        if (nextBtn) nextBtn.style.opacity = nextBtn.disabled ? '0.3' : '1';
    }

    // Initialize button states
    updateBtnState();

    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            const currentIndex = realSelect.selectedIndex;
            if (currentIndex > 0) {
                const prevOption = realSelect.options[currentIndex - 1];
                const prevItem = results.querySelector(`.autocomplete-result-item[data-value="${prevOption.value}"]`);
                if (prevItem) selectItem(prevItem);
            }
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            const currentIndex = realSelect.selectedIndex;
            if (currentIndex < realSelect.options.length - 1) {
                const nextOption = realSelect.options[currentIndex + 1];
                const nextItem = results.querySelector(`.autocomplete-result-item[data-value="${nextOption.value}"]`);
                if (nextItem) selectItem(nextItem);
            }
        });
    }

    input.addEventListener('focus', showResults);
    input.addEventListener('click', () => {
        input.value = '';
        showResults();
    });
    input.addEventListener('input', showResults);
    input.addEventListener('blur', hideResults);

    input.addEventListener('keydown', (e) => {
        const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
        const currentIndex = visibleItems.indexOf(items[highlightedIndex]);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (results.style.display === 'none') {
                showResults();
            } else {
                let nextIndex = currentIndex + 1;
                if (nextIndex >= visibleItems.length) nextIndex = 0;
                const nextItem = visibleItems[nextIndex];
                highlightedIndex = Array.from(items).indexOf(nextItem);
                updateHighlight();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            let nextIndex = currentIndex - 1;
            if (nextIndex < 0) nextIndex = visibleItems.length - 1;
            const nextItem = visibleItems[nextIndex];
            highlightedIndex = Array.from(items).indexOf(nextItem);
            updateHighlight();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex >= 0) {
                selectItem(items[highlightedIndex]);
            } else if (visibleItems.length > 0) {
                selectItem(visibleItems[0]);
            }
        } else if (e.key === 'Escape') {
            hideResults();
        }
    });

    items.forEach(item => {
        item.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent blur
            selectItem(item);
        });
    });

    // Toggle dropdown on icon click
    const dropdownIcon = container.querySelector('.dropdown-icon');
    if (dropdownIcon) {
        dropdownIcon.addEventListener('click', () => {
            if (results.style.display === 'none') {
                input.focus();
            } else {
                results.style.display = 'none';
            }
        });
    }
})();
</script>
{% endmacro %}