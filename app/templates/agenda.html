{% extends "base.html" %}
{% from "components/meeting_filter.html" import render_meeting_filter %}

{% block title %}Meeting Agenda{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/agenda/agenda-view-owners.css') }}">
{% endblock %}


{% block content %}
<div id="agenda-content"> {# Wrapper for edit-mode class #}
    <div class="agenda-header-container">
        <div class="agenda-header-logo">
            {% if club and club.logo_url %}
            <img src="{{ url_for('static', filename=club.logo_url) }}" alt="{{ club.club_name }} Logo">
            {% else %}
            <img src="{{ url_for('static', filename='images/SHLTMC-logo.webp') }}" alt="Default Club Logo">
            {% endif %}
        </div>

        <div class="agenda-header-info">
            <p class="club-info">
                {% if club %}
                Club No.{{ club.club_no }} | Area {{ club.area or '?' }} | Division {{ club.division or '?' }} | {{
                club.club_name }}
                {% else %}
                Club No.868941 | Area K1 | Division K | Shanghai Leadership Toastmasters Club
                {% endif %}
            </p>
            <h1 class="meeting-title view-mode">
                {% if selected_meeting.type %}
                <span class="meeting-type-badge">{{ selected_meeting.type }}</span>
                {% endif %}
                {% if selected_meeting and selected_meeting.media and selected_meeting.media.url and current_user.has_permission('MEDIA_ACCESS') %}
                <a href="{{ selected_meeting.media.url }}" target="_blank">
                    {{ selected_meeting.Meeting_Title or ('Meeting ' ~ selected_meeting.Meeting_Number) }}
                </a>
                {% else %}
                {{ selected_meeting.Meeting_Title or ('Meeting ' ~ selected_meeting.Meeting_Number) }}
                {% endif %}
            </h1>
                {% if selected_meeting.Subtitle %}
                <p class="subtitle view-mode">
                    {{ selected_meeting.Subtitle }}
                </p>
                {% endif %}
        </div>
    </div>

    {% if selected_meeting and selected_meeting.WOD %}
    <div class="wod-display">
        <div class="envelope-flap"></div>
        <div class="letter">
            <span style="font-weight: 600; font-size: 0.7em; color:#555;">Word of the Day:</span>
            <span>"{{ selected_meeting.WOD }}"</span>
        </div>
    </div>
    {% endif %}

    {# This is the updated warning block for the full-screen overlay #}
    <div class="orientation-warning">
        <i class="fas fa-mobile-alt warning-icon"></i>
        <h2>Please Rotate Your Device</h2>
        <p>For the best experience, please rotate your device to landscape mode to edit the agenda.</p>
    </div>

    <br />
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="action-bar-left-content" style="display: flex; flex-direction: column; gap: 5px;">
                {% if selected_meeting and selected_meeting.manager %}
                <div class="meeting-manager-display" style="color: #555;">
                    Manager: {{ selected_meeting.manager.Name }}
                </div>
                {% endif %}
                {% if meeting_numbers %}
                {{ render_meeting_filter(meeting_numbers|sort(reverse=True), selected_meeting.Meeting_Number if
                selected_meeting else none, is_disabled=is_editing) }}
                {% endif %}
            </div>
        </div>
        <div class="action-bar-right">
            <div id="view-mode-buttons">
                {% if selected_meeting and is_authorized(Permissions.AGENDA_EDIT, meeting=selected_meeting) %}
                <div class="button-group status-group">
                    {% if selected_meeting.status %}
                    <span class="meeting-status-display status-{{ selected_meeting.status|replace(' ', '-') }}"
                        title="Meeting Status: {{ selected_meeting.status.replace('_', ' ').title() }}">
                        <i
                            class="fas fa-fw {% if selected_meeting.status == 'unpublished' %}fa-eye-slash{% elif selected_meeting.status == 'not started' %}fa-play-circle{% elif selected_meeting.status == 'running' %}fa-broadcast-tower{% elif selected_meeting.status == 'finished' %}fa-check-circle{% elif selected_meeting.status == 'cancelled' %}fa-ban{% endif %}"></i>{{
                        selected_meeting.status.replace('_', ' ').title() }}
                    </span>
                    {% endif %}
                    <button id="meeting-status-btn"
                        class="btn {% if selected_meeting.status in ['finished','cancelled'] %}btn-secondary{% elif selected_meeting.status == 'unpublished' %}btn-success{% else %}btn-primary{% endif %}"
                        data-meeting-number="{{ selected_meeting.Meeting_Number }}"
                        data-current-status="{{ selected_meeting.status }}" {% if selected_meeting.status=='cancelled'
                        %}disabled{% endif %}>
                        {% if selected_meeting.status == 'unpublished' %}
                        Publish
                        {% elif selected_meeting.status == 'not started' %}
                        Start
                        {% elif selected_meeting.status == 'running' %}
                        Stop
                        {% elif selected_meeting.status == 'finished' %}
                        Delete
                        {% elif selected_meeting.status == 'cancelled' %}
                        Cancelled
                        {% else %}
                        {{ selected_meeting.status.replace('_', ' ').title() }}
                        {% endif %}
                    </button>
                </div>
                {% endif %}

                <div class="button-group action-group">
                    {% if is_authorized(Permissions.AGENDA_EDIT) %}
                    <button id="create-btn" class="btn btn-success">New</button>
                    {% endif %}

                    {% if selected_meeting and is_authorized(Permissions.AGENDA_EDIT, meeting=selected_meeting) %}
                    <button id="edit-btn" class="btn btn-primary">Edit</button>
                    <button id="export-btn" class="btn btn-info action-icon-btn" title="Export to Excel"><i class="fas fa-file-excel"></i></button>
                    <button id="ppt-btn" class="btn btn-warning action-icon-btn" title="Download PPT"><i class="fas fa-file-powerpoint"></i></button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Edit Mode Buttons (Only visible if authorized) #}
    {% if is_authorized(Permissions.AGENDA_EDIT, meeting=selected_meeting) %}
    <div class="button-group" id="edit-mode-buttons" style="display: none;">
        <button id="cancel-edit-btn" class="btn btn-danger">Cancel</button>
        <button id="view-details-btn" class="btn btn-success">View Details</button>
        <button id="add-row-btn" class="btn btn-info">Add Section</button>
        <button id="edit-logs-btn" class="btn btn-success">Save</button>
    </div>
    {% endif %}

    <div class='table-container' id="table-container" data-project-speakers='{{ project_speakers|tojson|safe }}'>
        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th class="col-view-duration-header"><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th class="col-no">No</th>
                    <th class="col-start-time">Start Time</th>
                    <th class="col-session-type">Session Type</th>
                    <th class="col-session-title">Session Title</th>
                    <th class="col-owner">Owner</th>
                    <th class="col-duration-min">Min</th>
                    <th class="col-duration-max">Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            {% set ns = namespace(displayed_awards=[]) %}
            <tbody>
                {% for log_dict in logs_data %}
                <tr data-id="{{ log_dict.id }}"
                    data-project-id="{{ log_dict.Project_ID if log_dict.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log_dict.Meeting_Number }}"
                    data-meeting-date="{{ log_dict.meeting_date_str }}"
                    data-is-section="{{ log_dict.is_section|lower }}" data-is-hidden="{{ log_dict.is_hidden|lower }}"
                    data-is-readonly="{{ log_dict.is_readonly|default(false)|lower }}"
                    data-meeting-seq="{{ log_dict.Meeting_Seq }}" data-start-time="{{ log_dict.Start_Time_str }}" {# Use
                    predefined title if available, otherwise fallback to log title #}
                    data-session-title="{{ log_dict.Session_Title if log_dict.Session_Title is not none else '' }}"
                    data-type-id="{{ log_dict.Type_ID }}" data-owner-id="{{ log_dict.owners_data[0].id if log_dict.owners_data else '' }}"
                    data-credentials="{{ log_dict.Credentials if log_dict.Credentials is not none else '' }}"
                    data-duration-min="{{ log_dict.Duration_Min if log_dict.Duration_Min is not none else '' }}"
                    data-duration-max="{{ log_dict.Duration_Max if log_dict.Duration_Max is not none else '' }}"
                    data-status="{{ log_dict.status if log_dict.status else '' }}" data-role="{{ log_dict.role or '' }}"
                    data-project-code="{{ log_dict.project_code or '' }}" data-pathway="{{ log_dict.pathway or '' }}"
                    data-owner-ids='{{ log_dict.owner_ids|tojson|safe }}'
                    class="{{ 'section-row' if log_dict.is_section else '' }} {{ 'hidden-row' if log_dict.is_hidden else '' }} {{ 'readonly-row' if log_dict.is_readonly|default(false) else '' }}">

                    {# --- Row Content using log_dict --- #}
                    {% if log_dict.is_section %}
                    <td colspan="4" class="non-edit-mode-cell">
                        {{ log_dict.Session_Title or log_dict.session_type_title }}
                    </td>
                    {% else %}
                    <td class="non-edit-mode-cell">{{ log_dict.Start_Time_str }}</td>
                    <td class="non-edit-mode-cell col-session">
                        <div class="speech-tooltip-wrapper">
                            {% set cleaned_title = log_dict.Session_Title|replace('"', '') if log_dict.Session_Title
                            else '' %}

                            {# Display Title #}
                            {% if log_dict.session_type_title == 'Evaluation' %}
                            {% set display_title = 'Evaluator for ' ~ cleaned_title %}
                            {% elif log_dict.session_type_title in ['Pathway Speech', 'Presentation'] or
                            log_dict.Project_ID %}
                            {% set display_title = '"' ~ cleaned_title ~ '"' %}
                            {% else %}
                            {% set display_title = cleaned_title %}
                            {% endif %}

                            {% if log_dict.media_url and current_user.has_permission('MEDIA_ACCESS') %}
                            <a href="{{ log_dict.media_url }}" target="_blank" title="Watch Media">
                                {{ display_title }}
                            </a>
                            {% else %}
                            {{ display_title }}
                            {% endif %}

                            {% if log_dict.session_type_title == 'Evaluation' and log_dict.speaker_is_dtm %}
                            <sup class="dtm-superscript">DTM</sup>
                            {% endif %}
                            {# Append Project Code if it's a project #}
                            {% if log_dict.project_code_display %}
                            {% if log_dict.Project_ID and log_dict.pathway_code %}
                            <a href="{{ url_for('pathways_bp.pathway_library') }}?path={{ log_dict.pathway_code }}&level={{ log_dict.level }}&project_id={{ log_dict.Project_ID }}"
                                class="project-code-link" title="View in Pathway Library">
                                ({{ log_dict.project_code_display }})
                            </a>
                            {% else %}
                            <span class="project-code-link" title="Project Code">
                                ({{ log_dict.project_code_display }})
                            </span>
                            {% endif %}
                            {% endif %}

                            {# Tooltip for Projects #}
                            {% if log_dict.Project_ID %}
                            <div class="speech-tooltip">
                                <span class="tooltip-title">{{ log_dict.project_name }}</span>
                                <span class="tooltip-purpose">{{ log_dict.project_purpose }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="non-edit-mode-cell col-owner">
                        {# Use pre-fetched owner data from log_dict #}
                        {% for owner_info in log_dict.owners_data %}
                        <div class="owner-row">
                            <span class="owner-name">{{ owner_info.name }}</span>
                            
                            {% if owner_info.credentials == "DTM" %}
                            <sup class="dtm-superscript">DTM</sup>
                            {% endif %}

                            {# Show credentials if not DTM #}
                            {% if owner_info.credentials and owner_info.credentials != "DTM" %}
                            <span class="owner-meta"> - {{ owner_info.credentials }}</span>
                            {% endif %}

                            {# Show trophy for award winners #}
                            {% if loop.first and log_dict.award_type and log_dict.role not in ns.displayed_awards %}
                            <span class="award-badge" title="{{ log_dict.award_type }} Winner" style="margin-left: 4px;">
                                <i class="fas fa-award"></i>
                            </span>
                            {% set ns.displayed_awards = ns.displayed_awards + [log_dict.role] %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </td>
                    <td class="non-edit-mode-cell col-view-duration">
                        {% if log_dict.Duration_Min and log_dict.Duration_Max %}{{ log_dict.Duration_Min }}'-{{
                        log_dict.Duration_Max }}'
                        {% elif log_dict.Duration_Max %}{{ log_dict.Duration_Max }}'
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pathways Info (Dismissible) - Moved down here #}
    <div id="pathways-info-box" class="dismissible-info" style="display: none;">
        <span class="close-info" onclick="dismissAgendaMessage('pathways-info-box')">&times;</span>
        <p><a href="https://www.toastmasters.org/education/education-programs-faq#faqTop" target="_blank">Pathways
                award credentials</a> are written as follows:</p>
        <ul>
            <li>Only the most recently achieved award will show</li>
            <li>Any Pathways award credential overwrites a traditional education program award credential</li>
            <li>DTM overwrites all education award credentials</li>
        </ul>
    </div>

    {# Real Footnote: Club Address & Website #}
    {% if club %}
    <div class="footnote">
        {% if club.club_address %}
        <p style="white-space: pre-line;">{{ club.club_address }}</p>
        {% endif %}
        {% if club.website %}
        <p><a href="{{ 'https://' ~ club.website if '://' not in club.website else club.website }}" target="_blank"
                class="footnote-website">{{ club.website }}</a></p>
        {% endif %}
    </div>
    {% endif %}

    <div id="createAgendaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateAgendaModal()">&times;</span>
            <h1>Create New Agenda</h1>
            <form id="create-meeting-form">
                <table class="form-table">
                    <tr>
                        <td><label for="meeting_number">Meeting Number:</label></td>
                        <td><input type="number" id="meeting_number" name="meeting_number" value="{{ next_meeting_num }}" autocomplete="off" required>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="meeting_title">Meeting Title:</label></td>
                        <td><input type="text" id="meeting_title" name="meeting_title" autocomplete="off"></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_date">Meeting Date:</label></td>
                        <td><input type="date" id="meeting_date" name="meeting_date" value="{{ next_meeting_date }}" autocomplete="off" required>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="start_time">Start Time:</label></td>
                        <td><input type="time" id="start_time" name="start_time" value="{{ default_start_time }}"
                                autocomplete="off" required></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_type">Meeting Type:</label></td>
                        <td>
                            <select id="meeting_type" name="meeting_type" autocomplete="off" required>
                                {% for type_name in meeting_types.keys() %}
                                <option value="{{ type_name }}" {% if type_name=='Keynote Speech' %}selected{% endif %}>
                                    {{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="ge_mode">GE Style:</label></td>
                        <td>
                            <select id="ge_mode" name="ge_mode" autocomplete="off" required>
                                <option value="1">Distributed (1ms+3m)</option>
                                <option value="0" selected>Traditional (5m)</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Meeting</button>
                    <button type="button" class="btn btn-danger" onclick="closeCreateAgendaModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% include '_speech_edit_modal.html' %}
    {% include '_contact_modal.html' %}
    {% include '_duplicate_modal.html' %}
    {% include 'role_modal.html' %}
    {% include '_meeting_details_modal.html' %}

    <script>
        // Pass Python data to global JS variables used by speech_modal.js
        var allProjects = {{ projects | tojson | safe }};
        var pathways = {{ pathways | tojson | safe }};
        var pathwayMap = {{ pathway_mapping | tojson | safe }};
        var groupedPathways = {{ pathways | tojson | safe }};
        var ProjectID = {{ ProjectID | tojson | safe }};
    </script>
    <script src="{{ url_for('static', filename='js/speech_modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
    <script>
        function dismissAgendaMessage(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.style.display = 'none';
                localStorage.setItem('dismissed_' + elementId, 'true');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const pathwaysBox = document.getElementById('pathways-info-box');
            if (pathwaysBox && !localStorage.getItem('dismissed_pathways-info-box')) {
                pathwaysBox.style.display = 'block';
            }
        });
    </script>
    <div id="custom-modal" class="custom-modal">
        <div class="custom-modal-content">
            <div id="custom-modal-icon" class="custom-modal-icon"></div>
            <div id="custom-modal-title" class="custom-modal-title"></div>
            <div id="custom-modal-message" class="custom-modal-message"></div>
            <div id="custom-modal-actions" class="custom-modal-actions">
                <button id="custom-modal-cancel" class="custom-modal-btn btn-cancel" style="display: none;">Cancel</button>
                <button id="custom-modal-ok" class="custom-modal-btn btn-confirm">OK</button>
            </div>
        </div>
    </div>
</div> {# End of #agenda-content wrapper #}
{% endblock %}