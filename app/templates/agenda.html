{% extends "base.html" %}

{% block title %}Meeting Agenda{% endblock %}

{% block content %}
<div id="agenda-content"> {# Wrapper for edit-mode class #}
    <div class="agenda-header-container">
        <div class="agenda-header-logo">
            <img src="{{ url_for('static', filename='images/SHLTMC-logo.png') }}" alt="SHLTMC Logo">
        </div>
        
        <div class="agenda-header-info">
            <p class="club-info">Club No.868941 | Area K1 | Division K | Shanghai Leadership Toastmasters Club</p>
            <h1 class="meeting-title view-mode">
                {% if selected_meeting.type %}
                    <span class="meeting-type-badge">{{ selected_meeting.type }}</span>
                {% endif %}
                {% if selected_meeting and selected_meeting.media and selected_meeting.media.url %}
                    <a href="{{ selected_meeting.media.url }}" target="_blank">
                        {{ selected_meeting.Meeting_Title or ('Meeting ' ~ selected_meeting.Meeting_Number) }}
                    </a>
                {% else %}
                    {{ selected_meeting.Meeting_Title or ('Meeting ' ~ selected_meeting.Meeting_Number) }}
                {% endif %}
            </h1>
            <p class="subtitle view-mode">
                {% if selected_meeting.Subtitle %}
                    {{ selected_meeting.Subtitle }}
                {% endif %}
            </p>
            <!-- Removed video meeting button -->
            <div class="meeting-edit-details">
                <div class="meta-item">
                    <span><strong>Meeting Title:</strong></span>
                    <input type="text" 
                           id="edit-meeting-title" 
                           class="edit-mode-field" 
                           value="{{ selected_meeting.Meeting_Title or '' }}" 
                           placeholder="Enter Meeting Title (Theme)">
                </div>
                <div class="meta-item">
                    <span><strong>Sub-Title:</strong></span>
                    <input type="text" 
                           id="edit-subtitle" 
                           class="edit-mode-field" 
                           value="{{ selected_meeting.Subtitle or '' }}" 
                           placeholder="Enter Meeting Sub-Title">
                </div> 
                <div class="meta-item">
                    <span><strong>Meeting Type:</strong></span>
                    <select id="edit-meeting-type" class="edit-mode-field">
                        <option value="" {% if not selected_meeting.type %}selected{% endif %}>-- Select Type --</option>
                        {% for type in meeting_types.keys() %} 
                        <option value="{{ type }}" {% if selected_meeting.type == type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="meta-item">
                    <span><strong>Word of the Day:</strong></span>
                    <input type="text" 
                           id="edit-wod" 
                           class="edit-mode-field" 
                           value="{{ selected_meeting.WOD or '' }}" 
                           placeholder="Enter Word of the Day">
                </div>
                <div class="meta-item">
                    <span><strong>Media URL:</strong></span>
                    <input type="url" 
                           id="edit-media-url" 
                           class="edit-mode-field" 
                           value="{{ selected_meeting.media.url if selected_meeting and selected_meeting.media else '' }}" 
                           placeholder="Enter Meeting Video URL (https://...)">
                </div>
            </div>
        </div>
    </div>

    {# This is the updated warning block for the full-screen overlay #}
    <div class="orientation-warning">
        <i class="fas fa-mobile-alt warning-icon"></i>
        <h2>Please Rotate Your Device</h2>
        <p>For the best experience, please rotate your device to landscape mode to edit the agenda.</p>
    </div>

    <br/>
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="inline-filter-group">
                
                <label for="meeting-filter">Meeting#:</label>
                <select id="meeting-filter" {% if is_editing %}disabled{% endif %}>
                    {% for num in meeting_numbers|sort(reverse=True) %}
                    <option value="{{ num }}" {% if selected_meeting and num == selected_meeting.Meeting_Number %}selected{% endif %}>{{ num }}</option>
                    {% endfor %}
                </select>
                {% if selected_meeting %}
                    <span id="meeting-date-display">{{ selected_meeting.Meeting_Date.strftime('%B %d, %Y') }}</span>
                {% endif %}
            </div>
            
            {% if selected_meeting and selected_meeting.WOD %}
            <div class="wod-display">
                <div class="envelope-flap"></div>
                <div class="letter">
                    <label>Word of the Day:</label>
                    <span>"{{ selected_meeting.WOD }}"</span>
                </div>
            </div>
            {% endif %}
            
            <div id="ge-style-toggle" class="inline-filter-group" style="display: none;">
                <label for="ge-style-select">GE Style:</label>
                <select id="ge-style-select" data-current-style="{{ selected_meeting.GE_Style if selected_meeting else '' }}">
                    <option value="One shot" {% if selected_meeting and selected_meeting.GE_Style == 'One shot' %}selected{% endif %}>One shot</option>
                    <option value="Multiple shots" {% if selected_meeting and selected_meeting.GE_Style == 'Multiple shots' %}selected{% endif %}>Multiple shots</option>
                </select>
            </div>
        </div>
        <div class="action-bar-right">
            <div class="button-group" id="view-mode-buttons">
            {% if is_authorized(session.get('user_role'), 'AGENDA_EDIT') %}
            <button id="create-btn" class="btn btn-success">New</button>
            {% endif %}
            {% if session.logged_in %}
            <button id="export-btn" class="btn btn-info">Export</button>
            {% endif %}
            {% if is_authorized(session.get('user_role'), 'AGENDA_EDIT') %}
            <button id="edit-btn" class="btn btn-primary">Edit</button>
            {% endif %}
            </div>
        </div>
    </div>
    
    {% if is_authorized(session.get('user_role'), 'AGENDA_EDIT') %}
    <div class="button-group" id="edit-mode-buttons" style="display: none;">
        <button id="cancel-edit-btn" class="btn btn-danger">Cancel</button>
        <button id="add-row-btn" class="btn btn-info">Add</button>
        <button id="edit-logs-btn" class="btn btn-primary">Save</button>
    </div>
    {% endif %}

    <div class='table-container'
         id="table-container"
         {# Removed data-session-types, data-contacts, data-projects as they are now fetched via API #}
         data-project-speakers='{{ project_speakers|tojson|safe }}'>

        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th class="col-no">No</th>
                    <th class="col-start-time">Start Time</th>
                    <th class="col-session-type">Session Type</th>
                    <th class="col-session-title">Session Title</th>
                    <th class="col-owner">Owner</th>
                    <th class="col-designation">Designation</th>
                    <th class="col-duration-min">Min</th>
                    <th class="col-duration-max">Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log_dict in logs_data %}
                <tr data-id="{{ log_dict.id }}"
                    data-project-id="{{ log_dict.Project_ID if log_dict.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log_dict.Meeting_Number }}"
                    data-meeting-date="{{ log_dict.meeting_date_str }}"
                    data-is-section="{{ log_dict.is_section|lower }}"
                    data-is-hidden="{{ log_dict.is_hidden|lower }}"
                    data-meeting-seq="{{ log_dict.Meeting_Seq }}"
                    data-start-time="{{ log_dict.Start_Time_str }}"
                    {# Use predefined title if available, otherwise fallback to log title #}
                    data-session-title="{{ log_dict.Session_Title if log_dict.Session_Title is not none else '' }}"
                    data-type-id="{{ log_dict.Type_ID }}"
                    data-owner-id="{{ log_dict.Owner_ID }}"
                    data-designation="{{ log_dict.Designation if log_dict.Designation is not none else '' }}"
                    data-duration-min="{{ log_dict.Duration_Min if log_dict.Duration_Min is not none else '' }}"
                    data-duration-max="{{ log_dict.Duration_Max if log_dict.Duration_Max is not none else '' }}"
                    data-status="{{ log_dict.Status if log_dict.Status else '' }}"
                    data-role="{{ log_dict.role or '' }}"
                    data-current-path-level="{{ log_dict.current_path_level or '' }}"
                    class="{{ 'section-row' if log_dict.is_section else '' }} {{ 'hidden-row' if log_dict.is_hidden else '' }}">

                    {# --- Row Content using log_dict --- #}
                    {% if log_dict.is_section %}
                        <td colspan="4" class="non-edit-mode-cell">
                            {# Display section title #}
                            {{ log_dict.Session_Title or log_dict.session_type_title }}
                        </td>
                    {% else %}
                        <td class="non-edit-mode-cell">{{ log_dict.Start_Time_str }}</td>
                        <td class="non-edit-mode-cell">
                            <div class="speech-tooltip-wrapper">
                               {% set cleaned_title = log_dict.Session_Title|replace('"', '') if log_dict.Session_Title else '' %}

                               {# Display Title #}
                               {% if log_dict.session_type_title == 'Evaluation' %}
                                   {% set display_title = 'Evaluation for ' ~ cleaned_title %}
                               {% elif log_dict.session_type_title in ['Pathway Speech', 'Presentation'] or log_dict.Project_ID %}
                                   {% set display_title = '"' ~ cleaned_title ~ '"' %}
                               {% elif log_dict.predefined %}
                                   {% set display_title = log_dict.session_type_title %}
                               {% else %}
                                   {% set display_title = cleaned_title %}
                               {% endif %}
                               
                               {% if log_dict.media_url %}
                                   <a href="{{ log_dict.media_url }}" target="_blank" title="Watch Media">
                                       {{ display_title }}
                                   </a>
                               {% else %}
                                   {{ display_title }}
                               {% endif %}
                               
                               {% if log_dict.session_type_title == 'Evaluation' and log_dict.speaker_is_dtm %}
                                   <sup class="dtm-superscript">DTM</sup>
                               {% endif %}
                               {# Append Project Code if it's a project #}
                               {% if log_dict.project_code_display %}
                                   {% if log_dict.Project_ID and log_dict.pathway_code %}
                                       <a href="{{ url_for('pathways_bp.pathway_library') }}?path={{ log_dict.pathway_code }}&level={{ log_dict.level }}&project_id={{ log_dict.Project_ID }}" class="project-code-link" title="View in Pathway Library">
                                           ({{ log_dict.project_code_display }})
                                       </a>
                                   {% else %}
                                       <span class="project-code-link" title="Project Code">
                                           ({{ log_dict.project_code_display }})
                                       </span>
                                   {% endif %}
                               {% endif %}

                               {# Tooltip for Projects #}
                               {% if log_dict.Project_ID %}
                               <div class="speech-tooltip">
                                   <span class="tooltip-title">{{ log_dict.project_name }}</span>
                                   <span class="tooltip-purpose">{{ log_dict.project_purpose }}</span>
                               </div>
                               {% endif %}
                            </div>
                        </td>
                        <td class="non-edit-mode-cell">
                             {# Use pre-fetched owner data from log_dict #}
                            {% if log_dict.owner_name %}
                                {{ log_dict.owner_name }}
                                {% if log_dict.owner_dtm %}
                                    <sup class="dtm-superscript">DTM</sup>
                                {% endif %}
                                {# Show trophy for award winners #}
                                {% if log_dict.award_type %}
                                    <span class="icon-btn icon-btn-voted" title="{{ log_dict.award_type }} Winner">
                                        <i class="fas fa-award"></i>
                                    </span>
                                {% endif %}
                                <span class="owner-meta">
                                    {% if log_dict.owner_type == 'Guest' %}
                                        <br/>{{ log_dict.Designation }} {# Use designation directly #}
                                    {% elif log_dict.Designation and not log_dict.owner_dtm %}
                                        <br/>{{ log_dict.Designation }}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% if log_dict.Duration_Min and log_dict.Duration_Max %}{{ log_dict.Duration_Min }}'-{{ log_dict.Duration_Max }}'
                            {% elif log_dict.Duration_Max %}{{ log_dict.Duration_Max }}'
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="createAgendaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateAgendaModal()">&times;</span>
            <h1>Create New Agenda</h1>
            <form action="{{ url_for('agenda_bp.create_from_template') }}" method="POST">
                <table class="form-table">
                    <tr>
                        <td><label for="meeting_number">Meeting Number:</label></td>
                        <td><input type="number" id="meeting_number" name="meeting_number" required></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_title">Meeting Title:</label></td>
                        <td><input type="text" id="meeting_title" name="meeting_title"></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_date">Meeting Date:</label></td>
                        <td><input type="date" id="meeting_date" name="meeting_date" required></td>
                    </tr>
                    <tr>
                        <td><label for="start_time">Start Time:</label></td>
                        <td><input type="time" id="start_time" name="start_time" value="{{ default_start_time }}" required></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_type">Meeting Type:</label></td>
                        <td>
                            <select id="meeting_type" name="meeting_type" required>
                                {% for type_name in meeting_types.keys() %}
                                    <option value="{{ type_name }}" {% if type_name == 'Keynote Speech' %}selected{% endif %}>{{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="ge_style">GE Style:</label></td>
                        <td>
                            <select id="ge_style" name="ge_style" required>
                                <option value="Multiple shots">Multiple shots</option>
                                <option value="One shot" selected>One shot</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Meeting</button>
                    <button type="button" class="btn btn-danger" onclick="closeCreateAgendaModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% include '_speech_edit_modal.html' %}
    {% include '_contact_modal.html' %}
    {% include 'role_modal.html' %}

    <script>
        // Pass Python data to global JS variables used by speech_modal.js
        var pathwayMap = {{ pathway_mapping|tojson|safe }};
    
    </script>
    <script src="{{ url_for('static', filename='js/speech_modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
</div> {# End of #agenda-content wrapper #}
{% endblock %}