{% extends "base.html" %}
{% from "components/meeting_filter.html" import render_meeting_filter %}

{% block title %}Role Booking{% endblock %}

{% block content %}
<div class="booking-container">
    <h1><i class="fas fa-tag"></i> Booking Assistant</h1>
    {% if user_role != 'Guest' %}
    <h3 class="booking-section-header">My Upcoming Roles</h3>
    <div class="my-bookings-container">
        {% if user_bookings_by_date %}
        <div class="horizontal-timeline">
            {% for group in user_bookings_by_date %}
            <div class="timeline-event" data-meeting-number="{{ group.date_info.meeting_number }}">
                <div class="timeline-header">
                    <span class="meeting-number">#{{ group.date_info.meeting_number }}</span>
                    <span class="meeting-date">{{ group.date_info.short_date }}</span>
                </div>
                <div class="timeline-marker"></div>
                <div class="timeline-roles-list">
                    {% for booking in group.bookings %}
                    <div class="timeline-role">
                        <i class="fas {{ booking.icon }}"></i> {{ booking.role }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>You have no upcoming roles booked.</p>
        {% endif %}
    </div>
    <h3 class="booking-section-header">Booking Roles</h3>
    {% endif %}
    <div class="booking-filter-container">
        {{ render_meeting_filter(upcoming_meetings|sort(attribute=0, reverse=True), selected_meeting_number, label=None,
        render_outer_container=False) }}
        <div class="filter-right">
            {#
            {% if is_admin_view %}
            <button class="btn btn-primary" onclick="syncTally()">
                <i class="fas fa-sync"></i> Sync to Tally
            </button>
            {% endif %}
            #}
            <a href="{{ url_for('static', filename='files/club-meeting-roles-resource-library.pdf') }}" target="_blank"
                class="btn btn-info role-guide-link">
                <i class="fas fa-book-open"></i> View Role Guide
            </a>
        </div>
    </div>

    {% if selected_meeting %}

    {# ============================================= #}
    {# ================ MACRO DEFINITIONS ================ #}
    {# ============================================= #}

    {# Macro to render a single role row in the table #}
    {% macro render_role_row(role, status, is_admin_view, contacts, current_user_contact_id) %}
    <tr data-session-id="{{ role.session_id }}" data-role-key="{{ role.role_key }}">
        <td class="role-cell">
            <div class="role-cell-content">
                <i class="fas {{ role.icon }}"></i>
                <div class="role-display-text">
                    <span>{{ role.role }}</span>
                    {% if role.speaker_name %}<span class="speaker-for">for {{ role.speaker_name }}</span>{% endif %}
                </div>
            </div>
        </td>
        {# Status cell: waitlist #}
        <td class="status-cell">
            <div class="status-cell-content">
                <div class="role-avatar" {% if role.owner_name %}title="{{ role.owner_name }}" {% endif %}>
                    {% if role.owner_avatar_url %}
                    <img src="{{ url_for('static', filename=role.owner_avatar_url) }}" alt="User Avatar">
                    {% else %}
                    <i class="fas fa-user-circle"></i>
                    {% endif %}
                </div>
                {% if status in ['not started', 'unpublished'] and role.waitlist %}
                {% for user in role.waitlist %}
                <div class="role-avatar waitlist-avatar" title="{{ user.name }} (Waitlist)">
                    {% if user.avatar_url %}
                    <img src="{{ url_for('static', filename=user.avatar_url) }}" alt="{{ user.name }}">
                    {% else %}
                    <i class="fas fa-user-circle"></i>
                    {% endif %}
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </td>

        {# Assign/Action cell #}
        <td class="assign-cell">
            {% if status in ['not started', 'unpublished'] or is_admin_view %}
            {% if is_admin_view %}
            <div class="autocomplete-container" data-session-id="{{ role.session_id }}" data-role-key="{{ role.role_key }}" data-is-member-only="{{ 'true' if role.is_member_only else 'false' }}">
                <input type="text" class="admin-assign-input {% if not role.owner_id %}unassigned-role{% endif %}"
                    placeholder="--- Select ---"
                    value="{% if role.owner_id %}{{ role.owner_name }}{% endif %}"
                    data-current-id="{{ role.owner_id or 0 }}"
                    autocomplete="off">
                <div class="autocomplete-results"></div>
            </div>
            {% else %}
            {% if role.owner_id %}
            {% if role.owner_id == current_user_contact_id %}
            <button class="btn btn-cancel"
                onclick="bookOrCancelRole('{{ role.session_id }}', 'cancel', '{{ role.role_key }}')">Cancel</button>
            {% else %}
            {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
            {% if current_user_contact_id in waitlist_ids %}
            <button class="btn btn-leave-waitlist"
                onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Leave Waitlist</button>
            {% else %}
            <button class="btn btn-join-waitlist"
                onclick="joinWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Join Waitlist</button>
            {% endif %}
            {% endif %}
            {% else %}
            {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
            {% if current_user_contact_id in waitlist_ids %}
            <button class="btn btn-leave-waitlist"
                onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Leave Waitlist</button>
            {% else %}
            {% if role.needs_approval %}
            <button class="btn btn-join-waitlist"
                onclick="joinWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Join Waitlist</button>
            {% else %}
            <button class="btn btn-book"
                onclick="bookOrCancelRole('{{ role.session_id }}', 'book', '{{ role.role_key }}')">Book</button>
            {% endif %}
            {% endif %}
            {% endif %}
            {% endif %}
            {% endif %}
        </td>

        {# Action Icons cell #}
        {% if is_admin_view %}
        <td class="icon-cell">
            <div class="button-group">
                <button class="icon-btn" title="Unassign Role" onclick="assignRole('{{ role.session_id }}', '0')"><i
                        class="fas fa-undo"></i></button>
                {% if role.waitlist %}<button class="icon-btn btn-approve-waitlist" title="Approve top of waitlist"
                    onclick="approveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')"><i
                        class="fas fa-user-check"></i></button>{% endif %}
            </div>
        </td>
        {% endif %}
    </tr>
    {% endmacro %}

    {# Macro to render role tables with accordion #}
    {% macro render_role_tables(roles, sorted_role_groups, status, is_admin_view, contacts, current_user_contact_id) %}

    {% set use_accordion = True %}
    {% set default_open = True %}

    <div class="award-accordion">
        {% for category, items in sorted_role_groups %}
        {% if items %}
        <div class="accordion-item" data-category="{{ category or 'other' }}">
            <button class="accordion-header {{ 'active' if default_open else '' }}">
                <span>{{ (category or 'Other')|replace('-', ' ')|title }} Roles</span>
                <div class="accordion-header-right">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </button>
            <div class="accordion-content" {% if default_open %}style="max-height: none;" {% endif %}>
                <table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">

                    <tbody>
                        {% for role in items %}
                        {{ render_role_row(role, status, is_admin_view, contacts, current_user_contact_id) }}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endmacro %}


    {# ============================================= #}
    {# =============== MAIN VIEW LOGIC =============== #}
    {# ============================================= #}

    {% if selected_meeting.status == 'finished' or (selected_meeting.status == 'running' and not is_admin_view) %}
    <p style="font-family: 'Montserrat', sans-serif; font-size: 2em; text-align: center;">Booking for Meeting #{{
        selected_meeting_number }} is closed.</p>
    <div style="text-align: center; margin-top: 20px;">
        <p>Please visit the <a
                href="{{ url_for('voting_bp.voting', selected_meeting_number=selected_meeting_number) }}">Voting
                page</a> to cast your votes.</p>
    </div>
    {% else %}
    {{ render_role_tables(roles, sorted_role_groups, selected_meeting.status, is_admin_view, contacts,
    current_user_contact_id) }}
    {% endif %}

    {% else %}
    <p>Please select a meeting to view the booking table.</p>
    {% endif %}

</div>

<script>
    // Pass Python data to global JS variables used by booking.js
    var isAdminView = {{ is_admin_view| tojson }};
    var selectedMeetingNumber = {{ selected_meeting_number| tojson }};
    var allContacts = [
        {% for contact in contacts %}
        {
            id: {{ contact.id }},
            name: {{ contact.Name | tojson }},
            type: {{ contact.Type | tojson }},
            avatar_url: {{ (url_for('static', filename=contact.Avatar_URL) if contact.Avatar_URL else None) | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
<script src="{{ url_for('static', filename='js/booking.js') }}"></script>
{% endblock %}