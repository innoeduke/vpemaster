{% extends "base.html" %}
{% from "components/meeting_filter.html" import render_meeting_filter %}

{% block title %}Role Booking{% endblock %}

{% block content %}
<div class="booking-container">
    <h1><i class="fas fa-tag"></i> Booking Assistant</h1>
    {% if user_role != 'Guest' %}
    <h3 class="booking-section-header">My Upcoming Roles</h3>
    <div class="my-bookings-container">
        {% if user_bookings_by_date %}
        <div class="horizontal-timeline">
            {% for group in user_bookings_by_date %}
            <div class="timeline-event" data-meeting-number="{{ group.date_info.meeting_number }}">
                <div class="timeline-header">
                    <span class="meeting-number">#{{ group.date_info.meeting_number }}</span>
                    <span class="meeting-date">{{ group.date_info.short_date }}</span>
                </div>
                <div class="timeline-marker"></div>
                <div class="timeline-roles-list">
                    {% for booking in group.bookings %}
                    <div class="timeline-role">
                        <i class="fas {{ booking.icon }}"></i> {{ booking.role }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>You have no upcoming roles booked.</p>
        {% endif %}
    </div>
    {% endif %}
    <div class="booking-filter-container">
        {{ render_meeting_filter(upcoming_meetings|sort(attribute=0, reverse=True), selected_meeting_number, label=None,
        render_outer_container=False) }}
        <div class="filter-right">
            {#
            {% if is_admin_view %}
            <button class="btn btn-primary" onclick="syncTally()">
                <i class="fas fa-sync"></i> Sync to Tally
            </button>
            {% endif %}
            #}
            <a href="{{ url_for('static', filename='files/club-meeting-roles-resource-library.pdf') }}" target="_blank"
                class="btn btn-info role-guide-link">
                <i class="fas fa-book-open"></i> View Role Guide
            </a>
        </div>
    </div>

    {% if selected_meeting %}

    {# ============================================= #}
    {# ================ MACRO DEFINITIONS ================ #}
    {# ============================================= #}

    {# Macro to render a single role row in the table #}
    {% macro render_role_row(role, status, is_admin_view, contacts, current_user_contact_id) %}
    <tr data-session-id="{{ role.session_id }}" data-role="{{ role.role }}">
        <td class="role-cell">
            <div class="role-cell-content">
                <i class="fas {{ role.icon }}"></i>
                <div class="role-display-text">
                    {% if role.role_level_status %}
                    <span class="role-badge {{ role.role_level_status }}" title="{{ 'Required' if role.role_level_status == 'required' else 'Elective' }} for your current level">
                        {{ 'Req' if role.role_level_status == 'required' else 'Elec' }}
                    </span>
                    {% endif %}
                    <span>{{ role.role }}</span>
                    {% if role.speaker_name %}<span class="speaker-for">for {{ role.speaker_name }}</span>{% endif %}
                </div>
            </div>
        </td>
        {# Status cell: waitlist #}
        <td class="status-cell">
            <div class="status-cell-content">
                {% if role.has_single_owner %}
                <div class="role-avatar {% if is_admin_view %}admin-avatar{% endif %}" {% if role.owner_name %}title="{{ role.owner_name }}" {% endif %} {% if is_admin_view and role.owner_id %}data-owner-id="{{ role.owner_id }}" data-session-id="{{ role.session_id }}"{% endif %}>
                    {% if role.owner_avatar_url %}
                    {% set avatar_path = role.owner_avatar_url %}
                    {% if '/' not in avatar_path %}
                        {% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
                    {% endif %}
                    <img src="{{ url_for('static', filename=avatar_path) }}" alt="User Avatar">
                    {% else %}
                    <img src="{{ url_for('static', filename='default_avatar.jpg') }}" alt="Default Avatar">
                    {% endif %}
                    {% if is_admin_view and role.owner_id %}
                    <button class="avatar-remove-btn" onclick="removeOwner('{{ role.session_id }}', '{{ role.owner_id }}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                {# Shared role: Show all owners #}
                {% if role.all_owners %}
                {% for owner in role.all_owners %}
                <div class="role-avatar {% if is_admin_view %}admin-avatar{% endif %}" title="{{ owner.name }}" {% if is_admin_view %}data-owner-id="{{ owner.id }}" data-session-id="{{ role.session_id }}"{% endif %}>
                    {% if owner.avatar_url %}
                    {% set avatar_path = owner.avatar_url %}
                    {% if '/' not in avatar_path %}
                        {% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
                    {% endif %}
                    <img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ owner.name }}">
                    {% else %}
                    <img src="{{ url_for('static', filename='default_avatar.jpg') }}" alt="Default Avatar">
                    {% endif %}
                    {% if is_admin_view %}
                    <button class="avatar-remove-btn" onclick="removeOwner('{{ role.session_id }}', '{{ owner.id }}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="role-avatar">
                    <img src="{{ url_for('static', filename='default_avatar.jpg') }}" alt="Default Avatar">
                </div>
                {% endif %}
                {% endif %}
                
                {% if status in ['not started', 'unpublished'] and role.waitlist %}
                {% for user in role.waitlist %}
                <div class="role-avatar waitlist-avatar" title="{{ user.name }} (Waitlist)">
                    {% if user.avatar_url %}
                    {% set avatar_path = user.avatar_url %}
                    {% if '/' not in avatar_path %}
                        {% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
                    {% endif %}
                    <img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ user.name }}">
                    {% else %}
                    <img src="{{ url_for('static', filename='default_avatar.jpg') }}" alt="Default Avatar">
                    {% endif %}
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </td>

        {# Assign/Action cell #}
        <td class="assign-cell">
            {% if status in ['not started', 'unpublished'] or is_admin_view %}
            {% if is_admin_view %}
            {# For shared roles with multiple owners, show one input per owner #}
            {% if role.all_owners is defined and role.all_owners|length > 0 %}
            <div class="multi-owner-inputs">
                {% for owner in role.all_owners %}
                <div class="autocomplete-container" data-session-id="{{ role.session_id }}" data-role="{{ role.role }}" data-is-member-only="{{ 'true' if role.is_member_only else 'false' }}">
                    <input type="text" class="admin-assign-input"
                        placeholder="--- Select ---"
                        value="{{ owner.name }}"
                        data-current-id="{{ owner.id }}"
                        autocomplete="off">
                    <div class="autocomplete-results"></div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="input-group">
                <div class="autocomplete-container" data-session-id="{{ role.session_id }}" data-role="{{ role.role }}" data-is-member-only="{{ 'true' if role.is_member_only else 'false' }}">
                    <input type="text" class="admin-assign-input {% if not role.owner_id %}unassigned-role{% endif %}"
                        placeholder="--- Select ---"
                        value="{% if role.owner_id %}{{ role.owner_name }}{% endif %}"
                        data-current-id="{{ role.owner_id or 0 }}"
                        autocomplete="off">
                    <div class="autocomplete-results"></div>
                </div>
                {# For single owner, the reset button is in the icon-cell #}
            </div>
            {% endif %}
            {% else %}
            {% if role.owner_id %}
            {% if role.owner_id == current_user_contact_id %}
            <button class="btn btn-cancel"
                onclick="bookOrCancelRole('{{ role.session_id }}', 'cancel', '{{ role.role }}')">Cancel</button>
            {% else %}
            {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
            {% if current_user_contact_id in waitlist_ids %}
            <button class="btn btn-leave-waitlist"
                onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role }}')">Leave Waitlist</button>
            {% else %}
            <button class="btn btn-join-waitlist"
                onclick="joinWaitlist('{{ role.session_id }}', '{{ role.role }}')">Join Waitlist</button>
            {% endif %}
            {% endif %}
            {% else %}
            {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
            {% if current_user_contact_id in waitlist_ids %}
            <button class="btn btn-leave-waitlist"
                onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role }}')">Leave Waitlist</button>
            {% else %}
            {# For shared roles with existing owners, show Join Waitlist instead of Book #}
            {% set has_existing_owners = role.all_owners is defined and role.all_owners|length > 0 %}
            {% if role.needs_approval or has_existing_owners %}
            <button class="btn btn-join-waitlist"
                onclick="joinWaitlist('{{ role.session_id }}', '{{ role.role }}')">Join Waitlist</button>
            {% else %}
            <button class="btn btn-book"
                onclick="bookOrCancelRole('{{ role.session_id }}', 'book', '{{ role.role }}')">Book</button>
            {% endif %}
            {% endif %}
            {% endif %}
            {% endif %}
            {% endif %}
        </td>

        {# Action Icons cell #}
        {% if is_admin_view %}
        <td class="icon-cell">
            <div class="button-group">
                {% if role.waitlist %}<button class="icon-btn btn-approve-waitlist" title="Approve top of waitlist"
                    onclick="approveWaitlist('{{ role.session_id }}', '{{ role.role }}')"><i
                        class="fas fa-user-check"></i></button>{% endif %}

                {# Reset Buttons #}
                <div class="reset-icon-container">
                    {% if role.all_owners is defined and role.all_owners|length > 0 %}
                    {# Multi-Owner: Stack of buttons #}
                    {% for owner in role.all_owners %}
                    <button class="icon-btn btn-reset-role" onclick="resetRole(this, '{{ role.session_id }}')" 
                        title="Unassign {{ owner.name }}" 
                        data-target-owner-id="{{ owner.id }}"
                        style="color: #6c757d; {% if not owner.id %}visibility: hidden;{% endif %}">
                        <i class="fas fa-undo"></i>
                    </button>
                    {% endfor %}
                    {% else %}
                    {# Single-Owner #}
                    <button class="icon-btn btn-reset-role" onclick="resetRole(this, '{{ role.session_id }}')" title="Unassign" 
                        style="color: #6c757d; {% if not role.owner_id %}display:none;{% endif %}">
                        <i class="fas fa-undo"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </td>
        {% endif %}
    </tr>
    {% endmacro %}

    {# Macro to render role tables with accordion #}
    {% macro render_role_tables(roles, sorted_role_groups, status, is_admin_view, contacts, current_user_contact_id) %}

    {% set use_accordion = True %}
    {% set default_open = True %}

    <div class="award-accordion">
        {% for category, items in sorted_role_groups %}
        {% if items %}
        <div class="accordion-item" data-category="{{ category or 'other' }}">
            <button class="accordion-header {{ 'active' if default_open else '' }}">
                <span>{{ (category or 'Other')|replace('-', ' ')|title }} Roles</span>
                <div class="accordion-header-right">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </button>
            <div class="accordion-content" {% if default_open %}style="max-height: none;" {% endif %}>
                <table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">

                    <tbody>
                        {% for role in items %}
                        {{ render_role_row(role, status, is_admin_view, contacts, current_user_contact_id) }}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endmacro %}


    {# ============================================= #}
    {# =============== MAIN VIEW LOGIC =============== #}
    {# ============================================= #}

    {% if selected_meeting.status == 'finished' or (selected_meeting.status == 'running' and not is_admin_view) %}
    <p>Booking for Meeting #{{
        selected_meeting_number }} is closed.
        Please visit the <a
                href="{{ url_for('voting_bp.voting', selected_meeting_number=selected_meeting_number) }}">Voting
                page</a> to cast your votes.</p>
    {% else %}
    {{ render_role_tables(roles, sorted_role_groups, selected_meeting.status, is_admin_view, contacts,
    current_user_contact_id) }}
    {% endif %}

    {% else %}
    <p>Please select a meeting to view the booking table.</p>
    {% endif %}

</div>

<script>
    // Pass Python data to global JS variables used by booking.js
    var isAdminView = {{ is_admin_view| tojson }};
    var selectedMeetingNumber = {{ selected_meeting_number| tojson }};
    var allContacts = [
        {% for contact in contacts %}
        {
            id: {{ contact.id }},
            name: {{ contact.Name | tojson }},
            type: {{ contact.Type | tojson }},
            avatar_url: {{ (url_for('static', filename=(config.AVATAR_ROOT_DIR ~ '/' ~ contact.Avatar_URL if '/' not in contact.Avatar_URL else contact.Avatar_URL)) if contact.Avatar_URL else url_for('static', filename='default_avatar.jpg')) | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
<script src="{{ url_for('static', filename='js/booking.js') }}"></script>
{% endblock %}