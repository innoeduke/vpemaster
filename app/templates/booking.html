{% extends "base.html" %}

{% block title %}Role Booking{% endblock %}



{% block content %}
<div class="booking-container">
    <h1>{% if user_role == 'Guest' %}Voting {% else %}Booking {% endif %}Assistant</h1>
    {% if user_role != 'Guest' %}
    <div class="booking-section-header">
        <div class="my-bookings-container">
            <h3>My Upcoming Roles</h3>
            {% if user_bookings_by_date %}
            <div class="horizontal-timeline">
                {% for group in user_bookings_by_date %}
                <div class="timeline-event" data-meeting-number="{{ group.date_info.meeting_number }}">
                    <div class="timeline-header">
                        <span class="meeting-number">#{{ group.date_info.meeting_number }}</span>
                        <span class="meeting-date">{{ group.date_info.short_date }}</span>
                    </div>
                    <div class="timeline-marker"></div>
                    <div class="timeline-roles-list">
                        {% for booking in group.bookings %}
                        <div class="timeline-role">
                            <i class="fas {{ booking.icon }}"></i> {{ booking.role }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>You have no upcoming roles booked.</p>
            {% endif %}
        </div>
    </div>
    <h3 class="booking-section-header">Available Roles</h3>
    {% endif %}
    <div class="booking-filter-container">
        <div class="filter-left">
            <i class="fas fa-calendar-alt"></i>
            <select id="meeting-filter" onchange="window.location.href = '/booking/' + this.value;">
                {% for meeting_num, meeting_date in upcoming_meetings | sort(attribute=0, reverse=True) %}
                    <option value="{{ meeting_num }}" {% if meeting_num == selected_meeting_number %}selected{% endif %}>
                        #{{ meeting_num }} - {{ meeting_date.strftime('%B %d, %Y') if meeting_date else 'No Date' }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-right">
            {% if is_admin_view %}
            <button class="btn btn-primary" onclick="syncTally()">
                <i class="fas fa-sync"></i> Sync to Tally
            </button>
            {% endif %}
            <a href="{{ url_for('static', filename='files/club-meeting-roles-resource-library.pdf') }}" target="_blank" class="btn btn-info role-guide-link">
                <i class="fas fa-book-open"></i> View Role Guide
            </a>
        </div>
    </div>

    {% if selected_meeting %}
        {# ============================================= #}
        {# ================ MACRO DEFINITIONS ================ #}
        {# ============================================= #}

        {# Macro to render a single role row in the table #}
        {% macro render_role_row(role, status, is_admin_view, contacts, current_user_contact_id, selected_meeting_number) %}
        <tr data-session-id="{{ role.session_id }}" data-role-key="{{ role.role_key }}" class="{% if role.award_type %}voted{% endif %}">
            <td class="role-cell">
                <div class="role-cell-content">
                    <i class="fas {{ role.icon }}"></i>
                    <div class="role-display-text">
                        <span>{{ role.role }}</span>
                        {% if role.speaker_name %}<span class="speaker-for">for {{ role.speaker_name }}</span>{% endif %}
                    </div>
                </div>
            </td>

            {# Status cell: waitlist for 'not started', winner label for 'finished' #}
            <td class="status-cell">
                <div class="status-cell-content">
                    <div class="role-avatar" {% if role.owner_name %}title="{{ role.owner_name }}"{% endif %}>
                        {% if role.owner_avatar_url %}
                            <img src="{{ url_for('static', filename=role.owner_avatar_url) }}" alt="User Avatar">
                        {% else %}
                                <i class="fas fa-user-circle"></i>
                        {% endif %}
                    </div>
                    {% if status in ['not started', 'unpublished'] and role.waitlist %}
                        {% for user in role.waitlist %}
                            <div class="role-avatar waitlist-avatar" title="{{ user.name }} (Waitlist)">
                                {% if user.avatar_url %}
                                    <img src="{{ url_for('static', filename=user.avatar_url) }}" alt="{{ user.name }}">
                                {% else %}
                                    <i class="fas fa-user-circle"></i>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if status == 'finished' and not is_admin_view and role.award_type %}
                        
                    {% endif %}
                </div>
            </td>

            {# Assign/Action cell: content varies by status and view #}
            <td class="assign-cell">
                {% if status in ['not started', 'unpublished'] %}
                    {% if is_admin_view %}
                        <select class="admin-assign-select {% if not role.owner_id %}unassigned-role{% endif %}" data-session-id="{{ role.session_id }}" data-role-key="{{ role.role_key }}">
                            <option value="0">--- Select ---</option>
                            {% for contact in contacts %}
                                {% if not role.is_member_only or (role.is_member_only and contact.Type == 'Member') %}
                                <option value="{{ contact.id }}" {% if role.owner_id == contact.id %}selected{% endif %}>{{ contact.Name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    {% else %}
                        {% if role.owner_id %}
                            {% if role.owner_id == current_user_contact_id %}
                                <button class="btn btn-cancel" onclick="bookOrCancelRole('{{ role.session_id }}', 'cancel', '{{ role.role_key }}')">Cancel</button>
                            {% else %}
                                {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
                                {% if current_user_contact_id in waitlist_ids %}
                                    <button class="btn btn-leave-waitlist" onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Leave Waitlist</button>
                                {% else %}
                                    <button class="btn btn-join-waitlist" onclick="joinWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Join Waitlist</button>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% set waitlist_ids = role.waitlist|map(attribute='id')|list %}
                            {% if current_user_contact_id in waitlist_ids %}
                                <button class="btn btn-leave-waitlist" onclick="leaveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')">Leave Waitlist</button>
                            {% else %}
                                <button class="btn btn-book" onclick="bookOrCancelRole('{{ role.session_id }}', 'book', '{{ role.role_key }}')">Book</button>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% else %} {# 'running' or 'finished' status #}
                    <div class="owner-display">{{ role.owner_name or 'Unassigned' }}</div>
                {% endif %}
            </td>

            {# Action Icons cell: content varies by status and view #}
            {% if not (status in ['not started', 'unpublished'] and not is_admin_view) %}
            <td class="icon-cell">
                {% if status in ['not started', 'unpublished'] and is_admin_view %}
                    <div class="button-group">
                        <button class="icon-btn" title="Unassign Role" onclick="assignRole('{{ role.session_id }}', '0')"><i class="fas fa-undo"></i></button>
                        {% if role.waitlist %}<button class="icon-btn btn-approve-waitlist" title="Approve top of waitlist" onclick="approveWaitlist('{{ role.session_id }}', '{{ role.role_key }}')"><i class="fas fa-user-check"></i></button>{% endif %}
                    </div>
                {% elif status == 'running' %}
                    {% if role.owner_id and role.award_category and (role.award_category_open or role.award_type) %}
                        <button type="button" class="icon-btn {% if role.award_type %}icon-btn-voted{% endif %}" title="Vote" onclick="handleVoteClick(this)" data-meeting-number="{{ selected_meeting_number }}" data-contact-id="{{ role.owner_id }}" data-award-category="{{ role.award_category }}">
                            <i class="fas fa-vote-yea"></i>
                        </button>
                    {% endif %}
                {% elif status == 'finished' %}
                    {% if is_admin_view %}
                        {% if role.owner_id and role.award_category %}
                            <button type="button" class="icon-btn {% if role.award_type %}icon-btn-voted{% endif %}" title="Vote" onclick="handleVoteClick(this)" data-meeting-number="{{ selected_meeting_number }}" data-contact-id="{{ role.owner_id }}" data-award-category="{{ role.award_category }}">
                                <i class="fas fa-vote-yea"></i>
                            </button>
                        {% endif %}
                    {% elif role.award_type %}
                         <span class="icon-btn icon-btn-voted" title="{{ role.award_type }} Winner">
                            <i class="fas fa-award"></i>
                         <span class="winner-label">{{ role.award_type|replace('-', ' ')|title }}</span>
                        </span>
                    {% endif %}
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endmacro %}

        {# Macro to render role tables, with or without accordion #}
        {% macro render_role_tables(roles, status, is_admin_view, contacts, current_user_contact_id, selected_meeting_number) %}
            {% set table_header %}
            <thead>
                <tr>
                    <th class="role-header">Role</th>
                    <th class="status-header"></th>
                    <th class="assign-header">{% if is_admin_view and status == 'not started' %}Assign{% else %}Name{% endif %}</th>
                    {% if not (status == 'not started' and not is_admin_view) %}<th class="action-header">Action</th>{% endif %}
                </tr>
            </thead>
            {% endset %}

            {% set use_accordion = (status == 'running') or (status == 'finished' and is_admin_view) or (status == 'not started') or (status == 'unpublished') %}

            {% if use_accordion %}
                <div class="award-accordion">
                {% for category, items in sorted_role_groups %}
                    {% if category and category != 'none' %}
                    <div class="accordion-item" data-category="{{ category }}">
                        <button class="accordion-header">
                            <span>{{ category|replace('-', ' ')|title }} Roles</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="accordion-content">
                            <table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">
                                <tbody>
                                {% for role in items %}
                                    {{ render_role_row(role, status, is_admin_view, contacts, current_user_contact_id, selected_meeting_number) }}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                </div>
        

            {% else %} {# e.g., finished member view #}
                <table class="booking-table is-{{ status|replace(' ', '-') }}-meeting">
                    <tbody>
                        {% set ns = namespace(displayed_awards=[]) %}
                        {% for role in roles %}
                            {% if role.award_type and role.award_type not in ns.displayed_awards %}
                                {{ render_role_row(role, status, is_admin_view, contacts, current_user_contact_id, selected_meeting_number) }}
                                {% set ns.displayed_awards = ns.displayed_awards + [role.award_type] %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endmacro %}


        {# ============================================= #}
        {# =============== MAIN VIEW LOGIC =============== #}
        {# ============================================= #}

        {% if selected_meeting.status == 'not started' and not current_user.is_authenticated %}
            <p style="font-family: 'Montserrat', sans-serif; font-size: 2em; text-align: center;">Voting for Meeting #{{ selected_meeting_number }} will open soon.</p>
            <div style="text-align: center; margin-top: 20px;">
                <img src="{{ url_for('static', filename='images/voting_open_soon.webp') }}" alt="Voting opens soon" style="max-width: 100%; height: auto; border: 5px solid #c5c5c5; border-radius: 15px;">
            </div>
        {% else %}
            {# Pass context to macro to access sorted_role_groups #}
            {% with %}
            {{ render_role_tables(roles, selected_meeting.status, is_admin_view, contacts, current_user_contact_id, selected_meeting_number) }}
            {% endwith %}
        {% endif %}

    {% else %}
        <p>Please select a meeting to view the booking table.</p>
    {% endif %}
    
</div>

<script>
    // Pass Python data to global JS variables used by booking.js
    var isAdminView = {{ is_admin_view|tojson }};
    var selectedMeetingNumber = {{ selected_meeting_number|tojson }};
    var currentUserName = "{{ session.display_name|e }}";
</script>
<script src="{{ url_for('static', filename='js/booking.js') }}"></script>
{% endblock %}