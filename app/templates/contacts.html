{% extends "base.html" %}
{% block title %}Contacts{% endblock %}

{% block head_extra %}
<style>
.loading-spinner-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 400px;
}

.loading-spinner {
  text-align: center;
  color: #666;
}

.loading-spinner i {
  font-size: 3rem;
  color: #004165;
  margin-bottom: 1rem;
  display: block;
}

.loading-spinner p {
  font-size: 1.1rem;
  margin: 0;
}
</style>
{% endblock %}

{% block content %}
<h1><i class="fas fa-book"></i> Contacts</h1>

<div class="contact-action-bar">
  <!-- Term Filter for Metrics -->
  <form method="GET" action="{{ url_for('contacts_bp.show_contacts') }}" id="contacts-term-filter-form" style="margin-right: 20px; flex: 1; max-width: 400px;">
      <div class="form-group" style="display: flex; align-items: center; margin-bottom: 0;">
          <label style="margin-right: 10px; font-weight: bold; white-space: nowrap;">Club Term:</label>
          
          <div class="custom-dropdown" id="term-dropdown-container" style="position: relative; flex: 1;">
              <button type="button" id="term-dropdown-btn" class="form-control" style="text-align: left; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; height: auto; padding: 6px 12px;" onclick="toggleTermDropdown(event)">
                  <span id="term-btn-text">
                    {% if selected_term_ids %}
                        {{ selected_term_ids|length }} selected
                    {% else %}
                        0 selected
                    {% endif %}
                  </span>
                  <i class="fas fa-caret-down"></i>
              </button>
              
              <div id="term-dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; max-height: 400px; overflow-y: auto; z-index: 1000; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
                  
                  <label style="display: block; padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; margin-bottom: 5px;">
                      <input type="checkbox" id="term-select-all" onchange="toggleAllTerms(this)" style="margin-right: 8px; vertical-align: middle;" {% if terms and selected_term_ids|length == terms|length %}checked{% endif %}> 
                      Select / Deselect All
                  </label>
                  
                  {% for term in terms %}
                  <label style="display: block; padding: 5px 10px; cursor: pointer; font-weight: normal; margin-bottom: 0;">
                      <input type="checkbox" name="term" value="{{ term.id }}" class="term-checkbox" onchange="updateTermSelection()" {% if selected_term_ids and term.id in selected_term_ids %}checked{% endif %} style="margin-right: 8px; vertical-align: middle;">
                      {{ term.label }}
                  </label>
                  {% endfor %}
              </div>
          </div>
      </div>
  </form>

  <script>
    // Initialize state on load
    document.addEventListener('DOMContentLoaded', function() {
        updateTermSelection(true); // true = skip UI update just count? No, update all state.
    });

    function toggleTermDropdown(event) {
        event.stopPropagation();
        event.preventDefault(); // Prevent accidental submission if button type wrong
        const menu = document.getElementById('term-dropdown-menu');
        if (menu.style.display === 'none') {
            menu.style.display = 'block';
        } else {
            closeDropdownAndSubmit();
        }
    }

    function toggleAllTerms(source) {
        const checkboxes = document.querySelectorAll('.term-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateTermSelection();
    }

    function updateTermSelection() {
        const checkboxes = document.querySelectorAll('.term-checkbox');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const totalCount = checkboxes.length;
        
        // Update Count Text
        const btnText = document.getElementById('term-btn-text');
        btnText.textContent = selectedCount + " selected";
        
        // Update Select All Checkbox State
        const selectAll = document.getElementById('term-select-all');
        // If all are selected, check "Select All"
        if (selectedCount === totalCount && totalCount > 0) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (selectedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else {
            // Partial selection
            selectAll.checked = false;
            // selectAll.indeterminate = true; // Optional: nicer UI
        }
    }

    function closeDropdownAndSubmit() {
        const menu = document.getElementById('term-dropdown-menu');
        menu.style.display = 'none';
        
        // Check if we need to submit (simple comparison could trigger only on change, 
        // but explicit requirements say "wait for users... only by then close". 
        // Submitting every time on close is safe.)
        document.getElementById('contacts-term-filter-form').submit();
    }

    // Close on click outside
    document.addEventListener('click', function(event) {
        const container = document.getElementById('term-dropdown-container');
        const menu = document.getElementById('term-dropdown-menu');
        
        if (menu.style.display === 'block' && !container.contains(event.target)) {
            closeDropdownAndSubmit();
        }
    });
    
    // Prevent clicks inside menu from closing it
    document.getElementById('term-dropdown-menu').addEventListener('click', function(event) {
        event.stopPropagation();
    });
  </script>

  <div class="stats-container">
    <div class="stat-item">
      <div class="stat-value" style="color: #007bff">{{ total_contacts }}</div>
      <div class="stat-label">Total Contacts</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" style="color: #28a745">{{ type_counts.get('Member', 0) }}</div>
      <div class="stat-label">Total Members</div>
    </div>
  </div>

  <div class="search-and-buttons">
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search all columns..." class="search-box" />
      <button id="clear-searchInput" class="clear-search-btn" style="display: none">
        &times;
      </button>
    </div>
    {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
    <div class="button-group">
      <button class="btn btn-primary" onclick="openContactModal()">
        Add Guest
      </button>
      <button class="btn btn-info" onclick="window.location.href='{{ url_for('roster_bp.roster') }}'">
        Open Roster
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Contact Tabs -->
<div class="nav-tabs" id="contactsTabs">
  {% for contact_type in contact_types %}
  <div class="nav-item {% if loop.first %}active{% endif %}" data-type="{{ contact_type }}">
    {{ contact_type }} <span class="tab-badge">{{ type_counts[contact_type] }}</span>
  </div>
  {% endfor %}
</div>

<div class="contact-table-container">
  <!-- Loading Spinner -->
  <div id="contactsLoadingSpinner" class="loading-spinner-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading contacts...</p>
    </div>
  </div>

  <table id="contactsTable" style="display: none;">
    <thead>
      <tr>
        <th class="sortable" data-column-index="0" data-sort-type="string">Name</th>
        <th class="sortable" data-column-index="1" data-sort-type="string">
          Participation
          <i class="fas fa-info-circle info-icon" title="Metrics are based on meetings in the current club from the last 6 months."></i>
        </th>
        <th class="sortable" data-column-index="2" data-sort-type="string">Phone Number</th>
        <th class="sortable" data-column-index="3" data-sort-type="string">Club</th>
        <th class="sortable" data-column-index="4" data-sort-type="string">Completed Paths</th>
        <th class="sortable" data-column-index="5" data-sort-type="string">Credentials</th>
        <th class="sortable" data-column-index="6" data-sort-type="string">Next Project</th>
        <th class="sortable" data-column-index="7" data-sort-type="string">Mentor</th>
        {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
        <th class="action-header" data-column-index="8">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for contact in contacts %}
      <tr data-type="{{ contact.Type }}">
        <td>
          <div class="contact-name-cell">
            {% if contact.Avatar_URL %}
            {# Check if the URL is already a full path (legacy) or just a filename (new) #}
            {% set avatar_path = contact.Avatar_URL %}
            {% if '/' not in avatar_path %}
              {% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
            {% endif %}
            <img src="{{ url_for('static', filename=avatar_path) }}" alt="Avatar" class="contact-avatar-small">
            {% else %}
            <div class="contact-avatar-placeholder-small">
              <i class="fas fa-user"></i>
            </div>
            {% endif %}
            <div class="contact-name-info {% if can_view_all_logs %}clickable-name{% endif %}" {% if can_view_all_logs
              %}onclick="window.location.href='{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id, view_mode='member') }}'"
              title="View {{ contact.Name }}'s speech logs" {% endif %}>
              {{ contact.Name }}
              {% if contact.DTM %}
              <sup class="dtm-superscript">DTM</sup>
              {% endif %}
              {% if contact.Member_ID and contact.Type != 'Guest' %}
              <span class="badge-member-id"
                style="margin-left: 5px; font-size: 0.8em; vertical-align: text-top; background-color: rgb(231, 231, 228); border-radius: 5px; padding: 2px 5px;">{{
                contact.Member_ID }}</span>
              {% endif %}
            </div>
          </div>
        </td>
        <td
          data-sort="{{ '1' if contact.is_qualified else '0' }}_{{ '%03d'|format(contact.role_count) }}_{{ '%03d'|format(contact.tt_count) }}_{{ '%03d'|format(contact.attendance_count) }}_{{ '%03d'|format(contact.award_count) }}">
          <div class="participation-container">
            {% if contact.is_qualified %}
            <i class="fas fa-star" title="Qualified Guest" style="color: #ffc107; font-size: 1.1em;"></i>
            {% endif %}
            <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" title="Roles Taken"
              class="participation-badge badge-roles">
              <i class="fas fa-user-tag"></i> {{ contact.role_count }}
            </a>
            <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" title="Topic Speeches"
              class="participation-badge badge-tt">
              <i class="fas fa-comment"></i> {{ contact.tt_count }}
            </a>
            <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" title="Attendance"
              class="participation-badge badge-attendance">
              <i class="fas fa-calendar-check"></i> {{ contact.attendance_count }}
            </a>
            <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" title="Awards Won"
              class="participation-badge badge-awards">
              <i class="fas fa-trophy"></i> {{ contact.award_count }}
            </a>
          </div>
        </td>
        <td>{{ contact.Phone_Number if contact.Phone_Number else '-' }}</td>
        <td>{{ contact.get_primary_club().club_name if contact.get_primary_club() else '-' }}</td>
        <td>
          {% if contact.Completed_Paths %}
            {% for path in contact.Completed_Paths.split('/') %}
              {% set path_trimmed = path.strip() %}
              {% set path_abbr = path_trimmed[:2]|lower %}
              <span class="badge-path path-{{ path_abbr }}">{{ path_trimmed }}</span>
            {% endfor %}
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ contact.credentials if contact.credentials else '-' }}</td>
        <td>{{ contact.Next_Project if contact.Next_Project else '-' }}</td>
        <td>{{ contact.mentor.Name if contact.mentor else '-' }}</td>
        {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
        <td>
          <div class="action-links">
            <button class="icon-btn" onclick="openContactModal({{ contact.id }})" title="Edit">
              <i class="fas fa-edit"></i>
            </button>

            <button class="delete-btn icon-btn"
              onclick="openDeleteModal('{{ url_for('contacts_bp.delete_contact',contact_id=contact.id) }}', 'contact')"
              title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
<div class="pagination-container" id="paginationContainer">
  <div class="pagination-info">
    <span id="paginationInfo">Showing 0 - 0 of 0 contacts</span>
  </div>
  
  <div class="pagination-controls">
    <button id="firstPageBtn" class="pagination-btn" title="First Page">
      <i class="fas fa-angle-double-left"></i>
    </button>
    <button id="prevPageBtn" class="pagination-btn" title="Previous Page">
      <i class="fas fa-angle-left"></i>
    </button>
    
    <span class="page-indicator">
      Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
    </span>
    
    <button id="nextPageBtn" class="pagination-btn" title="Next Page">
      <i class="fas fa-angle-right"></i>
    </button>
    <button id="lastPageBtn" class="pagination-btn" title="Last Page">
      <i class="fas fa-angle-double-right"></i>
    </button>
  </div>
  
  <div class="pagination-size">
    <label for="pageSizeSelect">Show:</label>
    <select id="pageSizeSelect" class="page-size-select">
      <option value="10">10</option>
      <option value="25" selected>25</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    <span>per page</span>
  </div>
</div>

{% include '_contact_modal.html' %}
{% include '_duplicate_modal.html' %}
<script>
  var MENTOR_CANDIDATES = [
    {% for m in mentor_candidates %}
  { id: {{ m.id }}, name: {{ m.Name | tojson }} },
  {% endfor %}
  ];

  
  // Global variables for contacts.js
  var canViewAllLogs = {{ 'true' if can_view_all_logs else 'false' }};
  var hasEditPermission = {{ 'true' if is_authorized(Permissions.CONTACT_BOOK_EDIT) else 'false' }};
  var INITIAL_CONTACTS = {{ contacts_json_data|tojson }};
</script>
<script src="{{ url_for('static', filename='js/contacts.js') }}"></script>

{% endblock %}