{% extends "base.html" %} {% block title %}Contacts{% endblock %} {% block
head_extra %}

{% endblock %} {% block content %}
<h1><i class="fas fa-book"></i> Contacts</h1>

<div class="contact-action-bar">
  <div class="stats-container">
    <div class="stat-item">
      <div class="stat-value" style="color: #007bff">{{ total_contacts }}</div>
      <div class="stat-label">Total Contacts</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" style="color: #28a745">
        {{ type_counts.get('Member', 0) }}
      </div>
      <div class="stat-label">Total Members</div>
    </div>
  </div>

  <div class="contacts-filter-container">
    <!-- Term Filter for Metrics -->
    <form method="GET" action="{{ url_for('contacts_bp.show_contacts') }}" id="contacts-term-filter-form"
      class="contacts-term-filter-form">
      <div class="form-group">
        <label class="filter-label">Club Term:</label>

        <div class="custom-dropdown-container" id="term-dropdown-container">
          <button type="button" id="term-dropdown-btn" class="form-control term-dropdown-btn"
            onclick="toggleTermDropdown(event)">
            <span id="term-btn-text">
              {% if selected_term_ids %} {{ selected_term_ids|length }} selected
              {% else %} 0 selected {% endif %}
            </span>
            <i class="fas fa-caret-down"></i>
          </button>

          <div id="term-dropdown-menu" class="term-dropdown-menu">
            <label class="term-select-all-label">
              <input type="checkbox" id="term-select-all" class="term-checkbox-input" onchange="toggleAllTerms(this)" {%
                if terms and selected_term_ids|length==terms|length %}checked{% endif %} />
              Select / Deselect All
            </label>

            {% for term in terms %}
            <label class="term-option-label">
              <input type="checkbox" name="term" value="{{ term.id }}" class="term-checkbox term-checkbox-input"
                data-label="{{ term.label }}" data-start="{{ term.start }}" data-end="{{ term.end }}"
                onchange="updateTermSelection()" {% if selected_term_ids and term.id in selected_term_ids %}checked{%
                endif %} />
              {{ term.label }}
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </form>

    <div class="search-and-buttons">
      <div class="search-container">
        <label for="searchInput" class="filter-label">Search Contact:</label>
        <div style="position: relative">
          <input type="text" id="searchInput" placeholder="Search all columns..." class="search-box" />
          <button id="clear-searchInput" class="clear-search-btn" style="display: none">
            &times;
          </button>
        </div>
      </div>
      {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
      <div class="button-group">
        <button class="btn btn-success" onclick="openContactModal()">
          Add New
        </button>
        <button id="mergeContactsBtn" class="btn btn-warning" onclick="handleMergeClick()" style="display: none"
          title="Select at least 2 contacts to merge">
          Merge
        </button>
        <button class="btn btn-primary" onclick="window.location.href='{{ url_for('roster_bp.roster') }}'">
          Open Roster
        </button>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Contact Tabs -->
<div class="nav-tabs" id="contactsTabs">
  {% for contact_type in contact_types %}
  <div class="nav-item {% if loop.first %}active{% endif %}" data-type="{{ contact_type }}">
    {{ contact_type }}
    <span class="tab-badge">{{ type_counts[contact_type] }}</span>
  </div>
  {% endfor %}
</div>

<div class="contact-table-container">
  <!-- Loading Spinner -->
  <div id="contactsLoadingSpinner" class="loading-spinner-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading contacts...</p>
    </div>
  </div>

  <table id="contactsTable" style="display: none">
    <thead>
      <tr>
        {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
        <th class="checkbox-header" style="width: 40px; text-align: center">
          <input type="checkbox" id="selectAllContacts" onclick="toggleSelectAll(this)" />
        </th>
        {% endif %}
        <th class="sortable col-name" data-column-index="0" data-sort-type="string">
          Name
        </th>
        <th class="sortable col-part" data-column-index="1" data-sort-type="string">
          Metrics
        </th>
        <th class="sortable col-phone" data-column-index="2" data-sort-type="string">
          Phone
        </th>
        <th class="sortable col-date" data-column-index="3" data-sort-type="date">
          Date Created
        </th>
        <th class="sortable col-club" data-column-index="4" data-sort-type="string">
          Club
        </th>
        <th class="sortable col-paths" data-column-index="5" data-sort-type="string">
          Completed Paths
        </th>
        <th class="sortable col-creds" data-column-index="6" data-sort-type="string">
          Credentials
        </th>
        <th class="sortable col-next" data-column-index="7" data-sort-type="string">
          Next Project
        </th>
        <th class="sortable col-mentor" data-column-index="8" data-sort-type="string">
          Mentor
        </th>
        {% if is_authorized(Permissions.CONTACT_BOOK_EDIT) %}
        <th class="action-header col-actions" data-column-index="9"></th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      <!-- Contacts will be populated by JS -->
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
<div class="pagination-container" id="paginationContainer">
  <div class="pagination-info">
    <span id="paginationInfo">Showing 0 - 0 of 0 contacts</span>
  </div>

  <div class="pagination-controls">
    <button id="firstPageBtn" class="pagination-btn" title="First Page">
      <i class="fas fa-angle-double-left"></i>
    </button>
    <button id="prevPageBtn" class="pagination-btn" title="Previous Page">
      <i class="fas fa-angle-left"></i>
    </button>

    <span class="page-indicator">
      Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
    </span>

    <button id="nextPageBtn" class="pagination-btn" title="Next Page">
      <i class="fas fa-angle-right"></i>
    </button>
    <button id="lastPageBtn" class="pagination-btn" title="Last Page">
      <i class="fas fa-angle-double-right"></i>
    </button>
  </div>

  <div class="pagination-size">
    <label for="pageSizeSelect">Show:</label>
    <select id="pageSizeSelect" class="page-size-select">
      <option value="10">10</option>
      <option value="25" selected>25</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    <span>per page</span>
  </div>
</div>

{% include '_contact_modal.html' %} {% include '_duplicate_modal.html' %} {%
include '_merge_modal.html' %}
<script id="contacts-data" type="application/json">
  {{ contacts_json_data|tojson }}
</script>

<script id="mentor-data" type="application/json">
[
  {% for m in mentor_candidates %}
  { "id": {{ m.id }}, "name": {{ m.Name | tojson }} }{% if not loop.last %},{% endif %}
  {% endfor %}
]
</script>

<script>
  // Global variables for contacts.js
  var canViewAllLogs = {{ 'true' if can_view_all_logs else 'false' }};
  var hasEditPermission = {{ 'true' if is_authorized(Permissions.CONTACT_BOOK_EDIT) else 'false' }};
  var selectedTermIds = {{ selected_term_ids|tojson }};

  var INITIAL_CONTACTS = [];
  try {
    var dataElement = document.getElementById('contacts-data');
    if (dataElement) {
      INITIAL_CONTACTS = JSON.parse(dataElement.textContent);
    }
  } catch (e) {
    console.error("Failed to parse contacts data:", e);
  }

  var MENTOR_CANDIDATES = [];
  try {
    var mentorElement = document.getElementById('mentor-data');
    if (mentorElement) {
      MENTOR_CANDIDATES = JSON.parse(mentorElement.textContent);
    }
  } catch (e) {
    console.error("Failed to parse mentor data:", e);
  }
</script>
<script src="{{ url_for('static', filename='js/contacts.js') }}"></script>

{% endblock %}