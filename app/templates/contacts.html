{% extends "base.html" %} 
{% block title %}Contacts{% endblock %} 

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/contacts.css') }}" />
{% endblock %}

{% block content %}
<h1>Contacts</h1>

<div class="contact-action-bar">
  <div class="stats-container">
    <div class="stat-item">
      <div class="stat-value" style="color: #007bff">{{ total_contacts }}</div>
      <div class="stat-label">Total Contacts</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" style="color: #28a745">{{ type_counts.get('Member', 0) }}</div>
      <div class="stat-label">Total Members</div>
    </div>
  </div>

  <div class="search-and-buttons">
    <div class="search-container">
      <input
        type="text"
        id="searchInput"
        placeholder="Search all columns..."
        class="search-box"
      />
      <button
        id="clear-searchInput"
        class="clear-search-btn"
        style="display: none"
      >
        &times;
      </button>
    </div>
    {% if is_authorized('CONTACT_BOOK_EDIT') %}
    <div class="button-group">
      <button class="btn btn-primary" onclick="openContactModal()">
        New Contact
      </button>
      <button
        class="btn btn-info"
        onclick="window.location.href='{{ url_for('roster_bp.roster') }}'"
      >
        Open Roster
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Contact Tabs -->
<div class="contacts-tabs" id="contactsTabs">
  <div class="tab-item active" data-type="All">
    All <span class="tab-count">{{ total_contacts }}</span>
  </div>
  {% for contact_type in contact_types %}
  <div class="tab-item" data-type="{{ contact_type }}">
    {{ contact_type }} <span class="tab-count">{{ type_counts[contact_type] }}</span>
  </div>
  {% endfor %}
</div>

<div class="contact-table-container">
  <table id="contactsTable">
    <thead>
      <tr>
        <th class="sortable" data-column-index="0">Name</th>
        <th class="sortable" data-column-index="1">Type</th>
        <th class="sortable" data-column-index="2">Club</th>
        <th class="sortable" data-column-index="3">Participation</th>
        <th class="sortable" data-column-index="4">Credentials</th>
        <th class="sortable" data-column-index="5">Completed Paths</th>
        <th class="sortable" data-column-index="6">Next Project</th>
        {% if is_authorized('CONTACT_BOOK_EDIT') %}
        <th class="action-header" data-column-index="7">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for contact in contacts %}
      <tr data-type="{{ contact.Type }}">
        <td>
          {{ contact.Name }} {% if contact.DTM %}
          <sup class="dtm-superscript">DTM</sup>
          {% endif %}
        </td>
        <td>{{ contact.Type if contact.Type else '-' }}</td>
        <td>{{ contact.Club if contact.Club else '-' }}</td>
        <td>
            <div class="participation-container">
                <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" 
                   title="Attendance" class="participation-badge badge-attendance">
                    <i class="fas fa-calendar-check"></i> {{ contact.attendance_count }}
                </a>
                <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" 
                   title="Roles Taken" class="participation-badge badge-roles">
                     <i class="fas fa-user-tag"></i> {{ contact.role_count }}
                </a>
                <a href="{{ url_for('speech_logs_bp.show_speech_logs', speaker_id=contact.id) }}" 
                   title="Awards Won" class="participation-badge badge-awards">
                    <i class="fas fa-trophy"></i> {{ contact.award_count }}
                </a>
            </div>
        </td>
        <td>{{ contact.credentials if contact.credentials else '-' }}</td>
        <td>{{ contact.Completed_Paths if contact.Completed_Paths else '-' }}</td>
        <td>{{ contact.Next_Project if contact.Next_Project else '-' }}</td>
        {% if is_authorized('CONTACT_BOOK_EDIT') %}
        <td>
          <div class="action-links">
            <button
              class="icon-btn"
              onclick="openContactModal({{ contact.id }})"
              title="Edit"
            >
              <i class="fas fa-edit"></i>
            </button>
            
            {% if contact.user %}
            <button class="icon-btn" disabled title="User already exists" style="color: #ccc; cursor: not-allowed;">
                <i class="fas fa-user-plus"></i>
            </button>
            {% else %}
            <form action="{{ url_for('users_bp.quick_add_user', contact_id=contact.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Create user for {{ contact.Name }}?');">
                <button type="submit" class="icon-btn" title="Quick Add User">
                    <i class="fas fa-user-plus"></i>
                </button>
            </form>
            {% endif %}
 
            <button
              class="delete-btn icon-btn"
              onclick="openDeleteModal('{{ url_for('contacts_bp.delete_contact',contact_id=contact.id) }}', 'contact')"
              title="Delete"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include '_contact_modal.html' %}
<script>
  var MENTOR_CANDIDATES = [
    {% for m in mentor_candidates %}
      { id: {{ m.id }}, name: "{{ m.Name }}" },
    {% endfor %}
  ];
</script>
<script src="{{ url_for('static', filename='js/contacts.js') }}"></script>

{% endblock %}
