{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
<h1>System Settings</h1>

<div class="settings-container">
  <div class="search-container global-search-bar">
    <input type="text" id="global-settings-search" name="global_settings_search" placeholder="Search the active tab..."
      class="search-box" />
    <button id="clear-global-settings-search" class="clear-search-btn">
      &times;
    </button>
  </div>

  <div class="nav-tabs">
    <button class="nav-item active" onclick="openTab(event, 'general')">
      General
    </button>
    <button class="nav-item" onclick="openTab(event, 'agenda-settings')">
      Agenda
    </button>
    <button class="nav-item" onclick="openTab(event, 'sessions')">
      Sessions
    </button>
    <button class="nav-item" onclick="openTab(event, 'user-settings')">
      Users</button>
    <button class="nav-item" onclick="openTab(event, 'level-roles')">
      Level Roles
    </button>
    <button class="nav-item" onclick="openTab(event, 'achievements')">
      Achievements
    </button>
  </div>

  <div id="general" class="tab-content">
    <h2>General Settings</h2>

    <table class="form-table general-settings-table">
      <thead>
        <tr>
          <th>Setting</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
      <tbody>
        {% for key, value in general_settings.items() %}
        {% if key.lower() not in ['term', 'excomm_name'] %}
        <tr>
          <td><strong>{{ key.replace('_', ' ')|title }}</strong></td>
          <td>{{ value }}</td>
        </tr>
        {% endif %}
        {% else %}
        <tr>
          <td colspan="2" class="no-settings-message">
            Could not load settings.ini or [Club Settings] section is empty.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2>Excomm Team</h2>
    <table class="form-table general-settings-table">
      <thead>
        <tr>
          <th colspan="2">
            {{ excomm_team.name }} ({{ excomm_team.term }})
          </th>
        </tr>
      </thead>
      <tbody>
        {% for role, name in excomm_team.members.items() %}
        <tr>
          <td><strong>{{ role }}</strong></td>
          <td>{{ name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="sessions" class="tab-content">
    <div class="settings-header">
      <h2>Session Types</h2>
      <div class="button-group">
        <button id="add-session-btn" class="btn btn-success">Add New</button>
        <button id="edit-sessions-btn" class="btn btn-primary">Edit</button>
        <button id="cancel-sessions-btn" class="btn btn-danger" style="display: none">
          Cancel
        </button>
      </div>
    </div>
    <table id="sessions-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">ID</th>
          <th class="sortable" data-column-index="1">Title</th>
          <th class="sortable" data-column-index="2">Role</th>
          <th class="sortable" data-column-index="3">Role Type</th>
          <th class="sortable" data-column-index="4">Min (mins)</th>
          <th class="sortable" data-column-index="5">Max (mins)</th>
          <th class="sortable" data-column-index="6">Section</th>
          <th class="sortable" data-column-index="7">Predefined</th>
          <th class="sortable" data-column-index="8">Project</th>
          <th class="sortable" data-column-index="9">Hidden</th>
        </tr>
      </thead>
      <tbody>
        {% for st in session_types %}
        <tr data-id="{{ st.id }}"
          class="{% if st.Is_Section %}session-section{% endif %} {% if st.Is_Hidden %}session-hidden{% endif %}">
          <td>{{ st.id }}</td>
          <td data-field="Title">{{ st.Title }}</td>
          <td data-field="role_id">{{ st.role.name if st.role else '' }}</td>
          <td data-field="Role_Type">{{ st.role.type if st.role else '' }}</td>
          <td data-field="Duration_Min">
            {{ st.Duration_Min if st.Duration_Min is not none else '' }}
          </td>
          <td data-field="Duration_Max">
            {{ st.Duration_Max if st.Duration_Max is not none else '' }}
          </td>
          <td data-field="Is_Section">
            <input type="checkbox" name="is_section" {% if st.Is_Section %}checked{% endif %} disabled />
          </td>
          <td data-field="Predefined">
            <input type="checkbox" name="predefined" {% if st.Predefined%}checked{% endif %} disabled />
          </td>
          <td data-field="Valid_for_Project">
            <input type="checkbox" name="valid_for_project" {% if st.Valid_for_Project %}checked{% endif %} disabled />
          </td>
          <td data-field="Is_Hidden">
            <input type="checkbox" name="is_hidden" {% if st.Is_Hidden %}checked{% endif %} disabled />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="agenda-settings" class="tab-content">
    <div class="settings-header">
      <h2>Meeting Roles</h2>
      <div class="button-group" style="min-width: 400px">
        <button id="add-role-btn" class="btn btn-success">Add New</button>
        <button id="edit-roles-btn" class="btn btn-primary">Edit</button>
        <button id="cancel-roles-btn" class="btn btn-danger" style="display: none">
          Cancel
        </button>
        <button type="button" class="btn btn-info" id="import-roles-btn">
          Import Roles
        </button>
        <form action="{{ url_for('settings_bp.import_roles') }}" method="post" enctype="multipart/form-data"
          id="import-roles-form" style="display: none">
          <input type="file" name="file" id="import-roles-file" />
        </form>
      </div>
    </div>
    <table id="roles-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">ID</th>
          <th class="sortable" data-column-index="1">Name</th>
          <th class="sortable" data-column-index="2">Icon</th>
          <th class="sortable" data-column-index="3">Type</th>
          <th class="sortable" data-column-index="4">Award Category</th>
          <th class="sortable" data-column-index="5">Needs Approval</th>
          <th class="sortable" data-column-index="6">Is Distinct</th>
          <th class="sortable" data-column-index="7">Is Member Only</th>
        </tr>
      </thead>
      <tbody>
        {% for role in roles_query %}
        <tr data-id="{{ role.id }}">
          <td>{{ role.id }}</td>
          <td data-field="name">{{ role.name }}</td>
          <td data-field="icon">
            <i class="fas {{ role.icon }}"></i> {{ role.icon }}
          </td>
          <td data-field="type">{{ role.type }}</td>
          <td data-field="award_category">{{ role.award_category }}</td>
          <td data-field="needs_approval">
            <input type="checkbox" name="needs_approval" {% if role.needs_approval %}checked{% endif %} disabled />
          </td>
          <td data-field="is_distinct">
            <input type="checkbox" name="is_distinct" {% if role.is_distinct %}checked{% endif %} disabled />
          </td>
          <td data-field="is_member_only">
            <input type="checkbox" name="is_member_only" {% if role.is_member_only %}checked{% endif %} disabled />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="user-settings" class="tab-content">
    <div class="settings-header">
      <h2>User Management</h2>
      <div class="button-group">
        <a href="{{ url_for('users_bp.user_form') }}" class="btn btn-primary">Add New User</a>
        <form action="{{ url_for('users_bp.bulk_import_users') }}" method="post" enctype="multipart/form-data"
          id="bulk-import-form">
          <input type="file" name="file" id="bulk-import-file" />
          <button type="button" class="btn btn-info" id="bulk-import-btn">
            Bulk Import
          </button>
        </form>
      </div>
    </div>
    <table id="user-settings-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">No.</th>
          <th class="sortable" data-column-index="1">Full Name (Username)</th>
          <th class="sortable" data-column-index="2">Role</th>
          <th class="sortable" data-column-index="3">Email</th>
          <th class="sortable" data-column-index="4">Phone</th>
          <th class="sortable" data-column-index="5">Mentor</th>
          <th class="sortable" data-column-index="6">Current Path</th>
          <th class="sortable" data-column-index="7">Next Project</th>
          <th class="sortable" data-column-index="8">Status</th>
          <th data-column-index="9">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in all_users %}
        <tr class="{{ 'inactive-user' if user.Status == 'inactive' else '' }}">
          <td>{{ loop.index }}</td>
          <td>
            {% if user.contact %} {{ user.contact.Name }} ({{ user.Username }})
            <i class="fas fa-link user-link-icon"></i>
            {% else %}
            <em class="user-not-linked">Not Linked</em>
            {% endif %}
          </td>
          <td>{{ user.Role }}</td>
          <td>{{ user.Email if user.Email else '' }}</td>
          <td>
            {{ user.contact.Phone_Number if user.contact and
            user.contact.Phone_Number else '' }}
          </td>
          <td>{{ user.contact.mentor.Name if user.contact and user.contact.mentor else '' }}</td>
          <td>{{ user.contact.Current_Path if user.contact and user.contact.Current_Path else '' }}</td>
          <td>{{ user.contact.Next_Project if user.contact and user.contact.Next_Project else '' }}</td>
          <td>{{ user.Status }}</td>
          <td>
            <div class="action-links">
              <a href="{{ url_for('users_bp.user_form', user_id=user.id) }}" class="icon-btn" title="Edit"><i
                  class="fas fa-edit"></i></a>
              <button class="delete-btn icon-btn"
                onclick="openDeleteModal('{{ url_for('users_bp.delete_user', user_id=user.id) }}', 'user')"
                title="Delete">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="level-roles" class="tab-content">
    <div class="settings-header">
      <h2>Level Roles</h2>
      <div class="button-group">
        <button id="add-level-role-btn" class="btn btn-success">Add New</button>
        <button id="edit-level-roles-btn" class="btn btn-primary">Edit</button>
        <button id="cancel-level-roles-btn" class="btn btn-danger" style="display: none">
          Cancel
        </button>
      </div>
    </div>
    <table id="level-roles-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">ID</th>
          <th class="sortable" data-column-index="1">Level</th>
          <th class="sortable" data-column-index="2">Role</th>
          <th class="sortable" data-column-index="3">Type</th>
          <th class="sortable" data-column-index="4">Count Required</th>
        </tr>
      </thead>
      <tbody>
        {% for lr in level_roles %}
        <tr data-id="{{ lr.id }}">
          <td>{{ lr.id }}</td>
          <td data-field="level">{{ lr.level }}</td>
          <td data-field="role">{{ lr.role }}</td>
          <td data-field="type">{{ lr.type }}</td>
          <td data-field="count_required">{{ lr.count_required }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="achievements" class="tab-content">
    <div class="settings-header">
      <h2>Achievement Tracking</h2>
      <div class="button-group">
        {% if is_authorized('ACHIEVEMENTS_EDIT') %}
        <a href="{{ url_for('achievements_bp.achievement_form') }}" class="btn btn-success">
          Add Achievement
        </a>
        {% endif %}
      </div>
    </div>

    <div class="table-container">
      <table class="table table-striped" id="achievementsTable">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">Date</th>
            <th class="sortable" data-column-index="1">Member</th>
            <th class="sortable" data-column-index="2">Member ID</th>
            <th class="sortable" data-column-index="3">Type</th>
            <th class="sortable" data-column-index="4">Path</th>
            <th class="sortable" data-column-index="5">Level</th>
            <th class="sortable" data-column-index="6">Notes</th>
            {% if is_authorized('ACHIEVEMENTS_EDIT') %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for achievement in achievements %}
          <tr>
            <td>{{ achievement.issue_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ achievement.contact.Name }}</td>
            <td>{{ achievement.member_id or '-' }}</td>
            <td>{{ 'DTM' if achievement.achievement_type == 'dtm' else achievement.achievement_type.replace('-', '
              ').title() }}</td>
            <td>{{ achievement.path_name or '-' }}</td>
            <td>{{ achievement.level if achievement.level else '-' }}</td>
            <td>{{ achievement.notes or '-' }}</td>
            {% if is_authorized('ACHIEVEMENTS_EDIT') %}
            <td>
              <div class="action-links">
                <a href="{{ url_for('achievements_bp.achievement_form', id=achievement.id) }}" class="icon-btn"
                  title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <form action="{{ url_for('achievements_bp.delete_achievement', id=achievement.id) }}" method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Are you sure you want to delete this achievement?');">
                  <button type="submit" class="delete-btn icon-btn" title="Delete">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center">No achievements found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>




  {% include '_session_modal.html' %} {% include '_role_modal.html' %}

  <!-- Mobile Warning Modal -->
  <div id="mobile-settings-warning-modal" class="modal" style="display: none; background-color: rgba(0,0,0,0.9);">
    <div class="modal-content" style="width: 90%; max-width: 400px; text-align: center;">
      <!-- No close button -->
      <h1 style="color: #004165; margin-bottom: 25px;">Desktop Required</h1>
      <div style="font-size: 48px; color: #d9534f; margin-bottom: 20px;">
        <i class="fas fa-desktop"></i>
      </div>
      <p style="margin-bottom: 25px; font-size: 1.1em; line-height: 1.5;">
        System Settings are not available on mobile devices. <br>
        <br>
        Please access this page from a PC to configure settings.
      </p>
      <a href="{{ url_for('agenda_bp.agenda') }}" class="btn btn-primary"
        style="width: 90%; display: block; text-decoration: none; height: 40px; line-height: 40px;">
        Return to Agenda
      </a>
    </div>
  </div>

  <script>
    var ROLES_DATA = {{ roles| tojson }};
  </script>
  {% endblock %} {% block scripts %}
  <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Check if mobile (width < 768px matches typical tablet/mobile breakpoint)
      if (window.innerWidth < 768) {
        const modal = document.getElementById('mobile-settings-warning-modal');
        modal.style.display = 'flex';

        // Prevent scrolling on body
        document.body.style.overflow = 'hidden';
      }
    });
  </script>
  {% endblock %}