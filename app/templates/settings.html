{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block head_extra %}
<style>
  #roles-permissions .permissions-matrix-container {
    padding: 20px 0;
  }
  /* Hide ID columns in settings tables */
  #sessions-table th:nth-child(1), 
  #sessions-table td:nth-child(1),
  #roles-table th:nth-child(1),
  #roles-table td:nth-child(1),
  #global-sessions-table th:nth-child(1),
  #global-sessions-table td:nth-child(1),
  #global-roles-table th:nth-child(1),
  #global-roles-table td:nth-child(1),
  #excomm-table th:nth-child(1),
  #excomm-table td:nth-child(1) {
    display: none;
  }

  #save-permissions-btn:disabled {
    background-color: #cccccc !important;
    color: #666666 !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
  }
</style>
{% endblock %}

{% block content %}
<h1><i class="fas fa-cog"></i> Club Administration Console </h1>

<div class="desktop-only-content">
  <div class="settings-container">
    <div class="search-container global-search-bar">
      <input type="text" id="global-settings-search" name="global_settings_search" placeholder="Search the active tab..."
        class="search-box" />
      <button id="clear-global-settings-search" class="clear-search-btn">
        &times;
      </button>
    </div>

    <div class="nav-tabs">
      <button class="nav-item" onclick="openTab(event, 'user-settings')">
        Users</button>
      <button class="nav-item" onclick="openTab(event, 'achievements')">
        Achievements
      </button>
      <button class="nav-item" onclick="openTab(event, 'excomm-settings')">
        Excomm
      </button>
      <button class="nav-item active" onclick="openTab(event, 'agenda-settings')">
        Roles 
      </button>
      <button class="nav-item" onclick="openTab(event, 'sessions')">
        Sessions
      </button>
      <button class="nav-item" onclick="openTab(event, 'roles-permissions')">
        Roles & Permissions
      </button>
      <button class="nav-item" onclick="openTab(event, 'audit-log')">
        Audit Log
      </button>
      
    </div>

    <div id="excomm-settings" class="tab-content">
      <div class="settings-header">
        <h2>Excomm Management</h2>
        <div class="button-group">
          <button id="add-excomm-btn" class="btn btn-success" onclick="openExcommModal()">
            <i class="fas fa-plus"></i> Add New
          </button>
        </div>
      </div>
      <div class="table-container">
        <table id="excomm-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Term</th>
              <th>Team Name</th>
              <!-- Dynamic Officer Columns -->
              {% for role in officer_roles %}
                <th>{{ role.name }}</th>
              {% endfor %}
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for exc in excomm_history %}
              <tr data-id="{{ exc.id }}" data-start="{{ exc.start_date }}" data-end="{{ exc.end_date }}">
                <td>{{ exc.id }}</td>
                <td>
                  {{ exc.excomm_term }}
                  {% if exc.club.current_excomm_id == exc.id %}
                    <span class="badge bg-success ms-2">Current</span>
                  {% endif %}
                </td>
                <td>{{ exc.excomm_name or '' }}</td>
                
                {% set officers = exc.get_officers() %}
                {% for role in officer_roles %}
                  <td data-role-id="{{ role.id }}" data-contact-id="{{ officers.get(role.name).id if officers.get(role.name) else '' }}">
                    {% if officers.get(role.name) %}
                      {{ officers.get(role.name).Name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                {% endfor %}
                
                <td>
                  <div class="action-links">
                    <button class="edit-btn icon-btn" onclick="openEditExcommModal(this)" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn icon-btn" onclick="openDeleteModal('/settings/excomm/delete/{{ exc.id }}', 'Excomm Team')" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div id="sessions" class="tab-content">
      
      <!-- CLUB SPECIFIC / OR SINGLE TABLE FOR GLOBAL ADMIN -->
      <div class="settings-header">
        <h2>
          {% if club_id != GLOBAL_CLUB_ID %}Club Specific Session Types{% else %}Session Types (Global Repository){% endif %}
        </h2>
        <div class="button-group">
          <button id="add-session-btn" class="btn btn-success" style="flex-grow: 0;">Add New</button>
        </div>
      </div>
      <table id="sessions-table">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">ID</th>
            <th class="sortable" data-column-index="1">Title</th>
            <th class="sortable" data-column-index="2">Meeting Roles</th>
            <th class="sortable" data-column-index="3">Min (mins)</th>
            <th class="sortable" data-column-index="4">Max (mins)</th>
            <th class="sortable" data-column-index="5">Section</th>
            <th class="sortable" data-column-index="6">Project</th>
            <th class="sortable" data-column-index="7">Hidden</th>
            <th data-column-index="8">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% set sessions_to_show = global_session_types if club_id == GLOBAL_CLUB_ID else local_session_types %}
          {% for st in sessions_to_show %}
          <tr data-id="{{ st.id }}"
            class="{% if st.Is_Section %}session-section{% endif %} {% if st.Is_Hidden %}session-hidden{% endif %}">
            <td>{{ st.id }}</td>
            <td data-field="Title">{{ st.Title }}</td>
            <td data-field="role_id" data-role-id="{{ st.role_id or '' }}">
              {% if st.role %}
              {% set role_class = 'role-' ~ st.role.award_category if st.role.award_category else 'role-other' %}
              {% if st.role.type == 'officer' %}
                  {% set role_class = 'role-officer' %}
              {% endif %}
              <span class="roster-role-tag {{ role_class }}">{{ st.role.name }}</span>
              {% endif %}
            </td>

            <td data-field="Duration_Min">
              {{ st.Duration_Min if st.Duration_Min is not none else '' }}
            </td>
            <td data-field="Duration_Max">
              {{ st.Duration_Max if st.Duration_Max is not none else '' }}
            </td>
            <td data-field="Is_Section">
              <input type="checkbox" name="is_section" {% if st.Is_Section %}checked{% endif %} disabled />
            </td>
            <td data-field="Valid_for_Project">
              <input type="checkbox" name="valid_for_project" {% if st.Valid_for_Project %}checked{% endif %} disabled />
            </td>
            <td data-field="Is_Hidden">
              <input type="checkbox" name="is_hidden" {% if st.Is_Hidden %}checked{% endif %} disabled />
            </td>
            <td>
               <div class="action-links">
                 <button class="edit-btn icon-btn" onclick="openEditSessionModal('{{ st.id }}')" title="Edit">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('settings_bp.delete_session_type', id=st.id) }}', 'session type')" title="Delete">
                   <i class="fas fa-trash-alt"></i>
                 </button>
               </div>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- GLOBAL SESSION TYPES -->
      {% if club_id != GLOBAL_CLUB_ID %}
      <div class="settings-header" style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
        <h2>Global Session Types (Standard)</h2>
        <!-- No add button for global items here -->
      </div>
      <table id="global-sessions-table" class="readonly-table">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">ID</th>
            <th class="sortable" data-column-index="1">Title</th>
            <th class="sortable" data-column-index="2">Meeting Roles</th>
            <th class="sortable" data-column-index="3">Min (mins)</th>
            <th class="sortable" data-column-index="4">Max (mins)</th>
            <th class="sortable" data-column-index="5">Section</th>
            <th class="sortable" data-column-index="6">Project</th>
            <th class="sortable" data-column-index="7">Hidden</th>
            <!-- No Actions column for Global items -->
          </tr>
        </thead>
        <tbody>
          {% for st in global_session_types %}
          <tr data-id="{{ st.id }}" class="{% if st.Is_Section %}session-section{% endif %} {% if st.Is_Hidden %}session-hidden{% endif %}">
            <td>{{ st.id }}</td>
            <td>{{ st.Title }}</td>
            <td>
              {% if st.role %}
              {% set role_class = 'role-' ~ st.role.award_category if st.role.award_category else 'role-other' %}
              {% if st.role.type == 'officer' %}
                  {% set role_class = 'role-officer' %}
              {% endif %}
              <span class="roster-role-tag {{ role_class }}">{{ st.role.name }}</span>
              {% endif %}
            </td>
            <td>{{ st.Duration_Min if st.Duration_Min is not none else '' }}</td>
            <td>{{ st.Duration_Max if st.Duration_Max is not none else '' }}</td>
            <td><input type="checkbox" {% if st.Is_Section %}checked{% endif %} disabled /></td>
            <td><input type="checkbox" {% if st.Valid_for_Project %}checked{% endif %} disabled /></td>
            <td><input type="checkbox" {% if st.Is_Hidden %}checked{% endif %} disabled /></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>

    <div id="agenda-settings" class="tab-content">
      <!-- CLUB SPECIFIC ROLES -->
      <div class="settings-header">
        <h2>
          {% if club_id != GLOBAL_CLUB_ID %}Club Specific Meeting Roles{% else %}Meeting Roles (Global Repository){% endif %}
        </h2>
        <div class="button-group">
          <button id="add-role-btn" class="btn btn-success" style="flex-grow: 0;">Add New</button>
        </div>


      </div>
      <table id="roles-table">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">ID</th>
            <th class="sortable" data-column-index="1">Name</th>
            <th class="sortable" data-column-index="2">Icon</th>
            <th class="sortable" data-column-index="3">Type</th>
            <th class="sortable" data-column-index="4">Award Category</th>
            <th class="sortable" data-column-index="5">Needs Approval</th>
            <th class="sortable" data-column-index="6">Single Owner Only</th>
            <th class="sortable" data-column-index="7">Member Only</th>
            <th data-column-index="8">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% set roles_to_show = global_roles if club_id == GLOBAL_CLUB_ID else local_roles %}
          {% for role in roles_to_show %}
          <tr data-id="{{ role.id }}">
            <td>{{ role.id }}</td>
            <td data-field="name">
              {% set role_class = 'role-' ~ role.award_category if role.award_category else 'role-other' %}
              {% if role.type == 'officer' %}
                  {% set role_class = 'role-officer' %}
              {% endif %}
              <span class="roster-role-tag {{ role_class }}">{{ role.name }}</span>
            </td>
            <td data-field="icon">
              <i class="fas {{ role.icon }}"></i> {{ role.icon }}
            </td>
            <td data-field="type">{{ role.type }}</td>
            <td data-field="award_category">{{ role.award_category }}</td>
            <td data-field="needs_approval">
              <input type="checkbox" name="needs_approval" {% if role.needs_approval %}checked{% endif %} disabled />
            </td>
            <td data-field="has_single_owner">
              <input type="checkbox" name="has_single_owner" {% if role.has_single_owner %}checked{% endif %} disabled />
            </td>
            <td data-field="is_member_only">
              <input type="checkbox" name="is_member_only" {% if role.is_member_only %}checked{% endif %} disabled />
            </td>
            <td>
              <div class="action-links">
                <button class="edit-btn icon-btn" onclick="openEditRoleModal('{{ role.id }}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('settings_bp.delete_role', id=role.id) }}', 'role')" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- GLOBAL ROLES -->
      {% if club_id != GLOBAL_CLUB_ID %}
      <div class="settings-header" style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
        <h2>Global Meeting Roles (Standard)</h2>
      </div>
      <table id="global-roles-table" class="readonly-table">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">ID</th>
            <th class="sortable" data-column-index="1">Name</th>
            <th class="sortable" data-column-index="2">Icon</th>
            <th class="sortable" data-column-index="3">Type</th>
            <th class="sortable" data-column-index="4">Award Category</th>
            <th class="sortable" data-column-index="5">Needs Approval</th>
            <th class="sortable" data-column-index="6">Single Owner Only</th>
            <th class="sortable" data-column-index="7">Member Only</th>
            <!-- No actions -->
          </tr>
        </thead>
        <tbody>
          {% for role in global_roles %}
          <tr data-id="{{ role.id }}">
            <td>{{ role.id }}</td>
            <td>
              {% set role_class = 'role-' ~ role.award_category if role.award_category else 'role-other' %}
              {% if role.type == 'officer' %}
                  {% set role_class = 'role-officer' %}
              {% endif %}
              <span class="roster-role-tag {{ role_class }}">{{ role.name }}</span>
            </td>
            <td><i class="fas {{ role.icon }}"></i> {{ role.icon }}</td>
            <td>{{ role.type }}</td>
            <td>{{ role.award_category }}</td>
            <td><input type="checkbox" {% if role.needs_approval %}checked{% endif %} disabled /></td>
            <td><input type="checkbox" {% if role.has_single_owner %}checked{% endif %} disabled /></td>
            <td><input type="checkbox" {% if role.is_member_only %}checked{% endif %} disabled /></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>

    <div id="user-settings" class="tab-content">
      <div class="settings-header">
        <h2>User Management</h2>
        <div class="button-group">
          <button type="button" class="btn btn-success" style="flex-grow: 0;" onclick="openUserModal()">Add New</button>
          <form action="{{ url_for('users_bp.bulk_import_users') }}" method="post" enctype="multipart/form-data"
            id="bulk-import-form">
            <input type="file" name="file" id="bulk-import-file" />
            <button type="button" class="btn btn-info" id="bulk-import-btn">
              Bulk Import
            </button>
          </form>
        </div>
      </div>
      <table id="user-settings-table">
        <thead>
          <tr>
            <th class="sortable" data-column-index="0">No.</th>
            <th class="sortable" data-column-index="1">Full Name (Username)</th>
            <th class="sortable" data-column-index="2">Roles</th>
            <th class="sortable" data-column-index="3">Email</th>
            <th class="sortable" data-column-index="4">Phone</th>
            <th class="sortable" data-column-index="5">Mentor</th>
            <th class="sortable" data-column-index="6">Current Path</th>
            <th class="sortable" data-column-index="7">Next Project</th>
            <th data-column-index="8">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in all_users %}
          {% set user_roles = user.get_roles_for_club(club_id)|map(attribute='id')|list %}
          <tr class="{{ 'inactive-user' if user.status == 'inactive' else '' }}"
              data-id="{{ user.id }}"
              data-username="{{ user.username or '' }}"
              data-first-name="{{ user.first_name or '' }}"
              data-last-name="{{ user.last_name or '' }}"
              data-email="{{ user.email or '' }}"
              data-phone="{{ user.phone or '' }}"
              data-contact-id="{{ user.contact.id if user.contact else '' }}"
              data-roles='{{ user_roles|tojson }}'>
            <td>{{ loop.index }}</td>
            <td>
              {% if user.contact %} {{ user.contact.Name }} ({{ user.username }})
              {% else %}
              <em class="user-not-linked">Not Linked</em>
              {% endif %}
            </td>
            <td>
              {% set role_priority = {
                'sysadmin': 100,
                'clubadmin': 90,
                'staff': 80,
                'other': 50,
                'user': 10
              } %}
              {% set ns = namespace(best_role=none, max_prio=-1) %}
              
              {% for role in user.get_roles_for_club(club_id) if role.name != 'Guest' %}
                {% set category = role.award_category if role.award_category else 'other' %}
                {% set prio = role_priority.get(category, 50) %}
                {% if prio > ns.max_prio %}
                  {% set ns.max_prio = prio %}
                  {% set ns.best_role = role %}
                {% endif %}
              {% endfor %}
              
              {% if ns.best_role %}
                {% set role = ns.best_role %}
                {% set role_class = 'role-' ~ role.award_category if role.award_category else 'role-other' %}
                <span class="roster-role-tag {{ role_class }}">{{ role.name }}</span>
              {% else %}
                <em class="text-muted">No Role</em>
              {% endif %}
            </td>
            <td>{{ user.email if user.email else '' }}</td>
            <td>
              {{ user.contact.Phone_Number if user.contact and
              user.contact.Phone_Number else '' }}
            </td>
            <td>{{ user.contact.mentor.Name if user.contact and user.contact.mentor else '' }}</td>
            <td>
              {% if user.contact and user.contact.Current_Path %}
                {% set path_map = {
                  'Dynamic Leadership': 'dl',
                  'Engaging Humor': 'eh', 
                  'Motivational Strategies': 'ms',
                  'Persuasive Influence': 'pi',
                  'Presentation Mastery': 'pm',
                  'Visionary Communication': 'vc',
                  'Effective Coaching': 'ec',
                  'Innovative Planning': 'ip',
                  'Leadership Development': 'ld',
                  'Strategic Relationships': 'sr',
                  'Team Collaboration': 'tc'
                } %}
                {% set path_abbr = path_map.get(user.contact.Current_Path, 'dt') %}
                <span class="badge-path path-{{ path_abbr }}">{{ user.contact.Current_Path }}</span>
              {% endif %}
            </td>
            <td>{{ user.contact.Next_Project if user.contact and user.contact.Next_Project else '' }}</td>
            <td>
              <div class="action-links">
                <button type="button" class="icon-btn edit-user-btn" onclick="openUserModal('{{ user.id }}', this)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn icon-btn"
                  onclick="openDeleteModal('{{ url_for('users_bp.delete_user', user_id=user.id) }}', 'user')"
                  title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination-container" id="user-pagination">
        <div class="pagination-info" id="user-pagination-info">Showing 0 - 0 of 0 users</div>
        <div class="pagination-controls">
          <button class="pagination-btn first-page-btn" title="First Page"><i class="fas fa-angle-double-left"></i></button>
          <button class="pagination-btn prev-page-btn" title="Previous Page"><i class="fas fa-angle-left"></i></button>
          <span class="page-indicator">
            Page <span class="current-page-display">1</span> of <span class="total-pages-display">1</span>
          </span>
          <button class="pagination-btn next-page-btn" title="Next Page"><i class="fas fa-angle-right"></i></button>
          <button class="pagination-btn last-page-btn" title="Last Page"><i class="fas fa-angle-double-right"></i></button>
        </div>
        <div class="pagination-size">
          <label>Show:</label>
          <select class="page-size-select">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>

    <div id="achievements" class="tab-content">
      <div class="settings-header">
        <h2>Achievement Tracking</h2>
        <div class="button-group">
          {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
          <button type="button" class="btn btn-success" onclick="openAchievementModal()">
            Add New 
          </button>
          {% endif %}
        </div>
      </div>

      <div class="table-container">
        <table class="table table-striped" id="achievementsTable">
          <tbody>
            {% for group in achievements|groupby('contact_id') %}
            {% set contact = group.list[0].contact %}
            <tr class="achievement-group-header" data-id="group-{{ group.grouper }}" onclick="toggleAchievementGroup('{{ group.grouper }}')">
              <td colspan="{% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}9{% else %}8{% endif %}" class="group-header-cell">
                <i class="fas fa-chevron-right toggle-icon"></i>
                <strong>{{ contact.Name }}</strong>
                {% set path_count = group.list|selectattr('achievement_type', 'equalto', 'path-completion')|list|length %}
                {% set level_count = group.list|selectattr('achievement_type', 'equalto', 'level-completion')|list|length %}
                {% set program_count = group.list|selectattr('achievement_type', 'equalto', 'program-completion')|list|length %}
                {% if path_count > 0 %}
                <span class="badge bg-primary ms-2">{{ path_count }} {{ 'Path' if path_count == 1 else 'Paths' }}</span>
                {% endif %}
                {% if level_count > 0 %}
                <span class="badge bg-success ms-2">{{ level_count }} {{ 'Level' if level_count == 1 else 'Levels' }}</span>
                {% endif %}
                {% if program_count > 0 %}
                <span class="badge bg-warning text-dark ms-2">{{ program_count }} {{ 'Program' if program_count == 1 else 'Programs' }}</span>
                {% endif %}
                {% if path_count == 0 and level_count == 0 and program_count == 0 %}
                <span class="badge bg-info text-dark ms-2">{{ group.list|length }} {{ 'Achievement' if group.list|length == 1 else 'Achievements' }}</span>
                {% endif %}
              </td>
            </tr>
            <!-- Group Header Row (Hidden by default, toggled with group) -->
            <tr class="achievement-row header-row" data-parent-id="group-{{ group.grouper }}" style="display: none; background-color: #f8f9fa;">
              <th></th> <!-- Alignment for toggle column -->
              <th>Date</th>
              <th>Member ID</th>
              <th>Type</th>
              <th>Path</th>
              <th>Level</th>
              <th>Notes</th>
              {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
              <th>Actions</th>
              {% endif %}
            </tr>
            {% for achievement in group.list %}
            <tr class="achievement-row" data-parent-id="group-{{ group.grouper }}" style="display: none;">
              <td></td> <!-- Toggle column alignment -->
              <td>{{ achievement.issue_date.strftime('%Y-%m-%d') }}</td>
              <td>{{ achievement.member_id or '-' }}</td>
              <td>
                {% if achievement.achievement_type == 'path-completion' %}
                <span class="badge bg-primary">Path Completion</span>
                {% elif achievement.achievement_type == 'level-completion' %}
                <span class="badge bg-success">Level Completion</span>
                {% elif achievement.achievement_type == 'program-completion' %}
                <span class="badge bg-warning text-dark">Program Completion</span>
                {% else %}
                <span class="badge bg-info text-dark">{{ 'DTM' if achievement.achievement_type == 'dtm' else achievement.achievement_type.replace('-', ' ').title() }}</span>
                {% endif %}
              </td>
              <td>{{ achievement.path_name or '-' }}</td>
              <td>{{ achievement.level if achievement.level else '-' }}</td>
              <td>{{ achievement.notes or '-' }}</td>
              {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
              <td>
                <div class="action-links">
                  <a href="javascript:void(0)" class="icon-btn"
                    onclick="openAchievementModal('{{ achievement.id }}')"
                    title="Edit">
                    <i class="fas fa-edit"></i>
                  </a>
                  <form action="{{ url_for('achievements_bp.delete_achievement', id=achievement.id) }}" method="POST"
                    style="display:inline;"
                    onsubmit="return confirm('Are you sure you want to delete this achievement?');">
                    <button type="submit" class="delete-btn icon-btn" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="{% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}9{% else %}8{% endif %}" class="text-center">No achievements found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="pagination-container" id="achievement-pagination">
        <div class="pagination-info" id="achievement-pagination-info">Showing 0 - 0 of 0 achievements</div>
        <div class="pagination-controls">
          <button class="pagination-btn first-page-btn" title="First Page"><i class="fas fa-angle-double-left"></i></button>
          <button class="pagination-btn prev-page-btn" title="Previous Page"><i class="fas fa-angle-left"></i></button>
          <span class="page-indicator">
            Page <span class="current-page-display">1</span> of <span class="total-pages-display">1</span>
          </span>
          <button class="pagination-btn next-page-btn" title="Next Page"><i class="fas fa-angle-right"></i></button>
          <button class="pagination-btn last-page-btn" title="Last Page"><i class="fas fa-angle-double-right"></i></button>
        </div>
        <div class="pagination-size">
          <label>Show:</label>
          <select class="page-size-select">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>




  </div>

  <div id="roles-permissions" class="tab-content">
    <div class="settings-header">
      <h2>Roles & Permissions</h2>
      <div class="button-group">
        <button id="save-permissions-btn" class="btn btn-success" title="Save changes to role permissions" disabled>
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
    <div class="permissions-matrix-container">
      <p class="matrix-instruction">Manage permissions for each system role. Changes will take effect on next login.</p>
      <div id="permissions-matrix-loading" class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading permissions...
      </div>
      <div id="permissions-matrix" style="display: none;">
        <!-- Matrix will be rendered by JS -->
      </div>
    </div>
  </div>

  <div id="audit-log" class="tab-content">
    <div class="settings-header">
      <h2>Permission Audit Log</h2>
      <div class="search-container">
        <input type="text" id="audit-search" placeholder="Filter by user or action..." class="search-box">
      </div>
    </div>
    <div class="table-container">
      <table id="audit-log-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Admin</th>
            <th>Action</th>
            <th>Target</th>
            <th>Changes</th>
          </tr>
        </thead>
        <tbody id="audit-log-body">
          <!-- Will be rendered by JS -->
        </tbody>
      </table>
    </div>
  </div>
  {% include '_session_modal.html' %}
  {% include 'partials/_achievement_modal.html' %}
  {% include '_role_modal.html' %}
  {% include 'partials/_user_modal.html' %}
</div>

<!-- Mobile Warning Modal -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<div id="mobile-settings-warning-modal" class="modal" style="display: none; background-color: rgba(0,0,0,0.9);">
  <div class="modal-content" style="width: 90%; max-width: 400px; text-align: center; font-family: 'Montserrat', sans-serif;">
    <!-- No close button -->
    <h1 style="color: #004165; margin-bottom: 25px; font-family: 'Montserrat', sans-serif; font-weight: 700;">Desktop Required</h1>
    <div style="font-size: 48px; color: #d9534f; margin-bottom: 20px;">
      <i class="fas fa-desktop"></i>
    </div>
    <p style="margin-bottom: 25px; font-size: 1.1em; line-height: 1.5; font-family: 'Montserrat', sans-serif;">
      System Settings are not available on mobile devices. <br>
      <br>
      Please access this page from a PC to configure settings.
    </p>
    <a href="{{ url_for('agenda_bp.agenda') }}" class="btn btn-primary"
      style="width: 90%; display: block; text-decoration: none; height: 40px; line-height: 40px; margin: 0 auto; font-family: 'Montserrat', sans-serif; font-weight: 600;">
      Return to Agenda
    </a>
  </div>
</div>

<!-- Excomm Modal -->
<div id="excomm-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeExcommModal()">&times;</span>
    <h2 id="excomm-modal-title">Add/Edit Excomm Team</h2>
    <form id="excomm-form">
      <input type="hidden" id="excomm-id" name="id">
      
      <div class="form-group compact-form">
        <label for="excomm-term">Term:</label>
        <input type="text" id="excomm-term" name="term" required class="form-control" placeholder="e.g. 26H1">
      </div>
      
      <div class="form-group compact-form">
        <label for="excomm-name">Team Name:</label>
        <input type="text" id="excomm-name" name="name" class="form-control" placeholder="e.g. The Dream Team">
      </div>
      
      <fieldset class="modal-frame">
        <legend>Duration:</legend>
        <div class="form-group-row" style="display: flex; gap: 15px;">
          <div class="form-group compact-form" style="flex: 1;">
            <label for="excomm-start">Start Date:</label>
            <input type="date" id="excomm-start" name="start_date" required class="form-control">
          </div>
          <div class="form-group compact-form" style="flex: 1;">
            <label for="excomm-end">End Date:</label>
            <input type="date" id="excomm-end" name="end_date" required class="form-control">
          </div>
        </div>
      </fieldset>
      
      <fieldset class="modal-frame">
        <legend>Officers:</legend>
        <div class="officer-fields-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          {% for role in officer_roles %}
            <div class="form-group compact-form">
              <label for="officer-search-{{ role.id }}">{{ role.name }}:</label>
              <div class="autocomplete-container" style="position: relative;">
                <input type="text" id="officer-search-{{ role.id }}" class="form-control officer-search-input" placeholder="Search member...">
                <input type="hidden" id="officer-role-{{ role.id }}" name="officer_{{ role.id }}" class="officer-select">
              </div>
            </div>
          {% endfor %}
        </div>
      </fieldset>

      <div class="modal-buttons">
        <button type="button" class="btn btn-danger" onclick="closeExcommModal()">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
    var ROLES_DATA = {{ roles| tojson }};
    const ALL_CONTACTS = {{ all_contacts| tojson }};
    const CURRENT_CLUB_ID = {{ club_id }};
    const PATHWAYS_DATA = {{ pathways| tojson }};
    const PROGRAMS_DATA = {{ programs| tojson }};
</script>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/custom_select.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings_excomm.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Check if mobile (width < 768px matches typical tablet/mobile breakpoint)
    if (window.innerWidth < 768) {
      const modal = document.getElementById('mobile-settings-warning-modal');
      modal.style.display = 'flex';

      // Prevent scrolling on body
      document.body.style.overflow = 'hidden';
    }

  });
</script>
{% endblock %}