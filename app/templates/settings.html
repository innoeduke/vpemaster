{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  #roles-permissions .permissions-matrix-container {
    padding: 20px;
  }
  /* Hide ID columns in settings tables */
  #sessions-table th:nth-child(1), 
  #sessions-table td:nth-child(1),
  #roles-table th:nth-child(1),
  #roles-table td:nth-child(1) {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<h1><i class="fas fa-cog"></i> Club Administration Console </h1>

<div class="settings-container">
  <div class="search-container global-search-bar">
    <input type="text" id="global-settings-search" name="global_settings_search" placeholder="Search the active tab..."
      class="search-box" />
    <button id="clear-global-settings-search" class="clear-search-btn">
      &times;
    </button>
  </div>

  <div class="nav-tabs">
    <button class="nav-item" onclick="openTab(event, 'user-settings')">
      Users</button>
    <button class="nav-item" onclick="openTab(event, 'achievements')">
      Achievements
    </button><button class="nav-item active" onclick="openTab(event, 'agenda-settings')">
      Roles 
    </button>
    <button class="nav-item" onclick="openTab(event, 'sessions')">
      Sessions
    </button>
    <button class="nav-item" onclick="openTab(event, 'roles-permissions')">
      Roles & Permissions
    </button>
    <button class="nav-item" onclick="openTab(event, 'audit-log')">
      Audit Log
    </button>
  </div>

  <div id="sessions" class="tab-content">
    <div class="settings-header">
      <h2>Session Types</h2>
      <div class="button-group">
        <button id="add-session-btn" class="btn btn-success">Add New</button>
        <button id="edit-sessions-btn" class="btn btn-primary">Edit</button>
        <button id="cancel-sessions-btn" class="btn btn-danger" style="display: none">
          Cancel
        </button>
      </div>
    </div>
    <table id="sessions-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">ID</th>
          <th class="sortable" data-column-index="1">Title</th>
          <th class="sortable" data-column-index="2">Meeting Role</th>
          <th class="sortable" data-column-index="3">Default Owner</th>
          <th class="sortable" data-column-index="4">Min (mins)</th>
          <th class="sortable" data-column-index="5">Max (mins)</th>
          <th class="sortable" data-column-index="6">Section</th>
          <th class="sortable" data-column-index="7">Predefined</th>
          <th class="sortable" data-column-index="8">Project</th>
          <th class="sortable" data-column-index="9">Hidden</th>
          <th data-column-index="10">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for st in session_types %}
        <tr data-id="{{ st.id }}"
          class="{% if st.Is_Section %}session-section{% endif %} {% if st.Is_Hidden %}session-hidden{% endif %}">
          <td>{{ st.id }}</td>
          <td data-field="Title">{{ st.Title }}</td>
          <td data-field="role_id">{{ st.role.name if st.role else '' }}</td>
          <td data-field="Default_Owner">{{ st.Default_Owner or '' }}</td>
          <td data-field="Duration_Min">
            {{ st.Duration_Min if st.Duration_Min is not none else '' }}
          </td>
          <td data-field="Duration_Max">
            {{ st.Duration_Max if st.Duration_Max is not none else '' }}
          </td>
          <td data-field="Is_Section">
            <input type="checkbox" name="is_section" {% if st.Is_Section %}checked{% endif %} disabled />
          </td>
          <td data-field="Predefined">
            <input type="checkbox" name="predefined" {% if st.Predefined%}checked{% endif %} disabled />
          </td>
          <td data-field="Valid_for_Project">
            <input type="checkbox" name="valid_for_project" {% if st.Valid_for_Project %}checked{% endif %} disabled />
          </td>
          <td data-field="Is_Hidden">
            <input type="checkbox" name="is_hidden" {% if st.Is_Hidden %}checked{% endif %} disabled />
          </td>
          <td>
             <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('settings_bp.delete_session_type', id=st.id) }}', 'session type')" title="Delete">
                <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="agenda-settings" class="tab-content">
    <div class="settings-header">
      <h2>Meeting Roles</h2>
      <div class="button-group" style="min-width: 400px">
        <button id="add-role-btn" class="btn btn-success">Add New</button>
        <button id="edit-roles-btn" class="btn btn-primary">Edit</button>
        <button id="cancel-roles-btn" class="btn btn-danger" style="display: none">
          Cancel
        </button>
        <button type="button" class="btn btn-info" id="import-roles-btn">
          Import Roles
        </button>
        <form action="{{ url_for('settings_bp.import_roles') }}" method="post" enctype="multipart/form-data"
          id="import-roles-form" style="display: none">
          <input type="file" name="file" id="import-roles-file" />
        </form>
      </div>
    </div>
    <table id="roles-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">ID</th>
          <th class="sortable" data-column-index="1">Name</th>
          <th class="sortable" data-column-index="2">Icon</th>
          <th class="sortable" data-column-index="3">Type</th>
          <th class="sortable" data-column-index="4">Award Category</th>
          <th class="sortable" data-column-index="5">Needs Approval</th>
          <th class="sortable" data-column-index="6">Has Single Owner</th>
          <th class="sortable" data-column-index="7">Is Member Only</th>
          <th data-column-index="8">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for role in roles_query %}
        <tr data-id="{{ role.id }}">
          <td>{{ role.id }}</td>
          <td data-field="name">{{ role.name }}</td>
          <td data-field="icon">
            <i class="fas {{ role.icon }}"></i> {{ role.icon }}
          </td>
          <td data-field="type">{{ role.type }}</td>
          <td data-field="award_category">{{ role.award_category }}</td>
          <td data-field="needs_approval">
            <input type="checkbox" name="needs_approval" {% if role.needs_approval %}checked{% endif %} disabled />
          </td>
          <td data-field="has_single_owner">
            <input type="checkbox" name="has_single_owner" {% if role.has_single_owner %}checked{% endif %} disabled />
          </td>
          <td data-field="is_member_only">
            <input type="checkbox" name="is_member_only" {% if role.is_member_only %}checked{% endif %} disabled />
          </td>
          <td>
            <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('settings_bp.delete_role', id=role.id) }}', 'role')" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="user-settings" class="tab-content">
    <div class="settings-header">
      <h2>User Management</h2>
      <div class="button-group">
        <a href="{{ url_for('users_bp.user_form') }}" class="btn btn-primary">Add New User</a>
        <form action="{{ url_for('users_bp.bulk_import_users') }}" method="post" enctype="multipart/form-data"
          id="bulk-import-form">
          <input type="file" name="file" id="bulk-import-file" />
          <button type="button" class="btn btn-info" id="bulk-import-btn">
            Bulk Import
          </button>
        </form>
      </div>
    </div>
    <table id="user-settings-table">
      <thead>
        <tr>
          <th class="sortable" data-column-index="0">No.</th>
          <th class="sortable" data-column-index="1">Full Name (Username)</th>
          <th class="sortable" data-column-index="2">Role</th>
          <th class="sortable" data-column-index="3">Email</th>
          <th class="sortable" data-column-index="4">Phone</th>
          <th class="sortable" data-column-index="5">Mentor</th>
          <th class="sortable" data-column-index="6">Current Path</th>
          <th class="sortable" data-column-index="7">Next Project</th>
          <th data-column-index="8">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in all_users %}
        <tr class="{{ 'inactive-user' if user.status == 'inactive' else '' }}">
          <td>{{ loop.index }}</td>
          <td>
            {% if user.contact %} {{ user.contact.Name }} ({{ user.username }})
            {% else %}
            <em class="user-not-linked">Not Linked</em>
            {% endif %}
          </td>
          <td>
            {% for role_name in user.get_roles_for_club(club_id) if role_name != 'Guest' %}
            {{ role_name }}{% if not loop.last %}, {% endif %}
            {% else %}
            <em class="text-muted">No Role</em>
            {% endfor %}
          </td>
          <td>{{ user.email if user.email else '' }}</td>
          <td>
            {{ user.contact.Phone_Number if user.contact and
            user.contact.Phone_Number else '' }}
          </td>
          <td>{{ user.contact.mentor.Name if user.contact and user.contact.mentor else '' }}</td>
          <td>{{ user.contact.Current_Path if user.contact and user.contact.Current_Path else '' }}</td>
          <td>{{ user.contact.Next_Project if user.contact and user.contact.Next_Project else '' }}</td>
          <td>
            <div class="action-links">
              <a href="{{ url_for('users_bp.user_form', user_id=user.id) }}" class="icon-btn" title="Edit"><i
                  class="fas fa-edit"></i></a>
              <button class="delete-btn icon-btn"
                onclick="openDeleteModal('{{ url_for('users_bp.delete_user', user_id=user.id) }}', 'user')"
                title="Delete">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination-container" id="user-pagination">
      <div class="pagination-info" id="user-pagination-info">Showing 0 - 0 of 0 users</div>
      <div class="pagination-controls">
        <button class="pagination-btn first-page-btn" title="First Page"><i class="fas fa-angle-double-left"></i></button>
        <button class="pagination-btn prev-page-btn" title="Previous Page"><i class="fas fa-angle-left"></i></button>
        <span class="page-indicator">
          Page <span class="current-page-display">1</span> of <span class="total-pages-display">1</span>
        </span>
        <button class="pagination-btn next-page-btn" title="Next Page"><i class="fas fa-angle-right"></i></button>
        <button class="pagination-btn last-page-btn" title="Last Page"><i class="fas fa-angle-double-right"></i></button>
      </div>
      <div class="pagination-size">
        <label>Show:</label>
        <select class="page-size-select">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>


  <div id="achievements" class="tab-content">
    <div class="settings-header">
      <h2>Achievement Tracking</h2>
      <div class="button-group">
        {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
        <a href="{{ url_for('achievements_bp.achievement_form') }}" class="btn btn-success">
          Add Achievement
        </a>
        {% endif %}
      </div>
    </div>

    <div class="table-container">
      <table class="table table-striped" id="achievementsTable">
        <thead>
          <tr>
            <th></th> <!-- Toggle column -->
            <th>Date</th>
            <th>Member ID</th>
            <th>Type</th>
            <th>Path</th>
            <th>Level</th>
            <th>Notes</th>
            {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for group in achievements|groupby('contact_id') %}
          {% set contact = group.list[0].contact %}
          <tr class="achievement-group-header" data-id="group-{{ group.grouper }}" onclick="toggleAchievementGroup('{{ group.grouper }}')">
            <td colspan="{% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}9{% else %}8{% endif %}" class="group-header-cell">
              <i class="fas fa-chevron-right toggle-icon"></i>
              <strong>{{ contact.Name }}</strong>
              {% set path_count = group.list|selectattr('achievement_type', 'equalto', 'path-completion')|list|length %}
              {% set level_count = group.list|selectattr('achievement_type', 'equalto', 'level-completion')|list|length %}
              {% set program_count = group.list|selectattr('achievement_type', 'equalto', 'program-completion')|list|length %}
              {% if path_count > 0 %}
              <span class="badge bg-primary ms-2">{{ path_count }} Paths</span>
              {% endif %}
              {% if level_count > 0 %}
              <span class="badge bg-success ms-2">{{ level_count }} Levels</span>
              {% endif %}
              {% if program_count > 0 %}
              <span class="badge bg-warning text-dark ms-2">{{ program_count }} Programs</span>
              {% endif %}
              {% if path_count == 0 and level_count == 0 and program_count == 0 %}
              <span class="badge bg-info text-dark ms-2">{{ group.list|length }} Achievements</span>
              {% endif %}
            </td>
          </tr>
          {% for achievement in group.list %}
          <tr class="achievement-row" data-parent-id="group-{{ group.grouper }}" style="display: none;">
            <td></td> <!-- Toggle column alignment -->
            <td>{{ achievement.issue_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ achievement.member_id or '-' }}</td>
            <td>
              {% if achievement.achievement_type == 'path-completion' %}
              <span class="badge bg-primary">Path Completion</span>
              {% elif achievement.achievement_type == 'level-completion' %}
              <span class="badge bg-success">Level Completion</span>
              {% elif achievement.achievement_type == 'program-completion' %}
              <span class="badge bg-warning text-dark">Program Completion</span>
              {% else %}
              <span class="badge bg-info text-dark">{{ 'DTM' if achievement.achievement_type == 'dtm' else achievement.achievement_type.replace('-', ' ').title() }}</span>
              {% endif %}
            </td>
            <td>{{ achievement.path_name or '-' }}</td>
            <td>{{ achievement.level if achievement.level else '-' }}</td>
            <td>{{ achievement.notes or '-' }}</td>
            {% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}
            <td>
              <div class="action-links">
                <a href="{{ url_for('achievements_bp.achievement_form', id=achievement.id) }}" class="icon-btn"
                  title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <form action="{{ url_for('achievements_bp.delete_achievement', id=achievement.id) }}" method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Are you sure you want to delete this achievement?');">
                  <button type="submit" class="delete-btn icon-btn" title="Delete">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="{% if is_authorized(Permissions.ACHIEVEMENTS_EDIT) %}9{% else %}8{% endif %}" class="text-center">No achievements found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="pagination-container" id="achievement-pagination">
      <div class="pagination-info" id="achievement-pagination-info">Showing 0 - 0 of 0 achievements</div>
      <div class="pagination-controls">
        <button class="pagination-btn first-page-btn" title="First Page"><i class="fas fa-angle-double-left"></i></button>
        <button class="pagination-btn prev-page-btn" title="Previous Page"><i class="fas fa-angle-left"></i></button>
        <span class="page-indicator">
          Page <span class="current-page-display">1</span> of <span class="total-pages-display">1</span>
        </span>
        <button class="pagination-btn next-page-btn" title="Next Page"><i class="fas fa-angle-right"></i></button>
        <button class="pagination-btn last-page-btn" title="Last Page"><i class="fas fa-angle-double-right"></i></button>
      </div>
      <div class="pagination-size">
        <label>Show:</label>
        <select class="page-size-select">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>




</div>

<div id="roles-permissions" class="tab-content">
  <div class="settings-header">
    <h2>Roles & Permissions</h2>
    <div class="button-group">
      <button id="save-permissions-btn" class="btn btn-primary" title="Save changes to role permissions">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>
  </div>
  <div class="permissions-matrix-container">
    <p class="matrix-instruction">Manage permissions for each system role. Changes will take effect on next login.</p>
    <div id="permissions-matrix-loading" class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i> Loading permissions...
    </div>
    <div id="permissions-matrix" style="display: none;">
      <!-- Matrix will be rendered by JS -->
    </div>
  </div>
</div>

<div id="audit-log" class="tab-content">
  <div class="settings-header">
    <h2>Permission Audit Log</h2>
    <div class="search-container">
      <input type="text" id="audit-search" placeholder="Filter by user or action..." class="search-box">
    </div>
  </div>
  <div class="table-container">
    <table id="audit-log-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Admin</th>
          <th>Action</th>
          <th>Target</th>
          <th>Changes</th>
        </tr>
      </thead>
      <tbody id="audit-log-body">
        <!-- Will be rendered by JS -->
      </tbody>
    </table>
  </div>
</div>

{% include '_session_modal.html' %} {% include '_role_modal.html' %}

<!-- Mobile Warning Modal -->
<div id="mobile-settings-warning-modal" class="modal" style="display: none; background-color: rgba(0,0,0,0.9);">
  <div class="modal-content" style="width: 90%; max-width: 400px; text-align: center;">
    <!-- No close button -->
    <h1 style="color: #004165; margin-bottom: 25px;">Desktop Required</h1>
    <div style="font-size: 48px; color: #d9534f; margin-bottom: 20px;">
      <i class="fas fa-desktop"></i>
    </div>
    <p style="margin-bottom: 25px; font-size: 1.1em; line-height: 1.5;">
      System Settings are not available on mobile devices. <br>
      <br>
      Please access this page from a PC to configure settings.
    </p>
    <a href="{{ url_for('agenda_bp.agenda') }}" class="btn btn-primary"
      style="width: 90%; display: block; text-decoration: none; height: 40px; line-height: 40px;">
      Return to Agenda
    </a>
  </div>
</div>

<script>
  var ROLES_DATA = {{ roles| tojson }};
</script>
</script>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Check if mobile (width < 768px matches typical tablet/mobile breakpoint)
    if (window.innerWidth < 768) {
      const modal = document.getElementById('mobile-settings-warning-modal');
      modal.style.display = 'flex';

      // Prevent scrolling on body
      document.body.style.overflow = 'hidden';
    }

  });
</script>
{% endblock %}