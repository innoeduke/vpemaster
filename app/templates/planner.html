{% extends "base.html" %}

{% block title %}Planner{% endblock %}

{% block header_title %}My Planner{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-desktop.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-ipad.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-mobile.css') }}">
{% endblock %}

{% block content %}
<div class="planner-container">
    <div class="planner-header">
        <h1 class="page-title"><i class="fas fa-tasks"></i> Planner</h1>
        <button class="btn btn-success" id="add-plan-btn"><i class="fas fa-plus"></i> New Plan</button>
    </div>

    <div class="planner-card">
        <div class="planner-table-container">
            <table class="planner-table">
                <thead>
                    <tr>
                        <th>Meeting</th>
                        <th>Role</th>
                        <th>Project</th>
                        <th>Status</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="planner-tbody">
                    {% for plan in plans %}
                    <tr data-id="{{ plan.id }}" data-meeting="{{ plan.meeting_number or '' }}"
                        data-role="{{ plan.meeting_role_id or '' }}" data-project="{{ plan.project_id or '' }}"
                        data-status="{{ plan.status }}" data-notes="{{ plan.notes or '' }}">
                        <td data-label="Meeting">#{{ plan.meeting_number or 'N/A' }}</td>
                        <td data-label="Role">{{ plan.role.name if plan.role else 'N/A' }}</td>
                        <td data-label="Project">{{ plan.project.Project_Name if plan.project else 'N/A' }}</td>
                        <td data-label="Status">
                            <span class="status-badge status-{{ plan.status }}">
                                {{ plan.status|capitalize }}
                            </span>
                        </td>
                        <td data-label="Notes">{{ plan.notes or '' }}</td>
                        <td data-label="Actions">
                            <div class="action-btns">
                                <button class="btn-icon btn-edit" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if plan.status not in ['completed', 'cancelled', 'obsolete'] %}
                                <button type="button" class="btn-icon btn-cancel" title="Cancel Plan">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No plans yet. Start by adding one!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Plan Modal -->
<div id="planModal" class="planner-modal">
    <div class="planner-modal-content">
        <span class="planner-close-modal" onclick="closeModal()">&times;</span>
        <div class="planner-modal-header">
            <h3>Plan Detail</h3>
        </div>
        <form id="planForm">
            <input type="hidden" id="plan-id">
            <div class="planner-form-group">
                <label for="meeting_number">Meeting</label>
                <select id="meeting_number" class="planner-form-control" required>
                    <option value="">Select Meeting</option>
                    {% for meeting in meetings %}
                    <option value="{{ meeting.Meeting_Number }}">#{{ meeting.Meeting_Number }} &nbsp; {{
                        meeting.Meeting_Date.strftime('%b %d, %Y') if meeting.Meeting_Date else 'N/A' }}</option>
                    {% endfor %}
                </select>
                <div id="meeting-date-row" class="meeting-info-row" style="display: none;">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="meeting-date-display"></span>
                </div>
            </div>
            <div class="planner-form-group">
                <label for="meeting_role_id">Meeting Role</label>
                <select id="meeting_role_id" class="planner-form-control" required>
                    <option value="">Select Role</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div id="project-checkbox-group" class="planner-form-group" style="display: none; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    Project <input type="checkbox" id="has_project_chk">
                </label>
            </div>
            <div id="project-group" class="planner-form-group" style="display: none;">
                <select id="project_id" class="planner-form-control">
                    <option value="">Select Project</option>
                    {% for level, projs in grouped_projects %}
                    <optgroup label="Level {{ level }}">
                        {% for project in projs %}
                        <option value="{{ project.id }}" data-format="{{ project.Format }}"
                            data-code="{{ project.full_code }}"
                            class="{% if project.is_completed %}project-completed{% endif %}">
                            {% if project.is_completed %}✓ {% endif %}{{ project.Project_Name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="planner-form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" class="planner-form-control" rows="3"></textarea>
            </div>
            <div class="planner-modal-footer">
                <button type="button" class="planner-btn planner-btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" id="book-btn" class="planner-btn planner-btn-success" style="display: none;"
                    onclick="bookPlan()">Book</button>
                <button type="submit" class="planner-btn planner-btn-primary">Save Draft</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('planModal');
    const form = document.getElementById('planForm');
    const addBtn = document.getElementById('add-plan-btn');
    const meetingSelect = document.getElementById('meeting_number');
    const roleSelect = document.getElementById('meeting_role_id');
    const projectGroup = document.getElementById('project-group');
    const projectIdSelect = document.getElementById('project_id');
    const dateDisplay = document.getElementById('meeting-date-display');
    const dateRow = document.getElementById('meeting-date-row');
    const projectChkGroup = document.getElementById('project-checkbox-group');
    const projectChk = document.getElementById('has_project_chk');
    const bookBtn = document.getElementById('book-btn');

    let currentMeetingRoles = [];

    addBtn.onclick = () => {
        form.reset();
        document.getElementById('plan-id').value = '';
        projectGroup.style.display = 'none';
        projectChkGroup.style.display = 'none';
        projectChk.checked = false;
        dateRow.style.display = 'none';
        bookBtn.style.display = 'none';
        roleSelect.innerHTML = '<option value="">Select Role</option>';
        modal.style.display = 'flex';
    };

    function closeModal() {
        modal.style.display = 'none';
    }

    class CustomSelect {
        constructor(selectId, options = {}) {
            this.select = document.getElementById(selectId);
            this.options = options;
            this.container = document.createElement('div');
            this.container.className = 'custom-select-container';
            this.trigger = document.createElement('div');
            this.trigger.className = 'custom-select-trigger';
            this.optionsList = document.createElement('div');
            this.optionsList.className = 'custom-select-options';

            this.setup();
        }

        setup() {
            this.select.hide = true;
            this.select.style.display = 'none';
            this.select.parentNode.insertBefore(this.container, this.select.nextSibling);
            this.container.appendChild(this.trigger);
            this.container.appendChild(this.optionsList);

            this.updateTrigger();
            this.renderOptions();

            this.trigger.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-select-container').forEach(c => {
                    if (c !== this.container) c.classList.remove('open');
                });
                this.container.classList.toggle('open');
            };

            document.addEventListener('click', () => {
                this.container.classList.remove('open');
            });
        }

        updateTrigger() {
            const selectedOpt = this.select.options[this.select.selectedIndex];
            this.trigger.innerText = selectedOpt ? selectedOpt.text : 'Select...';
        }

        renderOptions() {
            this.optionsList.innerHTML = '';

            const groups = this.select.getElementsByTagName('optgroup');
            if (groups.length > 0) {
                Array.from(groups).forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'custom-option-group';
                    groupDiv.innerText = group.label;
                    groupDiv.dataset.groupLabel = group.label;
                    this.optionsList.appendChild(groupDiv);

                    Array.from(group.getElementsByTagName('option')).forEach(opt => {
                        this.createOption(opt);
                    });
                });
            } else {
                Array.from(this.select.options).forEach(opt => {
                    this.createOption(opt);
                });
            }
        }

        createOption(opt) {
            const optDiv = document.createElement('div');
            optDiv.className = 'custom-option';
            if (opt.className) optDiv.className += ' ' + opt.className;
            if (opt.selected) optDiv.className += ' selected';

            // Check for data-code to bold it
            const code = opt.dataset.code;
            if (code) {
                const checkmark = opt.text.startsWith('✓ ') ? '✓ ' : '';
                const name = opt.text.replace('✓ ', '');
                optDiv.innerHTML = `${checkmark}<span class="project-code">${code}</span> ${name}`;
            } else {
                optDiv.innerText = opt.text;
            }

            optDiv.dataset.value = opt.value;

            optDiv.onclick = () => {
                this.select.value = opt.value;
                this.select.dispatchEvent(new Event('change'));
                this.updateTrigger();
                this.container.classList.remove('open');
                this.renderOptions(); // Update selected state
            };

            this.optionsList.appendChild(optDiv);
        }

        refresh() {
            this.updateTrigger();
            this.renderOptions();
            this.updateVisibility();
        }

        updateVisibility() {
            const optDivs = this.optionsList.querySelectorAll('.custom-option');
            const groupDivs = this.optionsList.querySelectorAll('.custom-option-group');

            groupDivs.forEach(g => g.style.display = 'none');

            optDivs.forEach(div => {
                const originalOpt = Array.from(this.select.options).find(o => o.value == div.dataset.value);
                if (originalOpt) {
                    const isVisible = originalOpt.style.display !== 'none';
                    div.style.display = isVisible ? 'block' : 'none';

                    if (isVisible && originalOpt.parentElement.tagName === 'OPTGROUP') {
                        const groupLabel = originalOpt.parentElement.label;
                        const groupDiv = Array.from(groupDivs).find(g => g.dataset.groupLabel === groupLabel);
                        if (groupDiv) groupDiv.style.display = 'block';
                    }
                }
            });
        }

        setValue(val) {
            this.select.value = val;
            this.select.dispatchEvent(new Event('change'));
            this.refresh();
        }
    }

    const customMeetingSelect = new CustomSelect('meeting_number');
    const customRoleSelect = new CustomSelect('meeting_role_id');
    const customProjectSelect = new CustomSelect('project_id');

    async function loadMeetingRoles() {
        const meetingNumber = meetingSelect.value;
        customMeetingSelect.updateTrigger();

        if (!meetingNumber) {
            roleSelect.innerHTML = '<option value="">Select Role</option>';
            customRoleSelect.refresh();
            dateRow.style.display = 'none';
            bookBtn.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/meeting/${meetingNumber}`);
            const data = await response.json();

            dateDisplay.innerText = `Meeting Date: ${data.date}`;
            dateRow.style.display = 'flex';
            currentMeetingRoles = data.roles;

            roleSelect.innerHTML = '<option value="">Select Role</option>';
            data.roles.forEach(role => {
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.innerText = role.name;
                opt.dataset.validProject = role.valid_for_project;
                opt.dataset.sessionId = role.session_id;
                opt.dataset.available = role.is_available;
                roleSelect.appendChild(opt);
            });
            customRoleSelect.refresh();

            // After loading roles, if one is already selected (e.g. during edit), update Book button
            updateBookButtonVisibility();
        } catch (error) {
            console.error('Error fetching meeting info:', error);
        }
    }

    function updateBookButtonVisibility() {
        const selectedOpt = roleSelect.options[roleSelect.selectedIndex];
        if (selectedOpt && selectedOpt.value) {
            bookBtn.style.display = 'inline-block';
            bookBtn.innerText = 'Book'; // Always show 'Book' per user preference
        } else {
            bookBtn.style.display = 'none';
        }
    }

    meetingSelect.addEventListener('change', loadMeetingRoles);

    function updateProjectVisibility() {
        const selectedRole = currentMeetingRoles.find(r => r.id == roleSelect.value);
        if (selectedRole && selectedRole.valid_for_project) {
            projectChkGroup.style.display = 'block';

            if (projectChk.checked) {
                projectGroup.style.display = 'block';
                projectIdSelect.required = true;

                const expectedFormat = selectedRole.expected_format;
                let visibleCount = 0;
                let lastVisibleValue = '';

                // Filter projects by format
                Array.from(projectIdSelect.options).forEach(opt => {
                    if (opt.value === "") return;

                    const projectFormat = opt.dataset.format;
                    let isVisible = false;

                    if (expectedFormat) {
                        isVisible = (projectFormat === expectedFormat);
                    } else {
                        isVisible = true;
                    }

                    opt.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) {
                        visibleCount++;
                        lastVisibleValue = opt.value;
                    }
                });

                customProjectSelect.refresh();

                // Auto-selection logic: if only one project is visible, select it
                if (visibleCount === 1 && !projectIdSelect.value) {
                    customProjectSelect.setValue(lastVisibleValue);
                    projectIdSelect.dispatchEvent(new Event('change'));
                }
            } else {
                projectGroup.style.display = 'none';
                customProjectSelect.setValue('');
                projectIdSelect.required = false;
            }
        } else {
            projectChkGroup.style.display = 'none';
            projectGroup.style.display = 'none';
            projectChk.checked = false;
            customProjectSelect.setValue('');
            projectIdSelect.required = false;
        }
    }

    roleSelect.addEventListener('change', () => {
        projectChk.checked = false;
        updateProjectVisibility();
        updateBookButtonVisibility();
    });

    projectChk.addEventListener('change', updateProjectVisibility);

    form.addEventListener('submit', async (e) => {
        if (e) e.preventDefault();
        const planId = document.getElementById('plan-id').value;
        const data = {
            meeting_number: document.getElementById('meeting_number').value || null,
            meeting_role_id: document.getElementById('meeting_role_id').value || null,
            project_id: document.getElementById('project_id').value || null,
            notes: document.getElementById('notes').value,
            status: 'draft'
        };

        const method = planId ? 'PUT' : 'POST';
        const url = planId ? `/api/planner/${planId}` : '/api/planner';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                if (!e) return true; // Internal call from bookPlan
                location.reload();
            } else {
                alert('Failed to save draft');
                return false;
            }
        } catch (error) {
            console.error('Error:', error);
            return false;
        }
    });

    async function bookPlan() {
        const selectedOpt = roleSelect.options[roleSelect.selectedIndex];
        const sessionId = selectedOpt ? selectedOpt.dataset.sessionId : null;

        if (!sessionId) {
            alert('Cannot book: No session slot found for this role.');
            return;
        }

        // All bookings from planner join the waitlist first
        const action = 'join_waitlist';

        try {
            // 1. Perform Booking (Join Waitlist)
            const response = await fetch('/booking/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    action: action
                })
            });

            const result = await response.json();
            if (result.success) {
                // Planner status is always 'waitlist' after initial booking request
                const status = 'waitlist';

                // 2. Update Plan status and save
                const planId = document.getElementById('plan-id').value;
                const data = {
                    meeting_number: document.getElementById('meeting_number').value || null,
                    meeting_role_id: document.getElementById('meeting_role_id').value || null,
                    project_id: document.getElementById('project_id').value || null,
                    notes: document.getElementById('notes').value,
                    status: status
                };

                const method = planId ? 'PUT' : 'POST';
                const url = planId ? `/api/planner/${planId}` : '/api/planner';

                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                location.reload();
            } else {
                alert(result.message || 'Booking failed');
            }
        } catch (error) {
            console.error('Error during booking:', error);
            alert('An error occurred during booking');
        }
    }

    // Edit and Cancel event delegation
    document.addEventListener('click', async function(e) {
        const editBtn = e.target.closest('.btn-edit');
        const cancelBtn = e.target.closest('.btn-cancel');

        if (editBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const tr = editBtn.closest('tr');
            form.reset();

            const meetingNum = tr.dataset.meeting;
            const roleId = tr.dataset.role;
            const projectId = tr.dataset.project;

            document.getElementById('plan-id').value = tr.dataset.id;
            customMeetingSelect.setValue(meetingNum);
            document.getElementById('notes').value = tr.dataset.notes;

            // Trigger meeting change to load roles
            await loadMeetingRoles();
            customRoleSelect.setValue(roleId);

            // Set project checkbox based on existing project
            projectChk.checked = !!projectId;

            // Trigger role change logic
            updateProjectVisibility();
            customProjectSelect.setValue(projectId);

            modal.style.display = 'flex';
        }

        if (cancelBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const tr = cancelBtn.closest('tr');
            const id = tr.dataset.id;
            
            if (confirm('Are you sure you want to cancel this plan? This will also remove you from the meeting if you have already booked or joined the waitlist.')) {
                try {
                    const response = await fetch(`/api/planner/${id}/cancel`, { method: 'POST' });
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to cancel plan');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }
    });
</script>
{% endblock %}