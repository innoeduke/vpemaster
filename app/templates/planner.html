{% extends "base.html" %}
{% from "components/custom_select.html" import render_custom_select %}

{% block title %}Planner{% endblock %}

{% block header_title %}My Planner{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-desktop.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-ipad.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/planner/planner-mobile.css') }}">
{% endblock %}

{% block content %}
<div class="page-container">
    <h1><i class="fas fa-tasks"></i> Planner</h1>
    <div class="filters-control premium">
        <div class="filter-row-premium">
            <div class="filter-left">
                <form method="GET" action="{{ url_for('planner_bp.planner') }}" id="planner-term-filter-form" class="contacts-term-filter-form">
                    <div class="form-group">
                        <label class="filter-label">Club Term:</label>
                        <div class="custom-dropdown-container" id="term-dropdown-container">
                            <button type="button" id="term-dropdown-btn" class="form-control term-dropdown-btn" onclick="toggleTermDropdown(event)">
                                <span id="term-btn-text">
                                    {% if selected_term_ids %} {{ selected_term_ids|length }} selected
                                    {% else %} 0 selected {% endif %}
                                </span>
                                <i class="fas fa-caret-down"></i>
                            </button>
                            <div class="term-dropdown-menu" id="term-dropdown-menu" style="display: none;">
                                <label class="term-select-all-label">
                                    <input type="checkbox" id="term-select-all" class="term-checkbox-input" onchange="toggleAllTerms(this)">
                                    Select All
                                </label>
                                {% for term in terms %}
                                <label class="term-option-label">
                                    <input type="checkbox" name="term" value="{{ term.id }}" class="term-checkbox term-checkbox-input"
                                        data-label="{{ term.label }}" data-start="{{ term.start }}" data-end="{{ term.end }}"
                                        onchange="updateTermSelection()" {% if selected_term_ids and term.id in selected_term_ids %}checked{% endif %} />
                                    {{ term.label }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="filter-right">
                <button class="btn btn-success" id="add-plan-btn"><i class="fas fa-plus"></i> New Plan</button>
            </div>
        </div>
    </div>

    <div class="planner-table-container">
        <table class="planner-table">
            <thead>
                <tr>
                    <th>Meeting</th>
                    <th>Role</th>
                    <th>Project</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="planner-tbody">
                {% for plan in plans %}
                <tr data-id="{{ plan.id }}" data-meeting-id="{{ plan.meeting_id or '' }}"
                    data-meeting-number="{{ plan.meeting_number or '' }}"
                    data-role="{{ plan.meeting_role_id or '' }}" data-project="{{ plan.project_id or '' }}"
                    data-status="{{ plan.status }}" data-notes="{{ plan.notes or '' }}">
                    <td data-label="Meeting">#{{ plan.meeting_number or 'N/A' }}</td>
                    <td data-label="Role">{{ plan.role.name if plan.role else 'N/A' }}</td>
                    <td data-label="Project">
                        {% if plan.project %}
                            <span class="project-code-badge">{{ plan.project.get_code() }}</span> {{ plan.project.Project_Name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td data-label="Status">
                        <span class="status-badge status-{{ plan.status }}">
                            {{ plan.status|capitalize }}
                        </span>
                    </td>
                    <td data-label="Notes">{{ plan.notes or '' }}</td>
                    <td data-label="Actions">
                        <div class="action-btns">
                            <button class="btn-icon btn-edit" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if plan.status not in ['completed', 'cancelled', 'obsolete'] %}
                            <button type="button" class="btn-icon btn-cancel" title="Cancel Plan">
                                <i class="fas fa-times-circle"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td id="no-plans-message" colspan="6" style="text-align: center; ">No plans yet. Start by adding one!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% include 'partials/_planner_modal.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/custom_select.js') }}"></script>
<script src="{{ url_for('static', filename='js/planner_modal.js') }}"></script>
<script>
    // --- Term Filter Logic (Replicated from contacts page) ---
    function toggleTermDropdown(event) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        const menu = document.getElementById('term-dropdown-menu');
        if (menu) {
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
            } else {
                closeDropdownAndSubmit();
            }
        }
    }

    function toggleAllTerms(source) {
        const checkboxes = document.querySelectorAll('.term-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateTermSelection();
    }

    function updateTermSelection() {
        const checkboxes = document.querySelectorAll('.term-checkbox');
        const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
        const selectedCount = selectedCheckboxes.length;
        const totalCount = checkboxes.length;

        const btnText = document.getElementById('term-btn-text');
        if (!btnText) return;

        if (selectedCount === totalCount && totalCount > 0) {
            btnText.textContent = "All Terms";
        } else if (selectedCount === 0) {
            btnText.textContent = "0 selected";
        } else {
            const ranges = [];
            selectedCheckboxes.sort((a, b) => {
                const dateA = a.dataset.start || '';
                const dateB = b.dataset.start || '';
                return dateA.localeCompare(dateB);
            });

            if (selectedCheckboxes.length > 0) {
                let currentRange = {
                    startLabel: (selectedCheckboxes[0].dataset.label || '').split(' ')[1],
                    startYear: (selectedCheckboxes[0].dataset.label || '').split(' ')[0],
                    endLabel: (selectedCheckboxes[0].dataset.label || '').split(' ')[1],
                    endYear: (selectedCheckboxes[0].dataset.label || '').split(' ')[0],
                    fullStart: selectedCheckboxes[0].dataset.start,
                    fullEnd: selectedCheckboxes[0].dataset.end,
                    count: 1
                };

                for (let i = 1; i < selectedCheckboxes.length; i++) {
                    const next = selectedCheckboxes[i];
                    const prevEnd = new Date(currentRange.fullEnd);
                    const nextStart = new Date(next.dataset.start);
                    const diffTime = Math.abs(nextStart - prevEnd);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= 2) {
                        currentRange.endLabel = (next.dataset.label || '').split(' ')[1];
                        currentRange.endYear = (next.dataset.label || '').split(' ')[0];
                        currentRange.fullEnd = next.dataset.end;
                        currentRange.count++;
                    } else {
                        ranges.push(formatRange(currentRange));
                        currentRange = {
                            startLabel: (next.dataset.label || '').split(' ')[1],
                            startYear: (next.dataset.label || '').split(' ')[0],
                            endLabel: (next.dataset.label || '').split(' ')[1],
                            endYear: (next.dataset.label || '').split(' ')[0],
                            fullStart: next.dataset.start,
                            fullEnd: next.dataset.end,
                            count: 1
                        };
                    }
                }
                ranges.push(formatRange(currentRange));
            }
            btnText.textContent = ranges.join(', ');
        }

        function formatRange(range) {
            if (range.count === 1) return `${range.startYear} ${range.startLabel}`;
            const s = (range.startLabel || '').split('-')[0];
            const e = (range.endLabel || '').split('-')[1];
            return `${range.startYear} ${s} - ${range.endYear} ${e}`;
        }

        const selectAll = document.getElementById('term-select-all');
        if (selectAll) {
            selectAll.checked = (selectedCount === totalCount && totalCount > 0);
        }
    }

    function closeDropdownAndSubmit() {
        const menu = document.getElementById('term-dropdown-menu');
        if (menu) menu.style.display = 'none';
        const form = document.getElementById('planner-term-filter-form');
        if (form) form.submit();
    }

    // Initialize term selection display on load
    document.addEventListener('DOMContentLoaded', () => {
        updateTermSelection();
        
        // Close dropdown on click outside
        document.addEventListener('click', (event) => {
            const container = document.getElementById('term-dropdown-container');
            const menu = document.getElementById('term-dropdown-menu');
            if (menu && menu.style.display === 'block' && container && !container.contains(event.target)) {
                closeDropdownAndSubmit();
            }
        });

        // Prevent internal clicks from bubbling to document
        const termMenu = document.getElementById('term-dropdown-menu');
        if (termMenu) {
            termMenu.addEventListener('click', (e) => e.stopPropagation());
        }
    });


    // Event delegation for Edit/Cancel buttons in the table
    document.addEventListener('click', async function(e) {
        const editBtn = e.target.closest('.btn-edit');
        const cancelBtn = e.target.closest('.btn-cancel');

        if (editBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const tr = editBtn.closest('tr');
            const planData = {
                id: tr.dataset.id,
                meeting_id: tr.dataset.meetingId,
                meeting_number: tr.dataset.meetingNumber,
                role_id: tr.dataset.role,
                project_id: tr.dataset.project,
                notes: tr.dataset.notes,
                status: tr.dataset.status
            };
            
            if (typeof openPlanModal === 'function') {
                openPlanModal(planData);
            }
        }

        if (cancelBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const tr = cancelBtn.closest('tr');
            const id = tr.dataset.id;
            
            if (confirm('Are you sure you want to cancel this plan? This will also remove you from the meeting if you have already booked or joined the waitlist.')) {
                try {
                    const response = await fetch(`/api/planner/${id}/cancel`, { method: 'POST' });
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to cancel plan');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }
    });

    const addPlanBtn = document.getElementById('add-plan-btn');
    if (addPlanBtn) {
        addPlanBtn.onclick = () => {
            if (typeof openPlanModal === 'function') {
                openPlanModal();
            }
        };
    }
</script>
{% endblock %}