{% extends "base.html" %}

{% block title %}Project View{% endblock %}

{% block content %}
<div class="speech-logs-content project-view-container">
	<div class="speech-logs-toolbar">
		<div class="toolbar-spacer"></div>
		<div class="view-mode-toggle">
			<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member') }}" class="btn btn-info btn-sm">
				<i class="fas fa-user"></i> Member View
			</a>
			<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='admin') }}"
				class="btn btn-primary btn-sm">
				<i class="fas fa-users-cog"></i> Admin View
			</a>
		</div>
	</div>

	<form method="GET" action="{{ url_for('speech_logs_bp.show_project_view') }}" class="filters-container"
		id="speech-logs-filter-form">
		<div class="filter-row" style="align-items: center;">
			<div class="form-group" style="display: flex; align-items: center; margin-bottom: 0;">
				<label for="term-select"
					style="margin-right: 15px; font-weight: bold; font-size: 1.1em; white-space: nowrap;">Term:</label>
				<select name="term" id="term-select" onchange="this.form.submit()" class="form-control"
					style="font-size: 1.1em; flex: 1;">
					{% for term in terms %}
					<option value="{{ term.id }}" {% if current_term and current_term.id==term.id %}selected{% endif %}>
						{{ term.label }}
					</option>
					{% endfor %}
				</select>
			</div>
			<div class="form-group" style="display: flex; align-items: center; margin-bottom: 0;">
				<label for="pathway-select"
					style="margin-right: 15px; font-weight: bold; font-size: 1.1em; white-space: nowrap;">Pathway:</label>
				<select name="pathway" id="pathway-select" onchange="this.form.submit()" class="form-control"
					style="font-size: 1.1em; flex: 1;">
					<option value="">All Pathways</option>

					<optgroup label="Active">
						{% for p in active_pathways %}
						<option value="{{ p }}" {% if selected_pathway==p %}selected{% endif %}>
							{{ p }}
						</option>
						{% endfor %}
					</optgroup>

					{% if inactive_pathways %}
					<optgroup label="Inactive">
						{% for p in inactive_pathways %}
						<option value="{{ p }}" {% if selected_pathway==p %}selected{% endif %}>
							{{ p }}
						</option>
						{% endfor %}
					</optgroup>
					{% endif %}
				</select>
			</div>
		</div>
	</form>

	<div class="chart-container">
		<h3>Project Completion Metrics ({{ current_term.label }})</h3>

		{% if max_count > 0 %}
		<div class="chart-legend"
			style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
			{% for level in [1, 2, 3, 4, 5] %}
			<div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 0.9em;">
				<div class="legend-color level-{{ level }}"
					style="width: 12px; height: 12px; border-radius: 2px; background-color: var(--level-{{ level }}-color, #ccc);">
				</div>
				<span>Level {{ level }}</span>
			</div>
			{% endfor %}
			<div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 0.9em;">
				<div class="legend-color level-other"
					style="width: 12px; height: 12px; border-radius: 2px; background-color: #9013FE;"></div>
				<span>Other</span>
			</div>
		</div>

		<div class="projects-chart">
			{% for item in chart_data %}
			<div class="chart-row">
				<div class="project-label" title="{{ item.project_name }}">
					{{ item.project_name }}
				</div>
				<div class="bar-wrapper">
					<div class="stacked-bar-container" style="width: {{ (item.count / max_count) * 60 }}%;">
						{% for level in [1, 2, 3, 4, 5, 'Other'] %}
						{% set l_count = item.level_counts.get(level, 0) %}
						{% if l_count > 0 %}
						{% set l_pct = (l_count / item.count) * 100 %}
						<div class="bar-fill level-{{ level|lower }}" style="width: {{ l_pct }}%;"
							title="Level {{ level }}: {{ l_count }}">
							{% if l_pct > 12 %}
							<span class="bar-count">{{ l_count }}</span>
							{% endif %}
						</div>
						{% endif %}
						{% endfor %}
					</div>

					<div class="total-count"
						style="font-weight: bold; margin-left: 10px; margin-right: 15px; min-width: 20px; text-align: right; color: #4a5568;">
						{{ item.count }}
					</div>

					<div class="avatar-stack">
						{% for contact in item.owners %}
						<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member', speaker_id=contact.id) }}"
							class="avatar-item" title="View {{ contact.Name }}'s logs">
							{% if contact.Avatar_URL %}
							<img src="{{ url_for('static', filename=contact.Avatar_URL) }}" alt="{{ contact.Name }}"
								class="avatar-img"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
							<div class="avatar-placeholder-small" style="display: none;">{{ contact.Name[0] }}</div>
							{% else %}
							<div class="avatar-placeholder-small">{{ contact.Name[0] }}</div>
							{% endif %}
						</a>
						{% endfor %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="no-logs-message">No project completions found for this term.</p>
		{% endif %}
	</div>
</div>
{% endblock %}