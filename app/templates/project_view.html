{% extends "speech_logs.html" %}

{% block speech_view_title %}Project View{% endblock %}

{% block content_class %}project-view-container{% endblock %}

{% block speech_log_toolbar %}
	<form method="GET" action="{{ url_for('speech_logs_bp.show_project_view') }}" class="filters-container"
		id="speech-logs-filter-form">
		<div class="filter-row-premium">
			<div class="filters-set">
				<div class="form-group filter-group-premium flex-1">
					<label for="term" class="label-premium label-filter">Club Terms:</label>
					<select name="term" id="term" multiple>
						{% for term in terms %}
						<option value="{{ term.id }}" {% if selected_term_ids and term.id in selected_term_ids %}selected{% endif %}>
							{{ term.label }}
						</option>
						{% endfor %}
					</select>
				</div>
				<div class="form-group filter-group-premium flex-1">
					<label for="pathway" class="label-premium label-filter">Pathways:</label>
					<select name="pathway" id="pathway" onchange="this.form.submit()">
						<option value="" {% if not selected_pathway %}selected{% endif %}>All Pathways</option>
						
						<optgroup label="Active">
							{% for p in active_pathways %}
							<option value="{{ p }}" {% if selected_pathway == p %}selected{% endif %}>{{ p }}</option>
							{% endfor %}
						</optgroup>

						{% if inactive_pathways %}
						<optgroup label="Legacy">
							{% for p in inactive_pathways %}
							<option value="{{ p }}" {% if selected_pathway == p %}selected{% endif %}>{{ p }}</option>
							{% endfor %}
						</optgroup>
						{% endif %}
					</select>
				</div>
			</div>
			<div class="view-mode-toggle">
				<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member') }}" class="btn-view-control btn-member-view">
					<i class="fas fa-user-circle"></i> Member
				</a>
				<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='admin') }}"
					class="btn-view-control btn-meeting-view">
					<i class="fas fa-users"></i> Meeting
				</a>
				<a href="{{ url_for('speech_logs_bp.show_project_view') }}" class="btn-view-control btn-project-view active" onclick="return false;">
					<i class="fas fa-chart-line"></i> Project
				</a>
			</div>
		</div>
	</form>
{% endblock %}

{% block speech_log_main %}
	<div class="chart-container">
 		<h3 id="project-metrics-header">Project Completion Metrics 
 			{% if terms and selected_term_ids %}
 				{% set selected_count = selected_term_ids|length %}
 				{% if selected_count == terms|length %}
 					(All Terms)
 				{% else %}
 					<span id="header-term-text">({% for tid in selected_term_ids %}{% for term in terms %}{% if term.id == tid %}{{ term.label }}{% endif %}{% endfor %}{% if not loop.last %}, {% endif %}{% endfor %})</span>
 				{% endif %}
 			{% endif %}
         </h3>

		{% if max_count > 0 %}
		<div class="chart-legend-premium">
			{% for level in [1, 2, 3, 4, 5] %}
			<div class="legend-item-premium">
				<div class="legend-color level-{{ level }} legend-box"
					style="background-color: var(--level-{{ level }}-color, #ccc);">
				</div>
				<span>Level {{ level }}</span>
			</div>
			{% endfor %}

		</div>

		<div class="projects-chart">
			{% for item in chart_data %}
			<div class="chart-row">
				<div class="project-label" title="{{ item.project_name }}">
					{{ item.project_name }}
				</div>
				<div class="bar-wrapper">
					<div class="stacked-bar-container" style="width: {{ (item.count / max_count) * 60 }}%;">
						{% for level in [1, 2, 3, 4, 5, 'Other'] %}
						{% set l_count = item.level_counts.get(level, 0) %}
						{% if l_count > 0 %}
						{% set l_pct = (l_count / item.count) * 100 %}
						<div class="bar-fill level-{{ level|lower }}" style="width: {{ l_pct }}%;"
							title="Level {{ level }}: {{ l_count }}">
							{% if l_pct > 12 %}
							<span class="bar-count">{{ l_count }}</span>
							{% endif %}
						</div>
						{% endif %}
						{% endfor %}
					</div>

					<div class="total-count-label">
						{{ item.count }}
					</div>

					<div class="avatar-stack">
						{% for contact in item.owners %}
						<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member', speaker_id=contact.id) }}"
							class="avatar-item" title="View {{ contact.Name }}'s logs">
							{% if contact.Avatar_URL %}
							{# Check if the URL is already a full path (legacy) or just a filename (new) #}
							{% set avatar_path = contact.Avatar_URL %}
							{% if '/' not in avatar_path %}
								{% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
							{% endif %}
							<img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ contact.Name }}"
								class="avatar-img"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
							<div class="avatar-placeholder-small display-none">{{ contact.Name[0] }}</div>
							{% else %}
							<div class="avatar-placeholder-small">{{ contact.Name[0] }}</div>
							{% endif %}
						</a>
						{% endfor %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="no-logs-message">No project completions found for this term.</p>
		{% endif %}
	</div>
{% endblock %}

{% block speech_log_scripts %}
 {{ super() }}
 <script src="{{ url_for('static', filename='js/components/custom_select_adapter.js') }}"></script>
 <script>
     document.addEventListener('DOMContentLoaded', function() {
         const tSelect = document.getElementById('term');
         const pSelect = document.getElementById('pathway');
         const form = document.getElementById('speech-logs-filter-form');

         if (tSelect) {
             const tAdapter = new CustomSelectAdapter(tSelect);
             const originalClose = tAdapter.close.bind(tAdapter);
             tAdapter.close = function() {
                 const wasOpen = this.isOpen;
                 originalClose();
                 if (wasOpen) form.submit();
             };
         }
         
         if (pSelect) {
             new CustomSelectAdapter(pSelect);
         }
     });
 </script>
{% endblock %}