{% extends "base.html" %}

{% block title %}Project View{% endblock %}

{% block content %}
<div class="speech-logs-content project-view-container">
	<div class="speech-logs-toolbar">
		<div class="toolbar-spacer"></div>
		<div class="view-mode-toggle">
			<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member') }}" class="btn btn-info btn-sm">
				<i class="fas fa-user"></i> Member View
			</a>
			<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='admin') }}"
				class="btn btn-primary btn-sm">
				<i class="fas fa-users-cog"></i> Admin View
			</a>
		</div>
	</div>

	<form method="GET" action="{{ url_for('speech_logs_bp.show_project_view') }}" class="filters-container"
		id="speech-logs-filter-form">
		<div class="filter-row" style="align-items: center;">
 			<div class="form-group" style="display: flex; align-items: center; margin-bottom: 0; flex: 1;">
 				<label for="term-select"
 					style="margin-right: 15px; font-weight: bold; font-size: 1.1em; white-space: nowrap;">Club Terms:</label>
 				
 				<div class="custom-dropdown" id="term-dropdown-container" style="position: relative; flex: 1;">
 					<button type="button" id="term-dropdown-btn" class="form-control" style="text-align: left; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; height: auto; padding: 6px 12px; font-size: 1.1em;" onclick="toggleTermDropdown(event)">
 						<span id="term-btn-text">
 							{% if selected_term_ids %}
 								{{ selected_term_ids|length }} selected
 							{% else %}
 								0 selected
 							{% endif %}
 						</span>
 						<i class="fas fa-caret-down"></i>
 					</button>
 					
 					<div id="term-dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; border-radius: 4px; max-height: 400px; overflow-y: auto; z-index: 1000; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
 						
 						<label style="display: block; padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; margin-bottom: 5px; font-size: 0.9em;">
 							<input type="checkbox" id="term-select-all" onchange="toggleAllTerms(this)" style="margin-right: 8px; vertical-align: middle;" {% if terms and selected_term_ids|length == terms|length %}checked{% endif %}> 
 							Select / Deselect All
 						</label>
 						
 						{% for term in terms %}
 						<label style="display: block; padding: 5px 10px; cursor: pointer; font-weight: normal; margin-bottom: 0; font-size: 0.9em;">
 							<input type="checkbox" name="term" value="{{ term.id }}" class="term-checkbox" 
 								   data-label="{{ term.label }}" data-start="{{ term.start }}" data-end="{{ term.end }}"
 								   onchange="updateTermSelection()" {% if selected_term_ids and term.id in selected_term_ids %}checked{% endif %} style="margin-right: 8px; vertical-align: middle;">
 							{{ term.label }}
 						</label>
 						{% endfor %}
 					</div>
 				</div>
 			</div>
			<div class="form-group" style="display: flex; align-items: center; margin-bottom: 0;">
				<label for="pathway-select"
					style="margin-right: 15px; font-weight: bold; font-size: 1.1em; white-space: nowrap;">Pathway:</label>
				<select name="pathway" id="pathway-select" onchange="this.form.submit()" class="form-control"
					style="font-size: 1.1em; flex: 1;">
					<option value="">All Pathways</option>

					<optgroup label="Active">
						{% for p in active_pathways %}
						<option value="{{ p }}" {% if selected_pathway==p %}selected{% endif %}>
							{{ p }}
						</option>
						{% endfor %}
					</optgroup>

					{% if inactive_pathways %}
					<optgroup label="Inactive">
						{% for p in inactive_pathways %}
						<option value="{{ p }}" {% if selected_pathway==p %}selected{% endif %}>
							{{ p }}
						</option>
						{% endfor %}
					</optgroup>
					{% endif %}
				</select>
			</div>
		</div>
	</form>

	<div class="chart-container">
 		<h3 id="project-metrics-header">Project Completion Metrics 
 			{% if terms and selected_term_ids %}
 				{% set selected_count = selected_term_ids|length %}
 				{% if selected_count == terms|length %}
 					(All Terms)
 				{% else %}
 					<span id="header-term-text">({% for tid in selected_term_ids %}{% for term in terms %}{% if term.id == tid %}{{ term.label }}{% endif %}{% endfor %}{% if not loop.last %}, {% endif %}{% endfor %})</span>
 				{% endif %}
 			{% endif %}
         </h3>

		{% if max_count > 0 %}
		<div class="chart-legend"
			style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
			{% for level in [1, 2, 3, 4, 5] %}
			<div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 0.9em;">
				<div class="legend-color level-{{ level }}"
					style="width: 12px; height: 12px; border-radius: 2px; background-color: var(--level-{{ level }}-color, #ccc);">
				</div>
				<span>Level {{ level }}</span>
			</div>
			{% endfor %}
			<div class="legend-item" style="display: flex; align-items: center; gap: 6px; font-size: 0.9em;">
				<div class="legend-color level-other"
					style="width: 12px; height: 12px; border-radius: 2px; background-color: #9013FE;"></div>
				<span>Other</span>
			</div>
		</div>

		<div class="projects-chart">
			{% for item in chart_data %}
			<div class="chart-row">
				<div class="project-label" title="{{ item.project_name }}">
					{{ item.project_name }}
				</div>
				<div class="bar-wrapper">
					<div class="stacked-bar-container" style="width: {{ (item.count / max_count) * 60 }}%;">
						{% for level in [1, 2, 3, 4, 5, 'Other'] %}
						{% set l_count = item.level_counts.get(level, 0) %}
						{% if l_count > 0 %}
						{% set l_pct = (l_count / item.count) * 100 %}
						<div class="bar-fill level-{{ level|lower }}" style="width: {{ l_pct }}%;"
							title="Level {{ level }}: {{ l_count }}">
							{% if l_pct > 12 %}
							<span class="bar-count">{{ l_count }}</span>
							{% endif %}
						</div>
						{% endif %}
						{% endfor %}
					</div>

					<div class="total-count"
						style="font-weight: bold; margin-left: 10px; margin-right: 15px; min-width: 20px; text-align: right; color: #4a5568;">
						{{ item.count }}
					</div>

					<div class="avatar-stack">
						{% for contact in item.owners %}
						<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member', speaker_id=contact.id) }}"
							class="avatar-item" title="View {{ contact.Name }}'s logs">
							{% if contact.Avatar_URL %}
							{# Check if the URL is already a full path (legacy) or just a filename (new) #}
							{% set avatar_path = contact.Avatar_URL %}
							{% if '/' not in avatar_path %}
								{% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
							{% endif %}
							<img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ contact.Name }}"
								class="avatar-img"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
							<div class="avatar-placeholder-small" style="display: none;">{{ contact.Name[0] }}</div>
							{% else %}
							<div class="avatar-placeholder-small">{{ contact.Name[0] }}</div>
							{% endif %}
						</a>
						{% endfor %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="no-logs-message">No project completions found for this term.</p>
		{% endif %}
	</div>
</div>
 
 <script>
     // Initialize state on load
     document.addEventListener('DOMContentLoaded', function() {
         updateTermSelection(true); 
     });
 
     function toggleTermDropdown(event) {
         event.stopPropagation();
         event.preventDefault(); 
         const menu = document.getElementById('term-dropdown-menu');
         if (menu && menu.style.display === 'none') {
             menu.style.display = 'block';
         } else if (menu) {
             closeDropdownAndSubmit();
         }
     }
 
     function toggleAllTerms(source) {
         const checkboxes = document.querySelectorAll('.term-checkbox');
         checkboxes.forEach(cb => cb.checked = source.checked);
         updateTermSelection();
     }
 
     function updateTermSelection(isInitial = false) {
         const checkboxes = document.querySelectorAll('.term-checkbox');
         const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
         const selectedCount = selectedCheckboxes.length;
         const totalCount = checkboxes.length;
         
         // Update Count/Range Text
         const btnText = document.getElementById('term-btn-text');
         let displayStr = "";
         
         if (selectedCount === totalCount && totalCount > 0) {
             displayStr = "All Terms";
         } else if (selectedCount === 0) {
             displayStr = "0 selected";
         } else {
             // Logic to combine adjacent terms
             selectedCheckboxes.sort((a, b) => a.dataset.start.localeCompare(b.dataset.start));
             
             const ranges = [];
             if (selectedCheckboxes.length > 0) {
                 let currentRange = {
                     startLabel: selectedCheckboxes[0].dataset.label.split(' ')[1],
                     startYear: selectedCheckboxes[0].dataset.label.split(' ')[0],
                     endLabel: selectedCheckboxes[0].dataset.label.split(' ')[1],
                     endYear: selectedCheckboxes[0].dataset.label.split(' ')[0],
                     fullStart: selectedCheckboxes[0].dataset.start,
                     fullEnd: selectedCheckboxes[0].dataset.end,
                     count: 1
                 };
                 
                 for (let i = 1; i < selectedCheckboxes.length; i++) {
                     const next = selectedCheckboxes[i];
                     const prevEnd = new Date(currentRange.fullEnd);
                     const nextStart = new Date(next.dataset.start);
                     const diffDays = Math.ceil(Math.abs(nextStart - prevEnd) / (1000 * 60 * 60 * 24));
                     
                     if (diffDays <= 2) {
                         currentRange.endLabel = next.dataset.label.split(' ')[1];
                         currentRange.endYear = next.dataset.label.split(' ')[0];
                         currentRange.fullEnd = next.dataset.end;
                         currentRange.count++;
                     } else {
                         ranges.push(formatRange(currentRange));
                         currentRange = {
                             startLabel: next.dataset.label.split(' ')[1],
                             startYear: next.dataset.label.split(' ')[0],
                             endLabel: next.dataset.label.split(' ')[1],
                             endYear: next.dataset.label.split(' ')[0],
                             fullStart: next.dataset.start,
                             fullEnd: next.dataset.end,
                             count: 1
                         };
                     }
                 }
                 ranges.push(formatRange(currentRange));
             }
             displayStr = ranges.join(', ');
         }
         
         if (btnText) btnText.textContent = displayStr;
         
         // Also update header title if it's the initial load
         if (isInitial) {
             const header = document.getElementById('project-metrics-header');
             if (header) {
                 if (selectedCount === totalCount && totalCount > 0) {
                     header.innerHTML = `Project Completion Metrics (All Terms)`;
                 } else if (selectedCount > 0) {
                     header.innerHTML = `Project Completion Metrics (${displayStr})`;
                 }
             }
         }
 
         function formatRange(range) {
             if (range.count === 1) return `${range.startYear} ${range.startLabel}`;
             return `${range.startYear} ${range.startLabel.split('-')[0]} - ${range.endYear} ${range.endLabel.split('-')[1]}`;
         }
         
         const selectAll = document.getElementById('term-select-all');
         if (selectAll) {
             if (selectedCount === totalCount && totalCount > 0) {
                 selectAll.checked = true;
                 selectAll.indeterminate = false;
             } else if (selectedCount === 0) {
                 selectAll.checked = false;
                 selectAll.indeterminate = false;
             } else {
                 selectAll.checked = false;
             }
         }
     }
 
     function closeDropdownAndSubmit() {
         const menu = document.getElementById('term-dropdown-menu');
         if (menu) menu.style.display = 'none';
         document.getElementById('speech-logs-filter-form').submit();
     }
 
     document.addEventListener('click', function(event) {
         const container = document.getElementById('term-dropdown-container');
         const menu = document.getElementById('term-dropdown-menu');
         if (container && menu && menu.style.display === 'block' && !container.contains(event.target)) {
             closeDropdownAndSubmit();
         }
     });
     
     const menu = document.getElementById('term-dropdown-menu');
     if (menu) {
         menu.addEventListener('click', function(event) {
             event.stopPropagation();
         });
     }
 </script>
 {% endblock %}