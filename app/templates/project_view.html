{% extends "speech_logs.html" %}

{% block speech_view_title %}Project View{% endblock %}

{% block content_class %}project-view-container{% endblock %}

{% block speech_log_toolbar %}
	<form method="GET" action="{{ url_for('speech_logs_bp.show_project_view') }}" class="filters-container"
		id="speech-logs-filter-form">
		<div class="filter-row-premium">
			<div class="filters-set">
				<div class="form-group filter-group-premium">
					<label for="term-select" class="label-premium label-filter">Club Terms:</label>
					
					<div class="custom-dropdown relative-pos flex-1" id="term-dropdown-container">
						<button type="button" id="term-dropdown-btn" class="form-control dropdown-premium-btn" onclick="toggleTermDropdown(event)">
							<span id="term-btn-text">
								{% if selected_term_ids %}
									{{ selected_term_ids|length }} selected
								{% else %}
									0 selected
								{% endif %}
							</span>
							<i class="fas fa-caret-down"></i>
						</button>
						
						<div id="term-dropdown-menu" class="dropdown-premium-menu">
							
							<label class="dropdown-header-premium">
								<input type="checkbox" id="term-select-all" onchange="toggleAllTerms(this)" class="dropdown-checkbox" {% if terms and selected_term_ids|length == terms|length %}checked{% endif %}> 
								Select / Deselect All
							</label>
							
							{% for term in terms %}
							<label class="dropdown-item-label">
								<input type="checkbox" name="term" value="{{ term.id }}" class="term-checkbox dropdown-checkbox" 
									   data-label="{{ term.label }}" data-start="{{ term.start }}" data-end="{{ term.end }}"
									   onchange="updateTermSelection()" {% if selected_term_ids and term.id in selected_term_ids %}checked{% endif %}>
								{{ term.label }}
							</label>
							{% endfor %}
						</div>
					</div>
				</div>
				<div class="form-group filter-group-premium">
					<label for="pathway-input" class="label-premium label-filter">Pathways:</label>
					
					<div class="custom-dropdown relative-pos flex-1" id="pathway-dropdown-container">
						<input type="hidden" name="pathway" id="pathway-input" value="{{ selected_pathway }}">
						
						<button type="button" id="pathway-dropdown-btn" class="form-control dropdown-premium-btn" onclick="togglePathwayDropdown(event)">
							<span id="pathway-btn-text">
								{{ selected_pathway if selected_pathway else 'All Pathways' }}
							</span>
							<i class="fas fa-caret-down"></i>
						</button>
						
						<div id="pathway-dropdown-menu" class="dropdown-premium-menu">
							<div class="dropdown-item-label" onclick="selectPathway('')">
								<div class="flex-center-gap" style="gap: 8px;">
									<i class="fas fa-check" style="visibility: {{ 'visible' if not selected_pathway else 'hidden' }}; width: 12px;"></i>
									<span>All Pathways</span>
								</div>
							</div>
							
							<div class="dropdown-header-premium" style="cursor: default; background-color: #f7fafc; color: #718096; font-size: 0.75em;">Active</div>
							{% for p in active_pathways %}
							<div class="dropdown-item-label" onclick="selectPathway('{{ p }}')">
								<div class="flex-center-gap" style="gap: 8px;">
									<i class="fas fa-check" style="visibility: {{ 'visible' if selected_pathway == p else 'hidden' }}; width: 12px;"></i>
									<span>{{ p }}</span>
								</div>
							</div>
							{% endfor %}

							{% if inactive_pathways %}
							<div class="dropdown-header-premium" style="cursor: default; background-color: #f7fafc; color: #718096; font-size: 0.75em;">Legacy</div>
							{% for p in inactive_pathways %}
							<div class="dropdown-item-label" onclick="selectPathway('{{ p }}')">
								<div class="flex-center-gap" style="gap: 8px;">
									<i class="fas fa-check" style="visibility: {{ 'visible' if selected_pathway == p else 'hidden' }}; width: 12px;"></i>
									<span>{{ p }}</span>
								</div>
							</div>
							{% endfor %}
							{% endif %}
						</div>
					</div>
				</div>
			</div>
			<div class="view-mode-toggle">
				<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member') }}" class="btn-view-control btn-member-view">
					<i class="fas fa-user-circle"></i> Member
				</a>
				<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='admin') }}"
					class="btn-view-control btn-meeting-view">
					<i class="fas fa-users"></i> Meeting
				</a>
				<a href="{{ url_for('speech_logs_bp.show_project_view') }}" class="btn-view-control btn-project-view active" onclick="return false;">
					<i class="fas fa-chart-line"></i> Project
				</a>
			</div>
		</div>
	</form>
{% endblock %}

{% block speech_log_main %}
	<div class="chart-container">
 		<h3 id="project-metrics-header">Project Completion Metrics 
 			{% if terms and selected_term_ids %}
 				{% set selected_count = selected_term_ids|length %}
 				{% if selected_count == terms|length %}
 					(All Terms)
 				{% else %}
 					<span id="header-term-text">({% for tid in selected_term_ids %}{% for term in terms %}{% if term.id == tid %}{{ term.label }}{% endif %}{% endfor %}{% if not loop.last %}, {% endif %}{% endfor %})</span>
 				{% endif %}
 			{% endif %}
         </h3>

		{% if max_count > 0 %}
		<div class="chart-legend-premium">
			{% for level in [1, 2, 3, 4, 5] %}
			<div class="legend-item-premium">
				<div class="legend-color level-{{ level }} legend-box"
					style="background-color: var(--level-{{ level }}-color, #ccc);">
				</div>
				<span>Level {{ level }}</span>
			</div>
			{% endfor %}

		</div>

		<div class="projects-chart">
			{% for item in chart_data %}
			<div class="chart-row">
				<div class="project-label" title="{{ item.project_name }}">
					{{ item.project_name }}
				</div>
				<div class="bar-wrapper">
					<div class="stacked-bar-container" style="width: {{ (item.count / max_count) * 60 }}%;">
						{% for level in [1, 2, 3, 4, 5, 'Other'] %}
						{% set l_count = item.level_counts.get(level, 0) %}
						{% if l_count > 0 %}
						{% set l_pct = (l_count / item.count) * 100 %}
						<div class="bar-fill level-{{ level|lower }}" style="width: {{ l_pct }}%;"
							title="Level {{ level }}: {{ l_count }}">
							{% if l_pct > 12 %}
							<span class="bar-count">{{ l_count }}</span>
							{% endif %}
						</div>
						{% endif %}
						{% endfor %}
					</div>

					<div class="total-count-label">
						{{ item.count }}
					</div>

					<div class="avatar-stack">
						{% for contact in item.owners %}
						<a href="{{ url_for('speech_logs_bp.show_speech_logs', view_mode='member', speaker_id=contact.id) }}"
							class="avatar-item" title="View {{ contact.Name }}'s logs">
							{% if contact.Avatar_URL %}
							{# Check if the URL is already a full path (legacy) or just a filename (new) #}
							{% set avatar_path = contact.Avatar_URL %}
							{% if '/' not in avatar_path %}
								{% set avatar_path = config.AVATAR_ROOT_DIR ~ '/' ~ avatar_path %}
							{% endif %}
							<img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ contact.Name }}"
								class="avatar-img"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
							<div class="avatar-placeholder-small display-none">{{ contact.Name[0] }}</div>
							{% else %}
							<div class="avatar-placeholder-small">{{ contact.Name[0] }}</div>
							{% endif %}
						</a>
						{% endfor %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="no-logs-message">No project completions found for this term.</p>
		{% endif %}
	</div>
{% endblock %}

{% block speech_log_scripts %}
 {{ super() }}
 <script>
     // Initialize state on load
     document.addEventListener('DOMContentLoaded', function() {
         updateTermSelection(true); 
     });
 
     function toggleTermDropdown(event) {
         closePathwayDropdown();
         event.stopPropagation();
         event.preventDefault(); 
         const menu = document.getElementById('term-dropdown-menu');
         // Check if currently visible (assuming default is hidden)
         if (menu && menu.style.display !== 'block') {
             menu.style.display = 'block';
         } else if (menu) {
             closeDropdownAndSubmit();
         }
     }
     
     function togglePathwayDropdown(event) {
         if (typeof closeDropdownAndSubmit === 'function') {
             // Close term dropdown if open, but don't submit yet
             const termMenu = document.getElementById('term-dropdown-menu');
             if (termMenu) termMenu.style.display = 'none';
         }
         
         event.stopPropagation();
         event.preventDefault(); 
         const menu = document.getElementById('pathway-dropdown-menu');
         
         if (menu && menu.style.display !== 'block') {
             menu.style.display = 'block';
         } else if (menu) {
             menu.style.display = 'none';
         }
     }
     
     function selectPathway(value) {
         document.getElementById('pathway-input').value = value;
         document.getElementById('speech-logs-filter-form').submit();
     }
     
     function closePathwayDropdown() {
         const menu = document.getElementById('pathway-dropdown-menu');
         if (menu) menu.style.display = 'none';
     }

     function toggleAllTerms(source) {
         const checkboxes = document.querySelectorAll('.term-checkbox');
         checkboxes.forEach(cb => cb.checked = source.checked);
         updateTermSelection();
     }
 
     function updateTermSelection(isInitial = false) {
         const checkboxes = document.querySelectorAll('.term-checkbox');
         const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
         const selectedCount = selectedCheckboxes.length;
         const totalCount = checkboxes.length;
         
         // Update Count/Range Text
         const btnText = document.getElementById('term-btn-text');
         let displayStr = "";
         
         if (selectedCount === totalCount && totalCount > 0) {
             displayStr = "All Terms";
         } else if (selectedCount === 0) {
             displayStr = "0 selected";
         } else {
             // Logic to combine adjacent terms
             selectedCheckboxes.sort((a, b) => a.dataset.start.localeCompare(b.dataset.start));
             
             const ranges = [];
             if (selectedCheckboxes.length > 0) {
                 let currentRange = {
                     startLabel: selectedCheckboxes[0].dataset.label.split(' ')[1],
                     startYear: selectedCheckboxes[0].dataset.label.split(' ')[0],
                     endLabel: selectedCheckboxes[0].dataset.label.split(' ')[1],
                     endYear: selectedCheckboxes[0].dataset.label.split(' ')[0],
                     fullStart: selectedCheckboxes[0].dataset.start,
                     fullEnd: selectedCheckboxes[0].dataset.end,
                     count: 1
                 };
                 
                 for (let i = 1; i < selectedCheckboxes.length; i++) {
                     const next = selectedCheckboxes[i];
                     const prevEnd = new Date(currentRange.fullEnd);
                     const nextStart = new Date(next.dataset.start);
                     const diffDays = Math.ceil(Math.abs(nextStart - prevEnd) / (1000 * 60 * 60 * 24));
                     
                     if (diffDays <= 2) {
                         currentRange.endLabel = next.dataset.label.split(' ')[1];
                         currentRange.endYear = next.dataset.label.split(' ')[0];
                         currentRange.fullEnd = next.dataset.end;
                         currentRange.count++;
                     } else {
                         ranges.push(formatRange(currentRange));
                         currentRange = {
                             startLabel: next.dataset.label.split(' ')[1],
                             startYear: next.dataset.label.split(' ')[0],
                             endLabel: next.dataset.label.split(' ')[1],
                             endYear: next.dataset.label.split(' ')[0],
                             fullStart: next.dataset.start,
                             fullEnd: next.dataset.end,
                             count: 1
                         };
                     }
                 }
                 ranges.push(formatRange(currentRange));
             }
             displayStr = ranges.join(', ');
         }
         
         if (btnText) btnText.textContent = displayStr;
         
         // Also update header title if it's the initial load
         if (isInitial) {
             const header = document.getElementById('project-metrics-header');
             if (header) {
                 if (selectedCount === totalCount && totalCount > 0) {
                     header.innerHTML = `Project Completion Metrics (All Terms)`;
                 } else if (selectedCount > 0) {
                     header.innerHTML = `Project Completion Metrics (${displayStr})`;
                 }
             }
         }
 
         function formatRange(range) {
             if (range.count === 1) return `${range.startYear} ${range.startLabel}`;
             return `${range.startYear} ${range.startLabel.split('-')[0]} - ${range.endYear} ${range.endLabel.split('-')[1]}`;
         }
         
         const selectAll = document.getElementById('term-select-all');
         if (selectAll) {
             if (selectedCount === totalCount && totalCount > 0) {
                 selectAll.checked = true;
                 selectAll.indeterminate = false;
             } else if (selectedCount === 0) {
                 selectAll.checked = false;
                 selectAll.indeterminate = false;
             } else {
                 selectAll.checked = false;
                 selectAll.indeterminate = true;
             }
         }
     }
 
     function closeDropdownAndSubmit() {
         const menu = document.getElementById('term-dropdown-menu');
         if (menu) menu.style.display = 'none';
         document.getElementById('speech-logs-filter-form').submit();
     }
 
     document.addEventListener('click', function(event) {
         const termContainer = document.getElementById('term-dropdown-container');
         const termMenu = document.getElementById('term-dropdown-menu');
         
         if (termContainer && termMenu && termMenu.style.display === 'block' && !termContainer.contains(event.target)) {
             closeDropdownAndSubmit();
         }
         
         const pathwayContainer = document.getElementById('pathway-dropdown-container');
         const pathwayMenu = document.getElementById('pathway-dropdown-menu');
         
         if (pathwayContainer && pathwayMenu && pathwayMenu.style.display === 'block' && !pathwayContainer.contains(event.target)) {
             closePathwayDropdown();
         }
     });
     
     const termMenu = document.getElementById('term-dropdown-menu');
     if (termMenu) {
         termMenu.addEventListener('click', function(event) {
             event.stopPropagation();
         });
     }
 </script>
{% endblock %}