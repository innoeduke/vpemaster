{% extends "base.html" %}

{% block title %}About Club{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .about-club-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .about-club-container h1 {
        color: #004165;
        margin-bottom: 25px;
        font-weight: 700;
    }

    .form-table input.form-control,
    .form-table textarea.form-control,
    .form-table select.form-control {
        width: 100% !important;
        box-sizing: border-box !important;
        max-width: 100%;
        padding: 6px 8px;
    }

    /* Specific fix for date and time inputs */
    .form-table input[type="date"].form-control,
    .form-table input[type="time"].form-control {
        padding: 4px 6px;
        height: 38px;
    }

    .form-table td {
        position: relative;
        vertical-align: middle;
    }

    /* Club Settings Grid Styles */
    .club-settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .club-settings-left {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    /* Force colspanned header to full width */
    .general-settings-table th[colspan="2"] {
        width: 100% !important;
        text-align: left;
    }

    /* Responsive Mobile View (<= 768px) */
    @media (max-width: 768px) {
        .club-settings-grid {
            grid-template-columns: 1fr;
        }

        .settings-header {
            flex-direction: row;
            /* Match desktop layout for title/buttons */
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .settings-header .button-group {
            width: auto;
            /* Don't force full width */
        }

        /* Simplify header look on mobile */
        .form-table thead {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .form-table thead tr {
            display: block;
            border: none !important;
            box-shadow: none !important;
            background: none !important;
        }

        .form-table thead th {
            display: block;
            background-color: transparent !important;
            padding: 0 !important;
            color: #004165;
            font-size: 1.1em;
            font-weight: 700;
            border: none !important;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .form-table tbody tr {
            display: flex;
            flex-direction: column;
        }

        .form-table td {
            width: 100% !important;
            border-bottom: none;
        }

        .form-table td:first-child {
            /*background-color: #fcfcfc;*/
            padding-bottom: 2px;
        }

        .form-table td:last-child {
            padding-top: 2px;
            border-bottom: 1px solid #dee2e6;
        }

        .autocomplete-dropdown {
            position: static !important;
            width: 100% !important;
        }

        /* Specific layout for Location & Org */
        #location-org-table tbody {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #location-org-table tr.row-inline {
            flex: 1 1 calc(33.33% - 10px);
            min-width: 80px;
        }

        #location-org-table tr.row-stack {
            flex: 1 1 100%;
        }

        /* Ensure consistent look for inline items */
        #location-org-table tr.row-inline td {
            padding: 8px !important;
        }
    }

    .website-link {
        font-family: 'Montserrat', sans-serif;
        text-decoration: none !important;
        color: #004165;
        font-weight: 600;
    }

    .website-link:hover {
        color: #772432;
    }

    .autocomplete-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        width: calc(100% - 2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="about-club-container">
    <div class="settings-header">
        <h1>About Our Club</h1>
        {% if is_authorized(Permissions.ABOUT_CLUB_EDIT) %}
        <div class="button-group">
            <button id="cancel-club-btn" class="btn btn-danger" style="display: none">Cancel</button>
            <button id="edit-club-btn" class="btn btn-primary">Edit</button>
        </div>
        {% endif %}
    </div>

    {% if club %}
    <div class="club-settings-grid" id="about-club-content">
        <!-- Left Column: 3 Tables Stacked -->
        <div class="club-settings-left">
            <!-- Basic Information -->
            <table id="club-settings-table" class="form-table general-settings-table">
                <thead>
                    <tr>
                        <th colspan="2">Basic Information</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="width: 40%;"><strong>Club Logo</strong></td>
                        <td>
                            <div id="club-logo-display">
                                {% if club.logo_url %}
                                <img id="current-club-logo" src="{{ url_for('static', filename=club.logo_url) }}" alt="Club Logo" style="max-height: 80px; border-radius: 4px;">
                                {% else %}
                                <span id="no-logo-text" class="text-muted">No logo</span>
                                <img id="current-club-logo" src="" alt="Club Logo" style="max-height: 80px; border-radius: 4px; display: none;">
                                {% endif %}
                            </div>
                            <div id="club-logo-edit" style="display: none; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="file" id="logo-upload-input" accept="image/*" class="form-control" style="width: auto; padding: 4px;">
                                    <button id="logo-upload-btn" class="btn btn-sm btn-primary" type="button" style="display: none;">Upload</button>
                                </div>
                                <small class="text-muted">Max size 500x500px, WebP/PNG/JPG</small>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 40%;"><strong>Club Number</strong></td>
                        <td data-field="club_no">{{ club.club_no }}</td>
                    </tr>
                    <tr>
                        <td><strong>Club Name</strong></td>
                        <td data-field="club_name">{{ club.club_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Short Name</strong></td>
                        <td data-field="short_name">{{ club.short_name or '' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Founded Date</strong></td>
                        <td data-field="founded_date">{{ club.founded_date.strftime('%Y-%m-%d') if club.founded_date
                            else '' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Website</strong></td>
                        <td data-field="website">
                            {% if club.website %}
                            <a href="{{ 'https://' ~ club.website if '://' not in club.website else club.website }}"
                                target="_blank" class="website-link">{{ club.website }}</a>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Meeting Information -->
            <table class="form-table general-settings-table">
                <thead>
                    <tr>
                        <th colspan="2">Meeting Information</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="width: 40%;"><strong>Meeting Date</strong></td>
                        <td data-field="meeting_date">{{ club.meeting_date or '' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Meeting Time</strong></td>
                        <td data-field="meeting_time">{{ club.meeting_time.strftime('%H:%M') if club.meeting_time else
                            '' }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- Location & Organization -->
            <table id="location-org-table" class="form-table general-settings-table">
                <thead>
                    <tr>
                        <th colspan="2">Location & Organization</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="row-inline">
                        <td style="width: 40%;"><strong>District</strong></td>
                        <td data-field="district">{{ club.district or '' }}</td>
                    </tr>
                    <tr class="row-inline">
                        <td><strong>Division</strong></td>
                        <td data-field="division">{{ club.division or '' }}</td>
                    </tr>
                    <tr class="row-inline">
                        <td><strong>Area</strong></td>
                        <td data-field="area">{{ club.area or '' }}</td>
                    </tr>
                    <tr class="row-stack">
                        <td><strong>Contact Phone Number</strong></td>
                        <td data-field="contact_phone_number">{{ club.contact_phone_number or '' }}</td>
                    </tr>
                    <tr class="row-stack">
                        <td><strong>Club Address</strong></td>
                        <td data-field="club_address" style="white-space: pre-line;">{{ club.club_address or '' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Right Column: Executive Committee -->
        <div>
            <table class="form-table general-settings-table">
                <thead>
                    <tr>
                        <th colspan="2">Executive Committee</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="width: 40%;"><strong>Team Name</strong></td>
                        <td data-field="excomm_name">{{ excomm_team.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Term</strong></td>
                        <td data-field="excomm_term">{{ excomm_team.term }}</td>
                    </tr>
                    {% for role, name in excomm_team.members.items() %}
                    <tr>
                        <td><span class="roster-role-tag role-officer" style="margin-bottom: 0;">{{ role }}</span></td>
                        <td data-field="excomm_{{ role.lower() }}" data-role="{{ role }}">{{ name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="no-settings-message"
        style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 4px;">
        No club information found.
    </div>
    {% endif %}
</div>

<script>
    var CONTACTS_DATA = {{ contacts_list | tojson }};

    document.addEventListener('DOMContentLoaded', function () {
        const editBtn = document.getElementById('edit-club-btn');
        const cancelBtn = document.getElementById('cancel-club-btn');
        const aboutContent = document.getElementById('about-club-content');
        let originalValues = {};
        let isEditing = false;

        if (editBtn) {
            editBtn.addEventListener('click', function () {
                if (!isEditing) {
                    enableEditing();
                } else {
                    saveChanges();
                }
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () { disableEditing(); });
        }

        // Logo Upload Logic
        const logoInput = document.getElementById('logo-upload-input');
        const logoBtn = document.getElementById('logo-upload-btn');
        const currentLogo = document.getElementById('current-club-logo');
        const noLogoText = document.getElementById('no-logo-text');

        if (logoInput) {
            logoInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        alert('File is too large. Max size is 5MB.');
                        this.value = ''; // Clear the input
                        logoBtn.style.display = 'none';
                        return;
                    }
                    logoBtn.style.display = 'inline-block';
                } else {
                    logoBtn.style.display = 'none';
                }
            });
        }

        if (logoBtn) {
            logoBtn.addEventListener('click', function() {
                if (!logoInput.files || logoInput.files.length === 0) return;

                const formData = new FormData();
                formData.append('logo', logoInput.files[0]);

                // Disable button and show spinner/text
                const originalText = logoBtn.textContent;
                logoBtn.textContent = 'Uploading...';
                logoBtn.disabled = true;

                fetch('{{ url_for("about_club_bp.upload_club_logo") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Update image
                        currentLogo.src = result.logo_url + '?t=' + new Date().getTime(); // force refresh
                        currentLogo.style.display = 'block';
                        if (noLogoText) noLogoText.style.display = 'none';
                        
                        // Reset input
                        logoInput.value = '';
                        logoBtn.style.display = 'none';
                        
                        // Show success message temporarily
                        const successMsg = document.createElement('span');
                        successMsg.textContent = ' Done!';
                        successMsg.style.color = 'green';
                        successMsg.style.marginLeft = '5px';
                        logoBtn.parentNode.appendChild(successMsg);
                        setTimeout(() => successMsg.remove(), 2000);
                    } else {
                        alert('Upload failed: ' + result.message);
                    }
                })
                .catch(err => {
                    console.error('Error uploading logo:', err);
                    alert('Error uploading logo');
                })
                .finally(() => {
                    logoBtn.textContent = originalText;
                    logoBtn.disabled = false;
                });
            });
        }

        function enableEditing() {
            isEditing = true;
            editBtn.textContent = 'Save';
            editBtn.classList.remove('btn-primary');
            editBtn.classList.add('btn-success');
            cancelBtn.style.display = 'inline-block';

            const logoEditDiv = document.getElementById('club-logo-edit');
            if (logoEditDiv) logoEditDiv.style.display = 'block';

            const cells = document.querySelectorAll('#about-club-content td[data-field]');
            cells.forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.textContent.trim();
                originalValues[field] = value;

                let input;
                if (field.startsWith('excomm_') && field !== 'excomm_name' && field !== 'excomm_term') {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.value = value;
                    input.setAttribute('autocomplete', 'off');
                    input.setAttribute('placeholder', 'Search member...');
                    input.setAttribute('data-field', field);

                    const dropdown = document.createElement('div');
                    dropdown.className = 'autocomplete-dropdown';

                    input.addEventListener('input', function (e) {
                        const searchTerm = e.target.value.toLowerCase();
                        dropdown.innerHTML = '';
                        if (searchTerm.length === 0) { dropdown.style.display = 'none'; return; }
                        const filtered = CONTACTS_DATA.filter(contact => contact.name.toLowerCase().includes(searchTerm)).slice(0, 5);
                        if (filtered.length === 0) { dropdown.style.display = 'none'; return; }
                        filtered.forEach(contact => {
                            const item = document.createElement('div');
                            item.textContent = contact.name;
                            item.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;';
                            item.addEventListener('mouseenter', () => item.style.backgroundColor = '#f0f0f0');
                            item.addEventListener('mouseleave', () => item.style.backgroundColor = 'white');
                            item.addEventListener('click', () => { input.value = contact.name; dropdown.style.display = 'none'; });
                            dropdown.appendChild(item);
                        });
                        dropdown.style.display = 'block';
                    });

                    document.addEventListener('click', function (e) {
                        if (!input.contains(e.target) && !dropdown.contains(e.target)) { dropdown.style.display = 'none'; }
                    });

                    cell.style.position = 'relative';
                    cell.textContent = '';
                    cell.appendChild(input);
                    cell.appendChild(dropdown);
                    return;
                } else if (field === 'club_address') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                    input.value = value;
                } else if (field === 'meeting_time') {
                    input = document.createElement('input');
                    input.type = 'time';
                    if (value && value.includes(':')) { input.value = value; }
                } else if (field === 'founded_date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    if (value) {
                        const parts = value.split('/');
                        if (parts.length === 3) {
                            const month = parts[0].padStart(2, '0');
                            const day = parts[1].padStart(2, '0');
                            const year = parts[2];
                            input.value = `${year}-${month}-${day}`;
                        } else if (value.includes('-')) { input.value = value; }
                    }
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = value;
                }

                input.className = 'form-control';
                input.setAttribute('data-field', field);
                cell.textContent = '';
                cell.appendChild(input);
            });
        }

        function disableEditing() {
            isEditing = false;
            editBtn.textContent = 'Edit';
            editBtn.classList.remove('btn-success');
            editBtn.classList.add('btn-primary');
            cancelBtn.style.display = 'none';

            const logoEditDiv = document.getElementById('club-logo-edit');
            if (logoEditDiv) logoEditDiv.style.display = 'none';

            const inputs = document.querySelectorAll('#about-club-content input[data-field], #about-club-content textarea[data-field]');
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const cell = input.parentElement;
                const dropdown = cell.querySelector('.autocomplete-dropdown');
                if (dropdown) dropdown.remove();
                cell.textContent = originalValues[field];
            });
            originalValues = {};
        }

        function saveChanges() {
            const inputs = document.querySelectorAll('#about-club-content input[data-field], #about-club-content textarea[data-field]');
            const data = {};
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                data[field] = input.value;
            });

            fetch('{{ url_for("about_club_bp.about_club_update") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        inputs.forEach(input => {
                            const cell = input.parentElement;
                            const field = input.getAttribute('data-field');
                            cell.textContent = input.value;
                            // For address, we need to respect pre-line style which cell.textContent will do
                            // but we ensure the style is there (it is in HTML template)
                        });
                        isEditing = false;
                        editBtn.textContent = 'Edit';
                        editBtn.classList.remove('btn-success');
                        editBtn.classList.add('btn-primary');
                        cancelBtn.style.display = 'none';

                        const logoEditDiv = document.getElementById('club-logo-edit');
                        if (logoEditDiv) logoEditDiv.style.display = 'none';

                        originalValues = {};
                        editBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => { editBtn.style.backgroundColor = ''; }, 1000);
                    } else { console.error('Error:', result.message); flash(result.message, 'danger'); }
                })
                .catch(error => { console.error('Error:', error); });
        }
    });
</script>
{% endblock %}