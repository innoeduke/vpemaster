{% extends "base.html" %}

{% block title %}Contacts{% endblock %}

{% block content %}
    <h1>Contacts</h1>
    <div class="action-bar" style="justify-content: center;">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by name..." class="search-box">
            <button id="clear-searchInput" class="clear-search-btn" style="display: none;">&times;</button>
        </div>
        <button class="btn btn-primary" onclick="openContactModal()" style="margin-left: 10px;">New Contact</button>
    </div>

    <table id="contactsTable">
        <thead>
            <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Club</th>
                <th>Type</th>
                <th>Working Path</th>
                <th>Next Project</th>
                <th>Completed Levels</th>
                <th>Date Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    {{ contact.Name }}
                    {% if contact.DTM %}
                        <sup class="dtm-superscript">DTM</sup>
                    {% endif %}
                </td>
                <td>{{ contact.Club }}</td>
                <td>{{ contact.Type }}</td>
                <td>{{ contact.Working_Path }}</td>
                <td>{{ contact.Next_Project }}</td>
                <td>{{ contact.Completed_Levels }}</td>
                <td>{{ contact.Date_Created.strftime('%Y-%m-%d') if contact.Date_Created else '' }}</td>
                <td>
                    <div class="action-links">
                        <button class="icon-btn" onclick="openContactModal({{ contact.id }})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('contacts_bp.delete_contact', contact_id=contact.id) }}', 'contact')" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% include '_contact_modal.html' %}

    <script>
        const contactModal = document.getElementById("contactModal");
        const contactForm = document.getElementById("contactForm");
        const contactModalTitle = document.getElementById("contactModalTitle");

        document.addEventListener('DOMContentLoaded', function() {
            setupSearch('searchInput', '#contactsTable', 'tbody tr', 'td:nth-child(2)');
        });

        function openContactModal(contactId) {
            contactForm.reset();
            if (contactId) {
                contactModalTitle.textContent = 'Edit Contact';
                contactForm.action = `/contact/form/${contactId}`;
                fetch(`/contact/form/${contactId}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('name').value = data.contact.Name || '';
                    document.getElementById('type').value = data.contact.Type || 'Member';
                    document.getElementById('club').value = data.contact.Club || '';
                    document.getElementById('working_path').value = data.contact.Working_Path || 'Presentation Mastery';
                    document.getElementById('next_project').value = data.contact.Next_Project || '';
                    document.getElementById('dtm').checked = data.contact.DTM;
                });
            } else {
                contactModalTitle.textContent = 'Add New Contact';
                contactForm.action = "{{ url_for('contacts_bp.contact_form') }}";
            }
            contactModal.style.display = "flex";
        }

        function closeContactModal() {
            contactModal.style.display = "none";
        }
    </script>
{% endblock %}