{% extends "base.html" %}

{% block title %}Contacts{% endblock %}

{% block content %}
    <h1>Contacts</h1>
    <div class="action-bar" style="justify-content: center;">
        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="searchContacts()" placeholder="Search by name..." class="search-box">
            <button id="clearSearchBtn" onclick="clearSearch()" style="display: none;">&times;</button>
        </div>
        <button class="btn btn-primary" onclick="openContactModal()" style="margin-left: 10px;">New Contact</button>
    </div>

    <table id="contactsTable">
        <thead>
            <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Club</th>
                <th>Type</th>
                <th>Working Path</th>
                <th>Next Project</th>
                <th>Completed Levels</th>
                <th>Date Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    {{ contact.Name }}
                    {% if contact.DTM %}
                        <sup class="dtm-superscript">DTM</sup>
                    {% endif %}
                </td>
                <td>{{ contact.Club }}</td>
                <td>{{ contact.Type }}</td>
                <td>{{ contact.Working_Path }}</td>
                <td>{{ contact.Next_Project }}</td>
                <td>{{ contact.Completed_Levels }}</td>
                <td>{{ contact.Date_Created.strftime('%Y-%m-%d') if contact.Date_Created else '' }}</td>
                <td>
                    <div class="action-links">
                        <button class="icon-btn" onclick="openContactModal({{ contact.id }})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn icon-btn" onclick="openDeleteModal({{ contact.id }})" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <p style="text-align: center;">Are you sure you want to delete this contact?</p>
            <form id="deleteForm" method="POST" action="">
                <div class="form-actions" style="justify-content: center;">
                    <button type="submit" class="btn btn-primary">Delete</button>
                    <button type="button" class="btn btn-danger" onclick="closeDeleteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% include '_contact_modal.html' %}

    <script>
        const deleteModal = document.getElementById("deleteModal");
        const deleteForm = document.getElementById("deleteForm");
        const contactModal = document.getElementById("contactModal");
        const contactForm = document.getElementById("contactForm");
        const contactModalTitle = document.getElementById("contactModalTitle");

        function openDeleteModal(contactId) {
            deleteForm.action = "/contact/delete/" + contactId;
            deleteModal.style.display = "flex";
        }

        function closeDeleteModal() {
            deleteModal.style.display = "none";
        }

        function openContactModal(contactId) {
            contactForm.reset();
            if (contactId) {
                contactModalTitle.textContent = 'Edit Contact';
                contactForm.action = `/contact/form/${contactId}`;
                fetch(`/contact/form/${contactId}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('name').value = data.contact.Name || '';
                    document.getElementById('type').value = data.contact.Type || 'Member';
                    document.getElementById('club').value = data.contact.Club || '';
                    document.getElementById('working_path').value = data.contact.Working_Path || 'Presentation Mastery';
                    document.getElementById('next_project').value = data.contact.Next_Project || '';
                    document.getElementById('dtm').checked = data.contact.DTM;
                });
            } else {
                contactModalTitle.textContent = 'Add New Contact';
                contactForm.action = "{{ url_for('contacts_bp.contact_form') }}";
            }
            contactModal.style.display = "flex";
        }

        function closeContactModal() {
            contactModal.style.display = "none";
        }

        function searchContacts() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('contactsTable');
            const tr = table.getElementsByTagName('tr');
            const clearBtn = document.getElementById('clearSearchBtn');

            if (input.value.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }

            for (let i = 1; i < tr.length; i++) { // Start from 1 to skip the header row
                const td = tr[i].getElementsByTagName('td')[1]; // The second column is the Name
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            searchContacts();
        }
    </script>
{% endblock %}