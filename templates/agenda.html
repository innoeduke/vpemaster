{% extends "base.html" %}

{% block title %}Meeting Agenda{% endblock %}

{% block content %}
    <h1>Meeting Agenda</h1>

    <div class="action-bar">
        <div class="inline-filter-group">
            <label for="meeting-filter">Meeting#:</label>
            <select id="meeting-filter">
                <option value="">All Meetings</option>
                {% for num in meeting_numbers %}
                <option value="{{ num }}" {% if num == selected_meeting %}selected{% endif %}>{{ num }}</option>
                {% endfor %}
            </select>
        </div>

        {% if session.get('user_role') in ['Admin', 'Officer'] %}
        <div class="button-group">
            <button id="cancel-edit-btn" class="btn btn-danger" style="display: none;">Cancel</button>
            <form id="load-form" action="{{ url_for('agenda_bp.load_csv') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="file" id="csv-file" style="display: none;" onchange="document.getElementById('load-form').submit()">
                <button id="load-btn" type="button" class="btn btn-primary" onclick="document.getElementById('csv-file').click()">Load</button>
            </form>
            <button id="export-btn" class="btn btn-primary">Save As</button>
            <button id="add-row-btn" class="btn btn-primary" style="display: none;">Add</button>
            <button id="edit-logs-btn" class="btn btn-success">Edit</button>
        </div>
        {% endif %}
    </div>

    <div class="table-container non-edit-mode" id="table-container">
        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th>No</th>
                    <th>Start Time</th>
                    <th>Session Type</th>
                    <th>Session Title</th>
                    <th>Owner</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr data-id="{{ log.SessionLog.id }}"
                    data-project_id="{{ log.SessionLog.Project_ID if log.SessionLog.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log.SessionLog.Meeting_Number }}"
                    data-is-section="{{ log.Is_Section|lower }}"
                    data-meeting_seq="{{ log.SessionLog.Meeting_Seq }}"
                    data-start_time="{{ log.SessionLog.Start_Time.strftime('%H:%M') if log.SessionLog.Start_Time is not none else '' }}"
                    data-session_title="{{ log.SessionLog.Session_Title if log.SessionLog.Session_Title is not none else '' }}"
                    data-type_id="{{ log.SessionLog.Type_ID }}"
                    data-owner_id="{{ log.SessionLog.Owner_ID }}"
                    data-duration_min="{{ log.SessionLog.Duration_Min if log.SessionLog.Duration_Min is not none else '' }}"
                    data-duration_max="{{ log.SessionLog.Duration_Max if log.SessionLog.Duration_Max is not none else '' }}"
                    class="{{ 'section-row' if log.Is_Section else '' }}">

                    {% if log.Is_Section %}
                        <td colspan="4" class="non-edit-mode-cell">
                            {{ log.session_type_title }}
                        </td>
                    {% else %}
                        <td class="non-edit-mode-cell">{{ log.SessionLog.Start_Time.strftime('%H:%M') if log.SessionLog.Start_Time is not none else '' }}</td>
                        <td class="non-edit-mode-cell">
                            {% if log.Is_Titleless %}
                                {{ log.session_type_title }}
                            {% else %}
                                {% if log.session_type_title == "Pathway Speech" %}
                                    {{ log.SessionLog.Session_Title }}
                                    {% set pathway_abbr = '' %}
                                    {% set pathway_code = '' %}
                                    {% if log.SessionLog.Owner_ID %}
                                        {% set contact = contacts|selectattr('id', 'equalto', log.SessionLog.Owner_ID)|first %}
                                        {% if contact and contact.Working_Path %}
                                            {% if contact.Working_Path == 'Dynamic Leadership' %}{% set pathway_abbr = 'DL' %}{% set pathway_code = log.Code_DL %}{% endif %}
                                            {% if contact.Working_Path == 'Engaging Humor' %}{% set pathway_abbr = 'EH' %}{% set pathway_code = log.Code_EH %}{% endif %}
                                            {% if contact.Working_Path == 'Motivational Strategies' %}{% set pathway_abbr = 'MS' %}{% set pathway_code = log.Code_MS %}{% endif %}
                                            {% if contact.Working_Path == 'Persuasive Influence' %}{% set pathway_abbr = 'PI' %}{% set pathway_code = log.Code_PI %}{% endif %}
                                            {% if contact.Working_Path == 'Presentation Mastery' %}{% set pathway_abbr = 'PM' %}{% set pathway_code = log.Code_PM %}{% endif %}
                                            {% if contact.Working_Path == 'Visionary Communication' %}{% set pathway_abbr = 'VC' %}{% set pathway_code = log.Code_VC %}{% endif %}
                                        {% endif %}
                                    {% endif %}
                                    ({{ pathway_abbr }}{{ pathway_code }})
                                {% elif log.session_type_title in ["Keynote Speech", "Panel Discussion", "Debate"] %}
                                    <i class="fas fa-award"></i> {{ log.SessionLog.Session_Title }}
                                {% elif log.session_type_title == 'Evaluation' %}
                                    Evaluation for {{ log.SessionLog.Session_Title }}
                                {% else %}
                                    {{ log.SessionLog.Session_Title }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% for contact in contacts %}
                                {% if contact.id == log.SessionLog.Owner_ID %}
                                    {{ contact.Name }}
                                    {% if contact.DTM %}
                                        <sup class="dtm-superscript">DTM</sup>
                                    {% endif %}
                                    <span class="owner-meta">
                                    {% if contact.Type == 'Guest' %}
                                        <br/>Guest
                                        {% if contact.Club %}
                                            @{{ contact.Club }}
                                        {% endif %}
                                    {% elif contact.Type == 'Member' and contact.Completed_Levels %}
                                        <br/>{{ contact.Completed_Levels }}
                                    {% endif %}
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% if log.SessionLog.Duration_Min and log.SessionLog.Duration_Max %}{{ log.SessionLog.Duration_Min }}'-{{ log.SessionLog.Duration_Max }}'
                            {% elif log.SessionLog.Duration_Max %}{{ log.SessionLog.Duration_Max }}'
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="projectModal" class="modal project-modal">
        <div class="modal-content">
            <span class="close" onclick="closeProjectModal()">&times;</span>
            <h2>Select a Project</h2>
            <div class="form-group">
                <label for="pathway-select">Pathway:</label>
                <select id="pathway-select">
                    <option value="Code_DL">Dynamic Leadership</option>
                    <option value="Code_EH">Engaging Humor</option>
                    <option value="Code_MS">Motivational Strategies</option>
                    <option value="Code_PI">Persuasive Influence</option>
                    <option value="Code_PM">Presentation Mastery</option>
                    <option value="Code_VC">Visionary Communication</option>
                </select>
            </div>
            <div class="form-group">
                <label for="level-select">Level:</label>
                <select id="level-select">
                    <option value="">All Levels</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div class="form-group">
                <label for="project-select">Project:</label>
                <select id="project-select">
                    <option value="">-- Select a Project --</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button onclick="closeProjectModal()" class="btn btn-danger">Cancel</button>
                <button onclick="saveProjectSelection()" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

<script>
    const sessionTypes = {{ session_types|tojson }};
    const contacts = {{ contacts|tojson }};
    const projects = {{ projects|tojson }};
    const editButton = document.getElementById('edit-logs-btn');
    const cancelButton = document.getElementById('cancel-edit-btn');
    const addRowButton = document.getElementById('add-row-btn');
    const loadButton = document.getElementById('load-btn');
    const meetingFilter = document.getElementById('meeting-filter');
    const exportButton = document.getElementById('export-btn')
    const projectModal = document.getElementById('projectModal');
    let isEditing = false;
    let activeRowForProject = null;

    // --- New functions for the Project Modal ---

    function openProjectModal(button) {
        activeRowForProject = button.closest('tr');
        projectModal.style.display = 'flex';

        const pathwayNameToCode = {
            "Dynamic Leadership": "Code_DL",
            "Engaging Humor": "Code_EH",
            "Motivational Strategies": "Code_MS",
            "Persuasive Influence": "Code_PI",
            "Presentation Mastery": "Code_PM",
            "Visionary Communication": "Code_VC"
        };

        const pathwaySelect = document.getElementById('pathway-select');
        const levelSelect = document.getElementById('level-select');

        // Reset selects to default
        pathwaySelect.value = "Code_DL";
        levelSelect.value = "";

        const ownerId = parseInt(activeRowForProject.querySelector('[data-field="Owner_ID"] select').value, 10);
        if (ownerId) {
            const contact = contacts.find(c => c.id === ownerId);
            if (contact) {
                // Pre-fill pathway
                if (contact.Working_Path && pathwayNameToCode[contact.Working_Path]) {
                    pathwaySelect.value = pathwayNameToCode[contact.Working_Path];
                }
                // Pre-fill level from Next_Project
                if (contact.Next_Project) {
                    const level = contact.Next_Project.split('.')[0];
                    if (level && !isNaN(level)) {
                        levelSelect.value = level;
                    }
                }
            }
        }

        filterModalProjects();
    }

    function closeProjectModal() {
        projectModal.style.display = 'none';
        activeRowForProject = null;
    }

    function filterModalProjects() {
        const pathwaySelect = document.getElementById('pathway-select');
        const levelSelect = document.getElementById('level-select');
        const projectSelect = document.getElementById('project-select');
        const selectedPathway = pathwaySelect.value;
        const selectedLevel = levelSelect.value;

        projectSelect.innerHTML = '<option value="">-- Select a Project --</option>';

        let filtered = projects.filter(p => p[selectedPathway]);

        if (selectedLevel) {
            filtered = filtered.filter(p => p[selectedPathway].startsWith(selectedLevel));
        }

        // Sort the filtered projects
        filtered.sort((a, b) => {
            const codeA = a[selectedPathway] || '';
            const codeB = b[selectedPathway] || '';
            const nameA = a.Project_Name || '';
            const nameB = b.Project_Name || '';

            const codeComparison = codeA.localeCompare(codeB, undefined, { numeric: true, sensitivity: 'base' });
            if (codeComparison !== 0) {
                return codeComparison;
            }
            return nameA.localeCompare(nameB, undefined, { sensitivity: 'base' });
        });

        filtered.forEach(p => {
            const option = new Option(`${p[selectedPathway]} - ${p.Project_Name}`, p.ID);
            projectSelect.add(option);
        });
    }

    function saveProjectSelection() {
        const projectSelect = document.getElementById('project-select');
        const selectedProjectId = projectSelect.value;
        if (selectedProjectId && activeRowForProject) {
            // Store the project ID in the row's dataset
            activeRowForProject.dataset.projectId = selectedProjectId;
        }
        closeProjectModal();
    }



    // This function now simply reloads the page with the new filter applied
    function applyMeetingFilter() {
        const selectedMeeting = meetingFilter.value;
        // Construct the new URL and navigate to it
        window.location.href = `/agenda?meeting_number=${selectedMeeting}`;
    }

    function createSessionTitleControl(typeId, originalValue) {
        const sessionType = sessionTypes.find(st => st.id === parseInt(typeId, 10));

        if (sessionType && sessionType.Title === 'Evaluation') {
            const select = document.createElement('select');
            select.options.add(new Option('-- Select Speaker --', ''));
            contacts.forEach(contact => {
                select.options.add(new Option(contact.Name, contact.Name));
            });

            /*if (originalValue && originalValue.startsWith('Evaluation for ')) {
                const speakerName = originalValue.replace('Evaluation for ', '');
                select.value = speakerName;
            }*/
            return select;
        } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            return input;
        }
    }

    function handleSectionChange(selectElement) {
        const selectedTypeId = parseInt(selectElement.value, 10);
        const sessionType = sessionTypes.find(st => st.id === selectedTypeId);
        const row = selectElement.closest('tr');
        const ownerCell = row.querySelector('[data-field="Owner_ID"] select');
        const minDurationCell = row.querySelector('[data-field="Duration_Min"] input');
        const maxDurationCell = row.querySelector('[data-field="Duration_Max"] input');
        const sessionTitleCell = row.querySelector('[data-field="Session_Title"]');

        sessionTitleCell.innerHTML = ''; // Clear existing control
        const originalValue = sessionType ? sessionType.Title : '';
        const newControl = createSessionTitleControl(selectedTypeId, originalValue);
        sessionTitleCell.appendChild(newControl);

        // Show/hide the project button based on the new session type
        const projectBtn = row.querySelector('.project-btn');
        if (projectBtn) {
            projectBtn.style.display = (sessionType && sessionType.Valid_for_Project) ? 'inline-block' : 'none';
        }


        if (sessionType) {
            if (sessionType.Is_Section) {
                if(ownerCell) ownerCell.disabled = true;
                if(minDurationCell) minDurationCell.disabled = true;
                if(maxDurationCell) maxDurationCell.disabled = true;
            } else {
                if(ownerCell) ownerCell.disabled = false;
                if(minDurationCell) minDurationCell.disabled = false;
                if(maxDurationCell) maxDurationCell.disabled = false;
            }
        }
    }


    function createEditableCell(field, originalValue, isSection, typeId) {
        const cell = document.createElement('td');
        cell.dataset.field = field;

        if (isSection && ['Owner_ID', 'Duration_Min', 'Duration_Max'].includes(field)) {
            cell.textContent = ''; // Display empty, non-editable cell for these fields in sections
            return cell;
        }

        if (field === 'Start_Time') {
            cell.textContent = originalValue;
            return cell;
        }

        if (field === 'Session_Title') {
            const control = createSessionTitleControl(typeId, originalValue);
            cell.appendChild(control);
        } else if (field === 'Type_ID') {
            const select = document.createElement('select');
            sessionTypes.forEach(type => {
                select.options.add(new Option(type.Title, type.id));
            });
            select.value = originalValue;
            select.onchange = () => handleSectionChange(select); // Add event listener
            cell.appendChild(select);
        } else if (field === 'Owner_ID') {
            const select = document.createElement('select');
            select.options.add(new Option('-- Select Owner --', ''));
            contacts.forEach(contact => {
                select.options.add(new Option(contact.Name, contact.id));
            });
            select.value = originalValue;
            cell.appendChild(select);
        } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            cell.appendChild(input);
        }
        return cell;
    }

    function addNewRow() {
        const tableBody = document.querySelector('#logs-table tbody');
        const meetingNumber = meetingFilter.value;
        if (!meetingNumber) {
            alert('Please select a meeting to add a session to.');
            return;
        }
        let newSeq = 1;

        const newRow = document.createElement('tr');
        newRow.dataset.id = 'new';
        newRow.dataset.isSection = 'false';
        newRow.dataset.meetingNumber = meetingNumber;

        const fields = [
            { name: 'Meeting_Seq', value: newSeq},
            { name: 'Start_Time', value: '' },
            { name: 'Session_Title', value: '' },
            { name: 'Type_ID', value: '' },
            { name: 'Owner_ID', value: '' },
            { name: 'Duration_Min', value: '' },
            { name: 'Duration_Max', value: '' }
        ];

        fields.forEach(field => {
            const cell = createEditableCell(field.name, field.value, false);
            cell.classList.add('edit-mode-cell');
            newRow.appendChild(cell);
        });

        const actionsCell = document.createElement('td');
        actionsCell.classList.add('actions-column');

        // Create and add the new project button
        const projectBtn = document.createElement('button');
        projectBtn.innerHTML = '<i class="fas fa-project-diagram"></i>';
        projectBtn.className = 'icon-btn project-btn'; // Added 'project-btn' class
        projectBtn.title = 'Select Project';
        projectBtn.onclick = function() { openProjectModal(this); };

        // Initially hide the project button; handleSectionChange will show it if needed
        projectBtn.style.display = 'none';
        actionsCell.appendChild(projectBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.className = 'delete-btn icon-btn';
        deleteBtn.onclick = function() { deleteLogRow(this); };
        actionsCell.appendChild(deleteBtn);
        newRow.appendChild(actionsCell);

        tableBody.insertBefore(newRow, tableBody.firstChild);
    }


    function toggleEditMode(enable) {
        isEditing = enable;
        const table = document.getElementById('logs-table');
        const tableContainer = document.getElementById('table-container'); // Get the container
        const header = table.querySelector('thead');
        const rows = table.querySelectorAll('tbody tr');

        // Add or remove the class based on the edit mode to control table width
        if (tableContainer) {
            if (enable) {
                tableContainer.classList.remove('non-edit-mode');
            } else {
                tableContainer.classList.add('non-edit-mode');
            }
        }

        header.querySelector('.edit-mode-header').style.display = enable ? 'table-row' : 'none';
        header.querySelector('.non-edit-mode-header').style.display = enable ? 'none' : 'table-row';

        rows.forEach(row => {
            const isSection = row.dataset.isSection === 'true';
            if (isSection) {
                row.classList.add('section-row');
            } else {
                row.classList.remove('section-row');
            }

            // Clear the row before rebuilding
            row.innerHTML = '';

            const fieldsOrder = ['Meeting_Seq', 'Start_Time','Type_ID', 'Session_Title', 'Owner_ID', 'Duration_Min', 'Duration_Max'];
            fieldsOrder.forEach(field => {
                const cell = createEditableCell(field, row.dataset[field.toLowerCase()], isSection);
                row.appendChild(cell);
            });

            const actionsCell = document.createElement('td');
            actionsCell.classList.add('actions-column');

            // Create and add the new project button
            const projectBtn = document.createElement('button');
            projectBtn.innerHTML = '<i class="fas fa-project-diagram"></i>';
            projectBtn.className = 'icon-btn project-btn'; // Added 'project-btn' class
            projectBtn.title = 'Select Project';
            // Update the project button's onclick
            projectBtn.onclick = function() { openProjectModal(this); };

            const sessionType = sessionTypes.find(st => st.id === parseInt(typeId, 10));
            if (sessionType && sessionType.Valid_for_Project) {
                projectBtn.style.display = 'inline-block';
            } else {
                projectBtn.style.display = 'none';
            }
            actionsCell.appendChild(projectBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.className = 'delete-btn icon-btn';
            deleteBtn.onclick = function() { deleteLogRow(this); };
            actionsCell.appendChild(deleteBtn);
            row.appendChild(actionsCell);
        });

        editButton.textContent = 'Save';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
        cancelButton.style.display = 'inline-block';
        addRowButton.style.display = 'inline-block';
        loadButton.style.display = 'none';
        exportButton.style.display = 'none';
    }

    function deleteLogRow(btn) {
        const row = btn.parentNode.parentNode;
        const logId = row.dataset.id;

        if (logId === 'new') {
            row.remove();
            return;
        }

        if (confirm('Are you sure you want to delete this log?')) {
            fetch(`/agenda/delete/${logId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                } else {
                    alert('Error deleting log: '.concat(data.message));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the log.');
            });
        }
    }

    function saveChanges() {
        const rows = document.querySelectorAll('#logs-table tbody tr');
        const dataToSave = [];

        rows.forEach(row => {
            if (row.style.display === 'none') {
                return;
            }

            const titleCell = row.querySelector('[data-field="Session_Title"]');
            const titleControl = titleCell.querySelector('input, select');
            let sessionTitle;

            const typeId = parseInt(row.querySelector('[data-field="Type_ID"] select').value, 10);
            const sessionType = sessionTypes.find(st => st.id === typeId);

            /*if (sessionType && sessionType.Title === 'Evaluation') {
                const selectedSpeaker = titleControl.value;
                sessionTitle = selectedSpeaker ? 'Evaluation for ' + selectedSpeaker : 'Evaluation';
            } else {*/
            sessionTitle = titleControl.value;


            const rowData = {
                id: row.dataset.id,
                project_id: row.dataset.projectId || row.dataset.project_id,
                meeting_number: row.dataset.meetingNumber,
                meeting_seq: row.querySelector('[data-field="Meeting_Seq"] input').value.trim(),
                start_time: row.querySelector('[data-field="Start_Time"]').textContent.trim(),
                session_title: sessionTitle,
                type_id: typeId,
                owner_id: row.querySelector('[data-field="Owner_ID"] select') ? row.querySelector('[data-field="Owner_ID"] select').value : null,
                duration_min: row.querySelector('[data-field="Duration_Min"] input') ? row.querySelector('[data-field="Duration_Min"] input').value : null,
                duration_max: row.querySelector('[data-field="Duration_Max"] input') ? row.querySelector('[data-field="Duration_Max"] input').value : null,
            };
            dataToSave.push(rowData);
        });

        fetch("{{ url_for('agenda_bp.update_logs') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSave),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error saving changes: '.concat(data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }

    // The event listener will now trigger a page reload with the new filter
    meetingFilter.addEventListener('change', applyMeetingFilter);

    if (editButton && cancelButton && addRowButton && loadButton) {
        editButton.addEventListener('click', function() {
            if (isEditing) {
                saveChanges();
            } else {
                toggleEditMode(true);
            }
        });
        cancelButton.addEventListener('click', function() {
            window.location.reload();
        });
        addRowButton.addEventListener('click', function() {
            addNewRow();
        });
    }

    exportButton.addEventListener('click', function() {
        const meetingNumber = meetingFilter.value;
        if (meetingNumber) {
            window.location.href = `/agenda/export/${meetingNumber}`;
        } else {
            alert('Please select a meeting to export.');
        }
    });

    document.getElementById('pathway-select').addEventListener('change', filterModalProjects);
    document.getElementById('level-select').addEventListener('change', filterModalProjects);

    // Initial call to populate the project dropdown
    filterModalProjects();

</script>

{% endblock %}