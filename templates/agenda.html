{% extends "base.html" %}

{% block title %}Meeting Agenda{% endblock %}

{% block content %}
    <h1>Meeting Agenda</h1>
    <br/>
    <div class="action-bar">
        <div class="inline-filter-group">
            <label for="meeting-filter">Meeting#:</label>
            <select id="meeting-filter">
                <option value="">All Meetings</option>
                {% for num in meeting_numbers %}
                <option value="{{ num }}" {% if num == selected_meeting %}selected{% endif %}>{{ num }}</option>
                {% endfor %}
            </select>
            {% if selected_meeting_date %}
            <span id="meeting-date-display" style="margin-left: 5px;">{{ selected_meeting_date.strftime('%B %d, %Y') }}</span>
            {% endif %}
        </div>

        {% if session.get('user_role') in ['Admin', 'Officer'] %}
        <div class="button-group" style="justify-content: flex-end;">
            <button id="cancel-edit-btn" class="btn btn-danger" style="display: none;">Cancel</button>
            <button id="create-btn" class="btn btn-success">New</button>
            <form id="load-form" action="{{ url_for('agenda_bp.load_csv') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="file" id="csv-file" style="display: none;" onchange="document.getElementById('load-form').submit()">
                <button id="load-btn" type="button" class="btn btn-info" onclick="document.getElementById('csv-file').click()">Import</button>
            </form>
            <button id="export-btn" class="btn btn-info">Export</button>
            <button id="add-row-btn" class="btn btn-info" style="display: none;">Add</button>
            <button id="edit-logs-btn" class="btn btn-primary">Edit</button>
        </div>
        {% endif %}
    </div>

    <div class='table-container non-edit-mode'
         id="table-container"
         data-session-types='{{ session_types|tojson|safe }}'
         data-contacts='{{ contacts_data|tojson|safe }}'
         data-projects='{{ projects|tojson|safe }}'
         data-project-speakers='{{ project_speakers|tojson|safe }}'>

        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th>No</th>
                    <th>Start Time</th>
                    <th>Session Type</th>
                    <th>Session Title</th>
                    <th>Owner</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log, is_section, session_type_title, is_titleless, meeting_date, code_dl, code_eh, code_ms, code_pi, code_pm, code_vc, code_dtm in logs %}
                <tr data-id="{{ log.id }}"
                    data-project-id="{{ log.Project_ID if log.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log.Meeting_Number }}"
                    data-meeting-date="{{ meeting_date.strftime('%Y-%m-%d') if meeting_date else '' }}"
                    data-is-section="{{ is_section|lower }}"
                    data-meeting-seq="{{ log.Meeting_Seq }}"
                    data-start-time="{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}"
                    data-session-title="{{ session_type_title if is_titleless else (log.Session_Title if log.Session_Title is not none else '') }}"
                    data-type-id="{{ log.Type_ID }}"
                    data-owner-id="{{ log.Owner_ID }}"
                    data-duration-min="{{ log.Duration_Min if log.Duration_Min is not none else '' }}"
                    data-duration-max="{{ log.Duration_Max if log.Duration_Max is not none else '' }}"
                    data-status="{{ log.Status if log.Status else '' }}"
                    class="{{ 'section-row' if is_section else '' }}">

                    {% if is_section %}
                        <td colspan="4" class="non-edit-mode-cell">
                            {{ log.Session_Title or session_type_title }}
                        </td>
                    {% else %}
                        <td class="non-edit-mode-cell">{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}</td>
                        <td class="non-edit-mode-cell">
                            {% if is_titleless %}
                                {{ session_type_title }}
                            {% else %}
                                {% if session_type_title == "Pathway Speech" %}
                                    {{ log.Session_Title }}
                                    {% set contact = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                                    {% if contact and contact.Working_Path %}
                                        {% if contact.Working_Path == 'Dynamic Leadership' %}(DL{{ code_dl }}){% endif %}
                                        {% if contact.Working_Path == 'Engaging Humor' %}(EH{{ code_eh }}){% endif %}
                                        {% if contact.Working_Path == 'Motivational Strategies' %}(MS{{ code_ms }}){% endif %}
                                        {% if contact.Working_Path == 'Persuasive Influence' %}(PI{{ code_pi }}){% endif %}
                                        {% if contact.Working_Path == 'Presentation Mastery' %}(PM{{ code_pm }}){% endif %}
                                        {% if contact.Working_Path == 'Visionary Communication' %}(VC{{ code_vc }}){% endif %}
                                    {% endif %}
                                {% elif session_type_title == 'Evaluation' %}
                                    Evaluation for {{ log.Session_Title }}
                                {% else %}
                                    {{ log.Session_Title }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% set owner = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                            {% if owner %}
                                {{ owner.Name }}
                                {% if owner.DTM %}
                                    <sup class="dtm-superscript">DTM</sup>
                                {% endif %}
                                <span class="owner-meta">
                                    {% if owner.Type == 'Guest' %}
                                        <br/>Guest{% if owner.Club %}@{{ owner.Club }}{% endif %}
                                    {% endif %}
                                    {% if owner.Type == 'Member' and owner.Completed_Levels %}
                                        <br/>{{ owner.Completed_Levels }}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% if log.Duration_Min and log.Duration_Max %}{{ log.Duration_Min }}'-{{ log.Duration_Max }}'
                            {% elif log.Duration_Max %}{{ log.Duration_Max }}'
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="createAgendaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateAgendaModal()">&times;</span>
            <h1>Create New Agenda</h1>
            <form action="{{ url_for('agenda_bp.create_from_template') }}" method="POST">
                <table class="form-table">
                    <tr>
                        <td><label for="meeting_number">Meeting Number:</label></td>
                        <td><input type="number" id="meeting_number" name="meeting_number" required></td>
                    </tr>
                    <tr>
                        <td><label for="meeting_date">Meeting Date:</label></td>
                        <td><input type="date" id="meeting_date" name="meeting_date" required></td>
                    </tr>
                    <tr>
                        <td><label for="start_time">Start Time:</label></td>
                        <td><input type="time" id="start_time" name="start_time" value="18:55" required></td>
                    </tr>
                    <tr>
                        <td><label for="template_file">Template:</label></td>
                        <td>
                            <select id="template_file" name="template_file" required>
                                {% for template in meeting_templates %}
                                    <option value="{{ template }}" {% if template == 'default.csv' %}selected{% endif %}>{{ template }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                </table>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Agenda</button>
                    <button type="button" class="btn btn-danger" onclick="closeCreateAgendaModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    {% include '_speech_edit_modal.html' %}
    {% include '_contact_modal.html' %}

    <script>
        const allProjects = {{ projects|tojson|safe }};
        const pathwayMap = {{ config.PATHWAY_MAPPING|tojson|safe }};
    </script>
    <script src="{{ url_for('static', filename='js/speech_modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
{% endblock %}