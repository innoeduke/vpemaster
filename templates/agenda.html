{% extends "base.html" %}

{% block title %}Meeting Agenda{% endblock %}

{% block content %}
    <h1>Meeting Agenda</h1>
    <br/>
    <div class="action-bar">
        <div class="inline-filter-group">
            <label for="meeting-filter">Meeting#:</label>
            <select id="meeting-filter">
                <option value="">All Meetings</option>
                {% for num in meeting_numbers %}
                <option value="{{ num }}" {% if num == selected_meeting %}selected{% endif %}>{{ num }}</option>
                {% endfor %}
            </select>
        </div>

        {% if session.get('user_role') in ['Admin', 'Officer'] %}
        <div class="button-group">
            <button id="cancel-edit-btn" class="btn btn-danger" style="display: none;">Cancel</button>
            <form id="load-form" action="{{ url_for('agenda_bp.load_csv') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="file" id="csv-file" style="display: none;" onchange="document.getElementById('load-form').submit()">
                <button id="load-btn" type="button" class="btn btn-info" onclick="document.getElementById('csv-file').click()">Load</button>
            </form>
            <button id="export-btn" class="btn btn-info">Save As</button>
            <button id="add-row-btn" class="btn btn-info" style="display: none;">Add</button>
            <button id="edit-logs-btn" class="btn btn-primary">Edit</button>
        </div>
        {% endif %}
    </div>

    <div class="table-container non-edit-mode"
         id="table-container"
         data-session-types="{{ session_types|tojson }}"
         data-contacts="{{ contacts|tojson }}"
         data-projects="{{ projects|tojson }}"
         data-project-speakers="{{ project_speakers|tojson }}">

        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th>No</th>
                    <th>Start Time</th>
                    <th>Session Type</th>
                    <th>Session Title</th>
                    <th>Owner</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log, is_section, session_type_title, is_titleless, meeting_date, code_dl, code_eh, code_ms, code_pi, code_pm, code_vc in logs %}
                <tr data-id="{{ log.id }}"
                    data-project-id="{{ log.Project_ID if log.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log.Meeting_Number }}"
                    data-meeting-date="{{ meeting_date.strftime('%Y-%m-%d') if meeting_date else '' }}"
                    data-is-section="{{ is_section|lower }}"
                    data-meeting-seq="{{ log.Meeting_Seq }}"
                    data-start-time="{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}"
                    data-session-title="{{ log.Session_Title if log.Session_Title is not none else '' }}"
                    data-type-id="{{ log.Type_ID }}"
                    data-owner-id="{{ log.Owner_ID }}"
                    data-duration-min="{{ log.Duration_Min if log.Duration_Min is not none else '' }}"
                    data-duration-max="{{ log.Duration_Max if log.Duration_Max is not none else '' }}"
                    data-status="{{ log.Status if log.Status else '' }}"
                    class="{{ 'section-row' if is_section else '' }}">

                    {% if is_section %}
                        <td colspan="4" class="non-edit-mode-cell">
                            {{ session_type_title }}
                        </td>
                    {% else %}
                        <td class="non-edit-mode-cell">{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}</td>
                        <td class="non-edit-mode-cell">
                            {% if is_titleless %}
                                {{ session_type_title }}
                            {% else %}
                                {% if session_type_title == "Pathway Speech" %}
                                    {{ log.Session_Title }}
                                    {% set contact = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                                    {% if contact and contact.Working_Path %}
                                        {% if contact.Working_Path == 'Dynamic Leadership' %}(DL{{ code_dl }}){% endif %}
                                        {% if contact.Working_Path == 'Engaging Humor' %}(EH{{ code_eh }}){% endif %}
                                        {% if contact.Working_Path == 'Motivational Strategies' %}(MS{{ code_ms }}){% endif %}
                                        {% if contact.Working_Path == 'Persuasive Influence' %}(PI{{ code_pi }}){% endif %}
                                        {% if contact.Working_Path == 'Presentation Mastery' %}(PM{{ code_pm }}){% endif %}
                                        {% if contact.Working_Path == 'Visionary Communication' %}(VC{{ code_vc }}){% endif %}
                                    {% endif %}
                                {% elif session_type_title == 'Evaluation' %}
                                    Evaluation for {{ log.Session_Title }}
                                {% else %}
                                    {{ log.Session_Title }}
                                {% endif %}
                            {% endif %}
                            {% if log.Project_ID %}
                                {% if log.Status == 'Completed' %}
                                    <i class="fas fa-check-circle" style="color: green;" title="Completed"></i>
                                {% else %}
                                    <button onclick="completeLog(this, {{ log.id }})" class="btn btn-success btn-sm">Complete</button>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% set owner = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                            {% if owner %}
                                {{ owner.Name }}
                                {% if owner.DTM %}
                                    <sup class="dtm-superscript">DTM</sup>
                                {% endif %}
                                <span class="owner-meta">
                                {% if owner.Type == 'Guest' %}
                                    <br/>Guest
                                    {% if owner.Club %}
                                        @{{ owner.Club }}
                                    {% endif %}
                                {% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% if log.Duration_Min and log.Duration_Max %}{{ log.Duration_Min }}'-{{ log.Duration_Max }}'
                            {% elif log.Duration_Max %}{{ log.Duration_Max }}'
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% include '_speech_log_modal.html' %}
    {% include '_contact_modal.html' %}

    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
{% endblock %}