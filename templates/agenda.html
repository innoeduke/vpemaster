{% extends "base.html" %}

{% block title %}Meeting Agenda{% endblock %}

{% block content %}
    <h1>Meeting Agenda</h1>
    <br/>
    <div class="action-bar">
        <div class="inline-filter-group">
            <label for="meeting-filter">Meeting#:</label>
            <select id="meeting-filter">
                <option value="">All Meetings</option>
                {% for num in meeting_numbers %}
                <option value="{{ num }}" {% if num == selected_meeting %}selected{% endif %}>{{ num }}</option>
                {% endfor %}
            </select>
        </div>

        {% if session.get('user_role') in ['Admin', 'Officer'] %}
        <div class="button-group">
            <button id="cancel-edit-btn" class="btn btn-danger" style="display: none;">Cancel</button>
            <form id="load-form" action="{{ url_for('agenda_bp.load_csv') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="file" id="csv-file" style="display: none;" onchange="document.getElementById('load-form').submit()">
                <button id="load-btn" type="button" class="btn btn-info" onclick="document.getElementById('csv-file').click()">Load</button>
            </form>
            <button id="export-btn" class="btn btn-info">Save As</button>
            <button id="add-row-btn" class="btn btn-info" style="display: none;">Add</button>
            <button id="edit-logs-btn" class="btn btn-primary">Edit</button>
        </div>
        {% endif %}
    </div>

    <div class='table-container non-edit-mode'
         id="table-container"
         data-session-types='{{ session_types|tojson|safe }}'
         data-contacts='{{ contacts_data|tojson|safe }}'
         data-projects='{{ projects|tojson|safe }}'
         data-project-speakers='{{ project_speakers|tojson|safe }}'>

        <table id="logs-table">
            <thead>
                <tr class="non-edit-mode-header">
                    <th><i class="fas fa-clock"></i></th>
                    <th><i class="fas fa-file-alt"></i> Session</th>
                    <th><i class="fas fa-user"></i> Owner</th>
                    <th><i class="fas fa-hourglass-half"></i> Min'</th>
                </tr>
                <tr class="edit-mode-header" style="display: none;">
                    <th>No</th>
                    <th>Start Time</th>
                    <th>Session Type</th>
                    <th>Session Title</th>
                    <th>Owner</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th class="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log, is_section, session_type_title, is_titleless, meeting_date, code_dl, code_eh, code_ms, code_pi, code_pm, code_vc in logs %}
                <tr data-id="{{ log.id }}"
                    data-project-id="{{ log.Project_ID if log.Project_ID is not none else '' }}"
                    data-meeting-number="{{ log.Meeting_Number }}"
                    data-meeting-date="{{ meeting_date.strftime('%Y-%m-%d') if meeting_date else '' }}"
                    data-is-section="{{ is_section|lower }}"
                    data-meeting-seq="{{ log.Meeting_Seq }}"
                    data-start-time="{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}"
                    data-session-title="{{ session_type_title if is_titleless else (log.Session_Title if log.Session_Title is not none else '') }}"
                    data-type-id="{{ log.Type_ID }}"
                    data-owner-id="{{ log.Owner_ID }}"
                    data-duration-min="{{ log.Duration_Min if log.Duration_Min is not none else '' }}"
                    data-duration-max="{{ log.Duration_Max if log.Duration_Max is not none else '' }}"
                    data-status="{{ log.Status if log.Status else '' }}"
                    class="{{ 'section-row' if is_section else '' }}">

                    {% if is_section %}
                        <td colspan="4" class="non-edit-mode-cell">
                            {{ session_type_title }}
                        </td>
                    {% else %}
                        <td class="non-edit-mode-cell">{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}</td>
                        <td class="non-edit-mode-cell">
                            {% if is_titleless %}
                                {{ session_type_title }}
                            {% else %}
                                {% if session_type_title == "Pathway Speech" %}
                                    {{ log.Session_Title }}
                                    {% set contact = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                                    {% if contact and contact.Working_Path %}
                                        {% if contact.Working_Path == 'Dynamic Leadership' %}(DL{{ code_dl }}){% endif %}
                                        {% if contact.Working_Path == 'Engaging Humor' %}(EH{{ code_eh }}){% endif %}
                                        {% if contact.Working_Path == 'Motivational Strategies' %}(MS{{ code_ms }}){% endif %}
                                        {% if contact.Working_Path == 'Persuasive Influence' %}(PI{{ code_pi }}){% endif %}
                                        {% if contact.Working_Path == 'Presentation Mastery' %}(PM{{ code_pm }}){% endif %}
                                        {% if contact.Working_Path == 'Visionary Communication' %}(VC{{ code_vc }}){% endif %}
                                    {% endif %}
                                {% elif session_type_title == 'Evaluation' %}
                                    Evaluation for {{ log.Session_Title }}
                                {% else %}
                                    {{ log.Session_Title }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% set owner = contacts|selectattr('id', 'equalto', log.Owner_ID)|first %}
                            {% if owner %}
                                {{ owner.Name }}
                                {% if owner.DTM %}
                                    <sup class="dtm-superscript">DTM</sup>
                                {% endif %}
                                <span class="owner-meta">
                                    {% if owner.Type == 'Guest' %}
                                        <br/>Guest{% if owner.Club %}@{{ owner.Club }}{% endif %}
                                    {% endif %}
                                    {% if owner.Type == 'Member' and owner.Completed_Levels %}
                                        <br/>{{ owner.Completed_Levels }}
                                    {% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="non-edit-mode-cell">
                            {% if log.Duration_Min and log.Duration_Max %}{{ log.Duration_Min }}'-{{ log.Duration_Max }}'
                            {% elif log.Duration_Max %}{{ log.Duration_Max }}'
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% include '_speech_edit_modal.html' %}
    {% include '_contact_modal.html' %}

    <script>
    const allProjects = {{ projects|tojson|safe }};
    const pathwayMap = {
        "Dynamic Leadership": "Code_DL",
        "Engaging Humor": "Code_EH",
        "Motivational Strategies": "Code_MS",
        "Persuasive Influence": "Code_PI",
        "Presentation Mastery": "Code_PM",
        "Visionary Communication": "Code_VC"
    };

    function openSpeechEditModal(logId) {
        fetch(`/speech_log/details/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit-log-id').value = data.log.id;
                document.getElementById('edit-speech-title').value = data.log.Session_Title;
                document.getElementById('edit-pathway').value = data.log.pathway;
                document.getElementById('edit-level').value = data.log.level;
                updateProjectOptions(data.log.Project_ID);
                document.getElementById('speechEditModal').style.display = 'flex';
            } else {
                alert('Error fetching speech log details.');
            }
        });
    }

    function closeSpeechEditModal() {
        document.getElementById('speechEditModal').style.display = 'none';
    }

    function updateProjectOptions(selectedProjectId = null) {
        const pathwaySelect = document.getElementById('edit-pathway');
        const levelSelect = document.getElementById('edit-level');
        const projectSelect = document.getElementById('edit-project');

        const selectedPathway = pathwaySelect.value;
        const selectedLevel = levelSelect.value;
        const codeAttr = pathwayMap[selectedPathway];

        projectSelect.innerHTML = '<option value="">-- Select a Project --</option>';

        if (selectedPathway && selectedLevel && codeAttr) {
            const filteredProjects = allProjects.filter(p => p[codeAttr] && p[codeAttr].startsWith(selectedLevel + '.'));

            filteredProjects.forEach(p => {
                const option = new Option(p.Project_Name, p.ID);
                projectSelect.add(option);
            });

            if (selectedProjectId) {
                projectSelect.value = selectedProjectId;
            }
        }
    }

    function saveSpeechChanges(event) {
        event.preventDefault();
        const logId = document.getElementById('edit-log-id').value;
        const form = document.getElementById('speechEditForm');
        const data = {
            session_title: form.querySelector('#edit-speech-title').value,
            project_id: form.querySelector('#edit-project').value,
            pathway: form.querySelector('#edit-pathway').value
        };

        fetch(`/speech_log/update/${logId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // For agenda, just reloading is the simplest way to see changes
                window.location.reload();
            } else {
                alert('Error updating speech log: ' + data.message);
            }
        });
    }

    // --- Contact Modal Logic ---
    const contactModal = document.getElementById("contactModal");
    const contactForm = document.getElementById("contactForm");
    const contactModalTitle = document.getElementById("contactModalTitle");

    function openContactModal() {
        contactForm.reset();
        contactModalTitle.textContent = 'Add New Contact';
        contactForm.action = "{{ url_for('contacts_bp.contact_form') }}";
        contactModal.style.display = "flex";
    }

    function closeContactModal() {
        contactModal.style.display = "none";
    }

    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default page reload
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    // Reload the page to see the new contact in the dropdowns
                    window.location.reload();
                } else {
                    alert('Failed to save contact.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the contact.');
            });
        });
    }
    </script>
    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
{% endblock %}