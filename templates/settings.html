{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
    <h1>System Settings</h1>

    <div class="settings-container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab(event, 'general')">General</button>
            <button class="tab-btn" onclick="openTab(event, 'sessions')">Sessions</button>
            <button class="tab-btn" onclick="openTab(event, 'agenda-settings')">Agenda</button>
            <button class="tab-btn" onclick="openTab(event, 'user-settings')">Users</button>
        </div>

        <div id="general" class="tab-content" style="display: block;">
            <h2>General Settings</h2>
            <p>General application settings will be managed here.</p>
        </div>

        <div id="sessions" class="tab-content">
            <div class="settings-header">
                <h2>Session Types</h2>
                <div class="button-group">
                    <button id="add-session-btn" class="btn btn-success">Add New</button>
                    <button id="edit-sessions-btn" class="btn btn-primary">Edit</button>
                    <button id="cancel-sessions-btn" class="btn btn-danger" style="display: none;">Cancel</button>
                </div>
            </div>
            <table id="sessions-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Default Owner</th>
                        <th>Role</th>
                        <th>Role Group</th>
                        <th>Min (mins)</th>
                        <th>Max (mins)</th>
                        <th>Section</th>
                        <th>Predefined</th>
                        <th>Project</th>
                        <th>Hidden</th>
                    </tr>
                </thead>
                <tbody>
                    {% for st in session_types %}
                    <tr data-id="{{ st.id }}">
                        <td>{{ st.id }}</td>
                        <td data-field="Title">{{ st.Title }}</td>
                        <td data-field="Default_Owner">{{ st.Default_Owner if st.Default_Owner is not none else '' }}</td>
                        <td data-field="Role">{{ st.Role if st.Role is not none else '' }}</td>
                        <td data-field="Role_Group">{{ st.Role_Group if st.Role_Group is not none else '' }}</td>
                        <td data-field="Duration_Min">{{ st.Duration_Min if st.Duration_Min is not none else '' }}</td>
                        <td data-field="Duration_Max">{{ st.Duration_Max if st.Duration_Max is not none else '' }}</td>
                        <td data-field="Is_Section">
                            <input type="checkbox" {% if st.Is_Section %}checked{% endif %} disabled>
                        </td>
                        <td data-field="Predefined">
                            <input type="checkbox" {% if st.Predefined%}checked{% endif %} disabled>
                        </td>
                        <td data-field="Valid_for_Project">
                            <input type="checkbox" {% if st.Valid_for_Project %}checked{% endif %} disabled>
                        </td>
                        <td data-field="Is_Hidden">
                            <input type="checkbox" {% if st.Is_Hidden %}checked{% endif %} disabled>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="agenda-settings" class="tab-content">
            <h2>Agenda Settings</h2>
            <p>Settings related to the meeting agenda, templates, and session types will be configured here.</p>
        </div>

        <div id="user-settings" class="tab-content">
            <h2>User Management</h2>
            <div class="settings-header">
                <div class="button-group">
                    <a href="{{ url_for('users_bp.user_form') }}" class="btn btn-primary">Add New User</a>
                    <form action="{{ url_for('users_bp.bulk_import_users') }}" method="post" enctype="multipart/form-data" id="bulk-import-form" style="display: inline;">
                        <input type="file" name="file" id="bulk-import-file" style="display: none;" onchange="document.getElementById('bulk-import-form').submit()">
                        <button type="button" class="btn btn-info" onclick="document.getElementById('bulk-import-file').click()">Bulk Import</button>
                    </form>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Full Name (Username)</th>
                        <th>Role</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Mentor</th>
                        <th>Status</th>
                        <th>Date Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr class="{{ 'inactive-user' if user.Status == 'inactive' else '' }}">
                        <td>{{ loop.index }}</td>
                        <td>
                            {% if user.contact %}
                                {{ user.contact.Name }}
                                ({{ user.Username }})
                                <i class="fas fa-link" style="color: green; margin-left: 5px;"></i>
                            {% else %}
                                <em style="color: #888;">Not Linked</em>
                            {% endif %}
                        </td>
                        <td>{{ user.Role }}</td>
                        <td>{{ user.Email if user.Email else '' }}</td>
                        <td>{{ user.contact.Phone_Number if user.contact and user.contact.Phone_Number else '' }}</td>
                        <td>{{ user.mentor.Name if user.mentor else '' }}</td>
                        <td>{{ user.Status }}</td>
                        <td>{{ user.Date_Created.strftime('%Y-%m-%d') if user.Date_Created else '' }}</td>
                        <td>
                            <div class="action-links">
                                <a href="{{ url_for('users_bp.user_form', user_id=user.id) }}" class="icon-btn" title="Edit"><i class="fas fa-edit"></i></a>
                                <button class="delete-btn icon-btn" onclick="openDeleteModal('{{ url_for('users_bp.delete_user', user_id=user.id) }}', 'user')" title="Delete"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% include '_session_modal.html' %}

<script>
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        const tablinks = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";

        // Handle both click event (has evt) and programmatic call (uses tabName)
        let targetElement = null;
        if (evt && evt.currentTarget) {
            targetElement = evt.currentTarget;
        } else {
            // Find the button associated with the tabName
            for (let i = 0; i < tablinks.length; i++) {
                if (tablinks[i].getAttribute('onclick').includes(`'${tabName}'`)) {
                    targetElement = tablinks[i];
                    break;
                }
            }
        }

        if (targetElement) {
            targetElement.className += " active";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Check URL for default_tab parameter
        const urlParams = new URLSearchParams(window.location.search);
        const defaultTab = urlParams.get('default_tab');
        if (defaultTab) {
            // Pass null for evt to indicate a programmatic call
            openTab(null, defaultTab);
        }

        // --- Add Session Modal ---
        const addSessionBtn = document.getElementById('add-session-btn');
        const sessionModal = document.getElementById('addSessionModal');
        const closeSessionModalBtn = sessionModal.querySelector('.close');

        addSessionBtn.addEventListener('click', () => {
            sessionModal.style.display = 'flex';
        });

        closeSessionModalBtn.addEventListener('click', () => {
            sessionModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == sessionModal) {
                sessionModal.style.display = 'none';
            }
        });


        // --- Session Types Edit Logic ---
        const editSessionsBtn = document.getElementById('edit-sessions-btn');
        const cancelSessionsBtn = document.getElementById('cancel-sessions-btn');
        const sessionsTableBody = document.querySelector('#sessions-table tbody');
        let isEditingSessions = false;
        let originalSessionsData = {};

        editSessionsBtn.addEventListener('click', () => {
            if (isEditingSessions) {
                saveSessionChanges();
            } else {
                toggleSessionEditMode(true);
            }
        });

        cancelSessionsBtn.addEventListener('click', () => {
            toggleSessionEditMode(false);
            sessionsTableBody.querySelectorAll('tr').forEach(row => {
                const id = row.dataset.id;
                const originalRow = originalSessionsData[id];
                row.querySelectorAll('td[data-field]').forEach(cell => {
                    const field = cell.dataset.field;
                    if (field.startsWith('Is_') || field === 'Valid_for_Project' || field == 'Predefined') {
                        cell.innerHTML = `<input type="checkbox" ${originalRow[field] ? 'checked' : ''} disabled>`;
                    } else {
                        cell.textContent = originalRow[field];
                    }
                });
            });
        });

        function toggleSessionEditMode(enable) {
            isEditingSessions = enable;
            editSessionsBtn.textContent = enable ? 'Save' : 'Edit';
            cancelSessionsBtn.style.display = enable ? 'inline-block' : 'none';

            sessionsTableBody.querySelectorAll('tr').forEach(row => {
                const id = row.dataset.id;
                if (enable) {
                    originalSessionsData[id] = {};
                }
                row.querySelectorAll('td[data-field]').forEach(cell => {
                    const field = cell.dataset.field;
                    const currentValue = cell.textContent.trim();

                    if (enable) {
                        originalSessionsData[id][field] = currentValue;
                    }

                    if (field.startsWith('Is_') || field === 'Valid_for_Project' || field == 'Predefined') {
                        const checkbox = cell.querySelector('input[type="checkbox"]');
                        if (enable) {
                            originalSessionsData[id][field] = checkbox.checked;
                            checkbox.disabled = false;
                        } else {
                            checkbox.disabled = true;
                        }
                    } else {
                        if (enable) {
                            const input = document.createElement('input');
                            input.type = (field.includes('Duration')) ? 'number' : 'text';
                            input.value = currentValue;
                            input.className = 'form-control-sm';
                            cell.textContent = '';
                            cell.appendChild(input);
                        }
                    }
                });
            });
        }

        function saveSessionChanges() {
            const dataToSave = [];
            sessionsTableBody.querySelectorAll('tr').forEach(row => {
                const rowData = { id: row.dataset.id };
                row.querySelectorAll('td[data-field]').forEach(cell => {
                    const field = cell.dataset.field;
                    if (field.startsWith('Is_') || field === 'Valid_for_Project' || field == 'Predefined') {
                        rowData[field] = cell.querySelector('input[type="checkbox"]').checked;
                    } else {
                        rowData[field] = cell.querySelector('input').value;
                    }
                });
                dataToSave.push(rowData);
            });

            fetch('/settings/sessions/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toggleSessionEditMode(false);
                    sessionsTableBody.querySelectorAll('tr').forEach(row => {
                        const id = row.dataset.id;
                        const updatedRow = dataToSave.find(item => item.id == id);
                        row.querySelectorAll('td[data-field]').forEach(cell => {
                            const field = cell.dataset.field;
                            if (field.startsWith('Is_') || field === 'Valid_for_Project' || field == 'Predefined') {
                                cell.innerHTML = `<input type="checkbox" ${updatedRow[field] ? 'checked' : ''} disabled>`;
                            } else {
                                 cell.textContent = updatedRow[field];
                            }
                        });
                    });
                } else {
                    alert('Error saving changes: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving.');
            });
        }
    });
</script>
{% endblock %}

