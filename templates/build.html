{% extends "base.html" %}

{% block title %}Agenda Builder{% endblock %}

{% block content %}
    <style>
        /* This ensures the table layout is respected even with dynamic content */
        #logs-table {
            table-layout: fixed;
            width: 100%;
        }

        .edit-mode-cell input[type="text"], .edit-mode-cell select {
            width: 100%;
            box-sizing: border-box;
        }

        /* Column widths for NON-EDIT mode */
        #logs-table .non-edit-mode-header th:nth-child(1) { width: 10%; } /* Time */
        #logs-table .non-edit-mode-header th:nth-child(2) { width: 45%; } /* Session */
        #logs-table .non-edit-mode-header th:nth-child(3) { width: 25%; } /* Host */
        #logs-table .non-edit-mode-header th:nth-child(4) { width: 20%; } /* Duration */

        /* Column widths for EDIT mode */
        #logs-table .edit-mode-header th:nth-child(1) { width: 5%; }  /* No */
        #logs-table .edit-mode-header th:nth-child(2) { width: 10%; } /* Start Time */
        #logs-table .edit-mode-header th:nth-child(3) { width: 20%; } /* Session Type */
        #logs-table .edit-mode-header th:nth-child(4) { width: 25%; } /* Session Title */
        #logs-table .edit-mode-header th:nth-child(5) { width: 15%; } /* Owner */
        #logs-table .edit-mode-header th:nth-child(6) { width: 7%; }  /* Min */
        #logs-table .edit-mode-header th:nth-child(7) { width: 7%; }  /* Max */
        #logs-table .edit-mode-header th:nth-child(8) { width: 11%; } /* Actions */

    </style>
    <h1>Meeting Agenda</h1>

    <div class="action-bar">
        <div class="inline-filter-group">
            <label for="meeting-filter">Meeting:</label>
            <select id="meeting-filter">
                <option value="">All Meetings</option>
                {% for num in meeting_numbers %}
                <option value="{{ num }}">{{ num }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="button-group">
            <button id="edit-logs-btn" class="add-button">Edit</button>
            <button id="add-row-btn" class="add-button" style="display: none;">Add</button>
            <button id="cancel-edit-btn" class="cancel-btn" style="display: none;">Cancel</button>
            <form id="load-form" action="{{ url_for('build_bp.load_csv') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="file" id="csv-file" style="display: none;" onchange="document.getElementById('load-form').submit()">
                <button id="load-btn" type="button" class="add-button" onclick="document.getElementById('csv-file').click()">Load</button>
            </form>
        </div>
    </div>

    <table id="logs-table">
        <thead>
            <tr class="non-edit-mode-header">
                <th>Time</th>
                <th>Session</th>
                <th>Host</th>
                <th>Duration (min)</th>
            </tr>
            <tr class="edit-mode-header" style="display: none;">
                <th>No</th>
                <th>Start Time</th>
                <th>Session Type</th>
                <th>Session Title</th>
                <th>Owner</th>
                <th>Min</th>
                <th>Max</th>
                <th class="actions-column">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for log, is_section in logs %}
            <tr data-id="{{ log.id }}"
                data-meeting-number="{{ log.Meeting_Number }}"
                data-is-section="{{ is_section|lower }}"
                data-meeting_seq="{{ log.Meeting_Seq }}"
                data-start_time="{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}"
                data-type_id="{{ log.Type_ID }}"
                data-session_title="{{ log.Session_Title if log.Session_Title is not none else '' }}"
                data-owner_id="{{ log.Owner_ID }}"
                data-duration_min="{{ log.Duration_Min if log.Duration_Min is not none else '' }}"
                data-duration_max="{{ log.Duration_Max if log.Duration_Max is not none else '' }}"
                class="{{ 'section-row' if is_section else '' }}">

                {% if is_section %}
                    <td colspan="4" class="non-edit-mode-cell">
                        {{ log.Session_Title }}
                    </td>
                {% else %}
                    <td class="non-edit-mode-cell">{{ log.Start_Time.strftime('%H:%M') if log.Start_Time is not none else '' }}</td>
                    <td class="non-edit-mode-cell">
                        {{ log.Session_Title }}
                    </td>
                    <td class="non-edit-mode-cell">
                        {% for contact in contacts %}{% if contact.id == log.Owner_ID %}{{ contact.Name }}{% endif %}{% endfor %}
                    </td>
                    <td class="non-edit-mode-cell">
                        {% if log.Duration_Min and log.Duration_Max %}{{ log.Duration_Min }}'-{{ log.Duration_Max }}'
                        {% elif log.Duration_Max %}{{ log.Duration_Max }}'
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

<script>
    const sessionTypes = {{ session_types|tojson }};
    const contacts = {{ contacts|tojson }};
    const editButton = document.getElementById('edit-logs-btn');
    const cancelButton = document.getElementById('cancel-edit-btn');
    const addRowButton = document.getElementById('add-row-btn');
    const loadButton = document.getElementById('load-btn');
    const meetingFilter = document.getElementById('meeting-filter');
    let isEditing = false;

    if (editButton && cancelButton && addRowButton && loadButton) {
        editButton.addEventListener('click', function() {
            if (isEditing) {
                saveChanges();
            } else {
                toggleEditMode(true);
            }
        });
        cancelButton.addEventListener('click', function() {
            window.location.reload();
        });
        addRowButton.addEventListener('click', function() {
            addNewRow();
        });
    }

    meetingFilter.addEventListener('change', function() {
        const selectedMeeting = this.value;
        const rows = document.querySelectorAll('#logs-table tbody tr');
        rows.forEach(row => {
            if (selectedMeeting === '' || row.dataset.meetingNumber === selectedMeeting) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });


    function handleSectionChange(selectElement) {
        const selectedTypeId = parseInt(selectElement.value, 10);
        const sessionType = sessionTypes.find(st => st.id === selectedTypeId);
        const row = selectElement.closest('tr');
        const sessionTitleCell = row.querySelector('[data-field="Session_Title"]');
        const ownerCell = row.querySelector('[data-field="Owner_ID"] select');
        const minDurationCell = row.querySelector('[data-field="Duration_Min"] input');
        const maxDurationCell = row.querySelector('[data-field="Duration_Max"] input');


        if (sessionType) {
            sessionTitleCell.querySelector('input').value = sessionType.Title;
            if (sessionType.Is_Section) {
                if(ownerCell) ownerCell.disabled = true;
                if(minDurationCell) minDurationCell.disabled = true;
                if(maxDurationCell) maxDurationCell.disabled = true;
            } else {
                if(ownerCell) ownerCell.disabled = false;
                if(minDurationCell) minDurationCell.disabled = false;
                if(maxDurationCell) maxDurationCell.disabled = false;
            }
        }
    }


    function createEditableCell(field, originalValue, isSection) {
        const cell = document.createElement('td');
        cell.dataset.field = field;

        if (isSection && ['Owner_ID', 'Duration_Min', 'Duration_Max'].includes(field)) {
            cell.textContent = ''; // Display empty, non-editable cell for these fields in sections
            return cell;
        }

        if (field === 'Start_Time') {
            cell.textContent = originalValue;
            return cell;
        }

        if (field === 'Type_ID') {
            const select = document.createElement('select');
            sessionTypes.forEach(type => {
                select.options.add(new Option(type.Title, type.id));
            });
            select.value = originalValue;
            select.onchange = () => handleSectionChange(select); // Add event listener
            cell.appendChild(select);
        } else if (field === 'Owner_ID') {
            const select = document.createElement('select');
            select.options.add(new Option('-- Select Owner --', ''));
            contacts.forEach(contact => {
                select.options.add(new Option(contact.Name, contact.id));
            });
            select.value = originalValue;
            cell.appendChild(select);
        } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            cell.appendChild(input);
        }
        return cell;
    }

    function addNewRow() {
        const tableBody = document.querySelector('#logs-table tbody');
        const meetingNumber = meetingFilter.value;
        if (!meetingNumber) {
            alert('Please select a meeting to add a session to.');
            return;
        }
        let newSeq = 1;

        const newRow = document.createElement('tr');
        newRow.dataset.id = 'new';
        newRow.dataset.isSection = 'false';
        newRow.dataset.meetingNumber = meetingNumber;

        const fields = [
            { name: 'Meeting_Seq', value: newSeq},
            { name: 'Start_Time', value: '' },
            { name: 'Type_ID', value: '' },
            { name: 'Session_Title', value: '' },
            { name: 'Owner_ID', value: '' },
            { name: 'Duration_Min', value: '' },
            { name: 'Duration_Max', value: '' }
        ];

        fields.forEach(field => {
            const cell = createEditableCell(field.name, field.value, false);
            cell.classList.add('edit-mode-cell');
            newRow.appendChild(cell);
        });

        const actionsCell = document.createElement('td');
        actionsCell.classList.add('actions-column');
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.className = 'button delete-btn icon-btn';
        deleteBtn.onclick = function() { deleteLogRow(this); };
        actionsCell.appendChild(deleteBtn);
        newRow.appendChild(actionsCell);

        tableBody.insertBefore(newRow, tableBody.firstChild);
    }


    function toggleEditMode(enable) {
        isEditing = enable;
        const table = document.getElementById('logs-table');
        const header = table.querySelector('thead');
        const rows = table.querySelectorAll('tbody tr');

        header.querySelector('.edit-mode-header').style.display = enable ? 'table-row' : 'none';
        header.querySelector('.non-edit-mode-header').style.display = enable ? 'none' : 'table-row';

        rows.forEach(row => {
            const isSection = row.dataset.isSection === 'true';
            if (isSection) {
                row.classList.add('section-row');
            } else {
                row.classList.remove('section-row');
            }

            // Clear the row before rebuilding
            row.innerHTML = '';

            const fieldsOrder = ['Meeting_Seq', 'Start_Time', 'Type_ID', 'Session_Title', 'Owner_ID', 'Duration_Min', 'Duration_Max'];
            fieldsOrder.forEach(field => {
                const cell = createEditableCell(field, row.dataset[field.toLowerCase()], isSection);
                row.appendChild(cell);
            });

            const actionsCell = document.createElement('td');
            actionsCell.classList.add('actions-column');
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.className = 'button delete-btn icon-btn';
            deleteBtn.onclick = function() { deleteLogRow(this); };
            actionsCell.appendChild(deleteBtn);
            row.appendChild(actionsCell);
        });

        editButton.textContent = 'Done';
        editButton.classList.remove('add-button');
        editButton.classList.add('done-btn');
        cancelButton.style.display = 'inline-block';
        addRowButton.style.display = 'inline-block';
        loadButton.style.display = 'none';
    }

    function deleteLogRow(btn) {
        const row = btn.parentNode.parentNode;
        const logId = row.dataset.id;

        if (logId === 'new') {
            row.remove();
            return;
        }

        if (confirm('Are you sure you want to delete this log?')) {
            fetch(`/build/delete/${logId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                } else {
                    alert('Error deleting log: '.concat(data.message));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the log.');
            });
        }
    }

    function saveChanges() {
        const rows = document.querySelectorAll('#logs-table tbody tr');
        const dataToSave = [];

        rows.forEach(row => {
            if (row.style.display === 'none') {
                return;
            }
            const rowData = {
                id: row.dataset.id,
                meeting_number: row.dataset.meetingNumber,
                meeting_seq: row.querySelector('[data-field="Meeting_Seq"] input').value.trim(),
                start_time: row.querySelector('[data-field="Start_Time"]').textContent.trim(),
                type_id: row.querySelector('[data-field="Type_ID"] select').value,
                session_title: row.querySelector('[data-field="Session_Title"] input').value,
                owner_id: row.querySelector('[data-field="Owner_ID"] select') ? row.querySelector('[data-field="Owner_ID"] select').value : null,
                duration_min: row.querySelector('[data-field="Duration_Min"] input') ? row.querySelector('[data-field="Duration_Min"] input').value : null,
                duration_max: row.querySelector('[data-field="Duration_Max"] input') ? row.querySelector('[data-field="Duration_Max"] input').value : null,
            };
            dataToSave.push(rowData);
        });

        fetch("{{ url_for('build_bp.update_logs') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSave),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error saving changes: '.concat(data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (meetingFilter.options.length > 1) {
            meetingFilter.selectedIndex = 1; // Select the first meeting number (largest)
            meetingFilter.dispatchEvent(new Event('change')); // Trigger the filter
        }
    });
</script>

{% endblock %}