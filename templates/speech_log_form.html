{% extends "base.html" %}

{% block title %}{{ 'Edit Speech Log' if log else 'Add New Speech Log' }}{% endblock %}

{% block content %}
    <h1>{{ 'Edit Speech Log' if log else 'Add New Speech Log' }}</h1>
    <form method="POST" action="{{ url_for('speech_logs_bp.save_speech_log', log_id=log.id) if log else url_for('speech_logs_bp.add_speech_log') }}">
        <table class="form-table">
            {% if session.get('user_role') in ['Admin', 'Officer'] %}
            <tr>
                <td><label for="meeting_number">Meeting Number:</label></td>
                <td><input type="number" id="meeting_number" name="meeting_number" value="{{ log.Meeting_Number if log else '' }}" required></td>
            </tr>
            <tr>
                <td><label for="meeting_date">Meeting Date:</label></td>
                <td><input type="date" id="meeting_date" name="meeting_date" value="{{ log.Meeting_Date.strftime('%Y-%m-%d') if log and log.Meeting_Date else '' }}" required></td>
            </tr>
            <tr>
                <td><label for="contact_id">Name:</label></td>
                <td>
                    <select id="contact_id" name="contact_id" required>
                        <option value="">Select a member</option>
                        {% for member in members %}
                            <option value="{{ member.id }}" data-pathway="{{ member.Working_Path }}" {% if log and log.Contact_ID == member.id %}selected{% endif %}>
                                {{ member.Name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="session">Meeting Session:</label></td>
                <td>
                    <select id="session" name="session" required>
                        <option value="Prepared Speech" {% if log and log.Session == 'Prepared Speech' %}selected{% endif %}>Prepared Speech</option>
                        <option value="Evaluation" {% if log and log.Session == 'Evaluation' %}selected{% endif %}>Evaluation</option>
                        <option value="Table Topic" {% if log and log.Session == 'Table Topic' %}selected{% endif %}>Table Topic</option>
                        <option value="Keynote Speech" {% if log and log.Session == 'Keynote Speech' %}selected{% endif %}>Keynote Speech</option>
                    </select>
                </td>
            </tr>
            {% endif %}
            <tr>
                <td><label for="pathway">Pathway:</label></td>
                <td>
                    {% if session.get('user_role') == 'Member' %}
                        <input type="hidden" id="pathway" name="pathway" value="{{ log.Pathway if log else '' }}">
                        <p>{{ log.Pathway if log else '' }}</p>
                    {% else %}
                    <select id="pathway" name="pathway">
                        <option value="Dynamic Leadership">Dynamic Leadership</option>
                        <option value="Engaging Humor">Engaging Humor</option>
                        <option value="Motivational Strategies">Motivational Strategies</option>
                        <option value="Persuasive Influence">Persuasive Influence</option>
                        <option value="Presentation Mastery">Presentation Mastery</option>
                        <option value="Visionary Communication">Visionary Communication</option>
                        <option value="Non-Path: Distinguished Toastmaster">Non-Path: Distinguished Toastmaster</option>
                        <option value="Non-Path: Other">Non-Path: Other</option>
                    </select>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><label for="level">Project Code:</label></td>
                <td><input type="text" id="level" name="level" value="{{ log.Level if log else '' }}" placeholder="e.g., 2.1"></td>
            </tr>
            <tr>
                <td><label for="project_id">Project Name:</label></td>
                <td>
                    <select id="project_id" name="project_id">
                        <option value="">-- Select a Project --</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="speech_title">Speech Title:</label></td>
                <td><input type="text" id="speech_title" name="speech_title" value="{{ log.Speech_Title if log else '' }}" required></td>
            </tr>
            <tr>
                <td><label for="evaluator">Evaluator:</label></td>
                <td><input type="text" id="evaluator" name="evaluator" value="{{ log.Evaluator if log else '' }}"></td>
            </tr>
        </table>
        <div class="form-actions">
            <button type="submit" class="btn btn-success">Save</button>
            <a href="{{ url_for('speech_logs_bp.show_speech_logs') }}" class="btn btn-danger">Cancel</a>
        </div>
    </form>

    <script>
        const projects = {{ projects|tojson }};
        const pathwayElement = document.getElementById('pathway');
        const projectCodeInput = document.getElementById('level');
        const projectSelect = document.getElementById('project_id');
        const userRole = "{{ session.get('user_role') }}";

        if (userRole !== 'Member') {
            // Event listeners for Admins and Officers
            document.getElementById('contact_id').addEventListener('change', function() {
                var selectedOption = this.options[this.selectedIndex];
                var pathway = selectedOption.getAttribute('data-pathway');
                if (pathway) {
                    pathwayElement.value = pathway;
                }
                filterProjects();
            });
            pathwayElement.addEventListener('change', filterProjects);
        }

        projectCodeInput.addEventListener('input', filterProjects);

        function validateProjectCode(code) {
            const regex = /^[1-5](\.\d+){1,2}$/;
            return regex.test(code);
        }

        function filterProjects() {
            const selectedPathway = pathwayElement.value;
            const projectCode = projectCodeInput.value;

            projectSelect.innerHTML = '<option value="">-- Select a Project --</option>';

            if (validateProjectCode(projectCode)) {
                const pathwayCodeMapping = {
                    "Dynamic Leadership": "Code_DL",
                    "Engaging Humor": "Code_EH",
                    "Motivational Strategies": "Code_MS",
                    "Persuasive Influence": "Code_PI",
                    "Presentation Mastery": "Code_PM",
                    "Visionary Communication": "Code_VC"
                };
                const pathwayKey = pathwayCodeMapping[selectedPathway];

                const filtered = projects.filter(p => {
                    const code = p[pathwayKey];
                    return code && code.startsWith(projectCode);
                });

                filtered.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.ID;
                    option.textContent = p.Project_Name;
                    projectSelect.appendChild(option);
                });

                // If there's only one project in the filtered list (plus the placeholder), select it.
                if (projectSelect.options.length === 2) {
                    projectSelect.selectedIndex = 1;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (userRole !== 'Member' && document.getElementById('contact_id').selectedIndex > 0) {
                 document.getElementById('contact_id').dispatchEvent(new Event('change'));
            }

            // Set initial pathway value if log exists
            {% if log and log.Pathway %}
                pathwayElement.value = "{{ log.Pathway }}";
            {% endif %}
            filterProjects();
            // Set initial project title value if log exists
            {% if project_id %}
                projectSelect.value = "{{ project_id }}";
            {% endif %}
        });
    </script>
{% endblock %}

