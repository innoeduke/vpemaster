{% extends "base.html" %}

{% block title %}Pathway Library{% endblock %}

{% block content %}
<div id="pathway-library-container">
    <h1>Pathway Library</h1>

    <style>
        .markdown-editor-container {
            display: flex;
            gap: 15px;
        }
        .markdown-editor-container.hidden {
            display: none !important;
        }
        .markdown-editor-container textarea,
        .markdown-preview {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 120px;
            box-sizing: border-box;
            border-radius: 4px;
        }
        .markdown-editor-container textarea {
            border-right: none;
            resize: vertical;
            font-family: monospace;
        }
        .markdown-preview {
            background-color: #f8f8f8;
            border-left: 1px solid #ccc;
            overflow-y: auto;
            line-height: 1.6;
        }
        /* The plain-text-content class is no longer needed since content is raw HTML */
    </style>

    <div class="filters-container">
        <div class="form-group">
            <label for="path">Path:</label>
            <select id="path" name="path">
                <option value="DL">Dynamic Leadership</option>
                <option value="EH">Engaging Humor</option>
                <option value="MS">Motivational Strategies</option>
                <option value="PI">Persuasive Influence</option>
                <option value="PM">Presentation Mastery</option>
                <option value="VC">Visionary Communication</option>
                <option value="DTM">Distinguished Toastmasters</option>
            </select>
        </div>
        <div class="form-group">
            <label for="level">Level:</label>
            <select id="level" name="level">
                <option value="">All Levels</option>
                {% for i in range(1, 6) %}
                <option value="{{ i }}">Level {{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="project">Project:</label>
            <select id="project" name="project">
                <option value="">-- Select a Project --</option>
            </select>
        </div>
    </div>

    <div id="project-details" class="project-details-container" style="display: none;">
        <div class="project-header">
            <h2 id="project-name"></h2>
            {% if session.get('user_role') == 'Admin' %}
            <div class="button-group">
                <button id="cancel-project-btn" class="icon-btn" style="display: none;" title="Cancel"><i class="fas fa-times"></i></button>
                <button id="edit-project-btn" class="icon-btn" title="Edit"><i class="fas fa-edit"></i></button>
            </div>
            {% endif %}
        </div>
        <div class="path-codes">
            <div class="path-code-box path-dl" id="dl-code" data-path="DL">DL: <span></span></div>
            <div class="path-code-box path-eh" id="eh-code" data-path="EH">EH: <span></span></div>
            <div class="path-code-box path-ms" id="ms-code" data-path="MS">MS: <span></span></div>
            <div class="path-code-box path-pi" id="pi-code" data-path="PI">PI: <span></span></div>
            <div class="path-code-box path-pm" id="pm-code" data-path="PM">PM: <span></span></div>
            <div class="path-code-box path-vc" id="vc-code" data-path="VC">VC: <span></span></div>
            <div class="path-code-box path-dtm" id="dtm-code" data-path="DTM">DTM: <span></span></div>
        </div>
        <br/>
        <div class="project-section">
            <h3>Purpose</h3>
            <p id="project-purpose"></p>
            <div id="editor-purpose-container" class="markdown-editor-container hidden">
                <textarea id="edit-purpose" class="edit-textarea" rows="3"></textarea>
                <div class="markdown-preview" id="preview-purpose"></div>
            </div>
        </div>
        <div class="project-section">
            <h3>Introduction</h3>
            <p id="project-introduction"></p>
            <div id="editor-introduction-container" class="markdown-editor-container hidden">
                <textarea id="edit-introduction" class="edit-textarea" rows="3"></textarea>
                <div class="markdown-preview" id="preview-introduction"></div>
            </div>
        </div>
        <div class="project-section">
            <h3>Overview</h3>
            <p id="project-overview"></p>
            <div id="editor-overview-container" class="markdown-editor-container hidden">
                <textarea id="edit-overview" class="edit-textarea" rows="3"></textarea>
                <div class="markdown-preview" id="preview-overview"></div>
            </div>
        </div>
        <div class="project-section">
            <h3>Requirements</h3>
            <p id="project-requirements"></p>
            <div id="editor-requirements-container" class="markdown-editor-container hidden">
                <textarea id="edit-requirements" class="edit-textarea" rows="3"></textarea>
                <div class="markdown-preview" id="preview-requirements"></div>
            </div>
        </div>
        <div class="project-section">
            <h3>Resources</h3>
            <p id="project-resources"></p>
            <div id="editor-resources-container" class="markdown-editor-container hidden">
                <textarea id="edit-resources" class="edit-textarea" rows="3"></textarea>
                <div class="markdown-preview" id="preview-resources"></div>
            </div>
        </div>
    </div>
</div>
    <script>
        const projects = {{ projects|tojson }};
        let isEditing = false;

        // --- Functions defined globally for accessibility ---

        // NOTE: This client-side function is ONLY used for the LIVE PREVIEW,
        // the server-side Python module handles the actual display rendering.
        function markdownToHtml(markdown) {
            let html = markdown || '';

            html = html.replace(/\n/g, '<br>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            html = html.replace(/<br>\* (.*?)(<br>|$)/g, '<li>$1</li>');
            if (html.includes('<li>')) {
                html = '<ul>' + html + '</ul>';
                html = html.replace(/<br><ul>/g, '<ul>');
                html = html.replace(/<\/li><br>/g, '</li>');
            }
            return html;
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function updatePreview(textarea) {
            const fieldName = textarea.id.replace('edit-', '');
            const previewElement = document.getElementById(`preview-${fieldName}`);
            if (previewElement) {
                previewElement.innerHTML = markdownToHtml(textarea.value);
            }
            autoResizeTextarea(textarea);
        }

        function updatePathCodes(project) {
            document.querySelector('#dl-code span').textContent = project.Code_DL || 'N/A';
            document.querySelector('#eh-code span').textContent = project.Code_EH || 'N/A';
            document.querySelector('#ms-code span').textContent = project.Code_MS || 'N/A';
            document.querySelector('#pi-code span').textContent = project.Code_PI || 'N/A';
            document.querySelector('#pm-code span').textContent = project.Code_PM || 'N/A';
            document.querySelector('#vc-code span').textContent = project.Code_VC || 'N/A';
            document.querySelector('#dtm-code span').textContent = project.Code_DTM || 'N/A';
        }

        function clearPathCodes() {
            document.querySelectorAll('.path-code-box span').forEach(span => span.textContent = '');
        }

        function toggleEditView() {
            const editButton = document.getElementById('edit-project-btn');
            const cancelButton = document.getElementById('cancel-project-btn');
            const pTags = document.querySelectorAll('#project-details .project-section p');
            const textareas = document.querySelectorAll('#project-details .project-section textarea');
            const editorContainers = document.querySelectorAll('.markdown-editor-container');

            const projectSelect = document.getElementById('project');
            const projectId = parseInt(projectSelect.value, 10);
            const currentProject = projects.find(p => p.ID === projectId);


            if (isEditing) {
                editButton.innerHTML = '<i class="fas fa-check"></i>';
                cancelButton.style.display = 'inline-block';

                pTags.forEach(p => p.style.display = 'none');
                editorContainers.forEach(container => container.classList.remove('hidden'));

                textareas.forEach(textarea => {
                    const fieldName = textarea.id.replace('edit-', '');

                    if (currentProject) {
                        // FIX: Use the raw Markdown field (e.g., Introduction_raw) to populate the textarea
                        const rawContent = currentProject[`${fieldName}_raw`] || '';
                        textarea.value = rawContent;

                        updatePreview(textarea);
                    }
                });
            } else {
                editButton.innerHTML = '<i class="fas fa-edit"></i>';
                cancelButton.style.display = 'none';

                pTags.forEach(p => p.style.display = 'block');
                editorContainers.forEach(container => container.classList.add('hidden'));

                displayProjectDetails();
            }
        }

        function displayProjectDetails() {
            const projectSelect = document.getElementById('project');
            const projectDetails = document.getElementById('project-details');

            const projectId = parseInt(projectSelect.value, 10);
            const project = projects.find(p => p.ID === projectId);

            if (project) {
                document.getElementById('project-name').textContent = project.Project_Name || '';

                // The server now provides rendered HTML, so we use innerHTML
                document.getElementById('project-purpose').innerHTML = project.Purpose || '';
                document.getElementById('project-introduction').innerHTML = project.Introduction || '';
                document.getElementById('project-overview').innerHTML = project.Overview || '';
                document.getElementById('project-requirements').innerHTML = project.Requirements || '';
                document.getElementById('project-resources').innerHTML = project.Resources || '';

                updatePathCodes(project);
                projectDetails.style.display = 'block';
            } else {
                projectDetails.style.display = 'none';
                clearPathCodes();
            }

            if (isEditing) {
                toggleEditView();
            }
        }

        function filterProjects() {
            const pathSelect = document.getElementById('path');
            const levelSelect = document.getElementById('level');
            const projectSelect = document.getElementById('project');
            const projectDetails = document.getElementById('project-details');

            const selectedPathSuffix = pathSelect.value;
            const selectedPath = "Code_" + selectedPathSuffix;
            const levelValue = levelSelect.value;

            projectSelect.innerHTML = '<option value="">-- Select a Project --</option>';
            projectDetails.style.display = 'none';
            clearPathCodes();
            if (isEditing) {
                isEditing = false;
                toggleEditView();
            }

            if (levelValue) {
                const filteredProjects = projects.filter(p => {
                    const code = p[selectedPath];
                    return code && code.startsWith(levelValue);
                });

                filteredProjects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.ID;
                    option.textContent = p.Project_Name;
                    projectSelect.appendChild(option);
                });

                if (projectSelect.options.length > 1) {
                    projectSelect.selectedIndex = 1;
                    displayProjectDetails();
                }
            }
        }

        function saveProjectChanges() {
            const projectSelect = document.getElementById('project');
            const projectId = parseInt(projectSelect.value, 10);
            if (!projectId) return;

            // Send raw markdown content
            const data = {
                Introduction: document.getElementById('edit-introduction').value,
                Overview: document.getElementById('edit-overview').value,
                Purpose: document.getElementById('edit-purpose').value,
                Requirements: document.getElementById('edit-requirements').value,
                Resources: document.getElementById('edit-resources').value
            };

            fetch(`/pathway_library/update_project/${projectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const projectIndex = projects.findIndex(p => p.ID === projectId);
                    if (projectIndex > -1) {
                        // Update the local array with BOTH rendered HTML and raw Markdown
                        projects[projectIndex].Introduction = data.Introduction;
                        projects[projectIndex].Overview = data.Overview;
                        projects[projectIndex].Purpose = data.Purpose;
                        projects[projectIndex].Requirements = data.Requirements;
                        projects[projectIndex].Resources = data.Resources;

                        projects[projectIndex].Introduction_raw = data.Introduction_raw;
                        projects[projectIndex].Overview_raw = data.Overview_raw;
                        projects[projectIndex].Purpose_raw = data.Purpose_raw;
                        projects[projectIndex].Requirements_raw = data.Requirements_raw;
                        projects[projectIndex].Resources_raw = data.Resources_raw;
                    }
                    isEditing = false;
                    toggleEditView();
                } else {
                     alert('Failed to save changes.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while saving.');
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const pathSelect = document.getElementById('path');
            const levelSelect = document.getElementById('level');
            const projectSelect = document.getElementById('project');
            const pathBoxes = document.querySelectorAll('.path-code-box');
            const editButton = document.getElementById('edit-project-btn');
            const cancelButton = document.getElementById('cancel-project-btn');
            const textareas = document.querySelectorAll('#project-details .project-section textarea');

            if (pathSelect && levelSelect) {
                pathSelect.value = 'PM';
                levelSelect.value = '1';
                filterProjects();
            }

            if (pathSelect) pathSelect.addEventListener('change', filterProjects);
            if (levelSelect) levelSelect.addEventListener('change', filterProjects);
            if (projectSelect) projectSelect.addEventListener('change', displayProjectDetails);

            pathBoxes.forEach(box => {
                box.addEventListener('click', function() {
                    if (pathSelect) pathSelect.value = this.dataset.path;
                    filterProjects();
                });
            });

            if (editButton) {
                editButton.addEventListener('click', () => {
                    if (isEditing) {
                        saveProjectChanges();
                    } else {
                        isEditing = true;
                        toggleEditView();
                    }
                });
            }

            if (cancelButton) {
                cancelButton.addEventListener('click', () => {
                    isEditing = false;
                    toggleEditView();
                });
            }

            textareas.forEach(textarea => {
                textarea.addEventListener('input', function(event) {
                    updatePreview(event.target);
                });
            });

        });
    </script>
{% endblock %}