{% extends "base.html" %}

{% block title %}Pathway Library{% endblock %}

{% block content %}
<div id="pathway-library-container">
    <h1>Pathway Library</h1>

    <div class="filters-container">
        <div class="form-group">
            <label for="path">Path:</label>
            <select id="path" name="path">
                <option value="Code_DL">Dynamic Leadership</option>
                <option value="Code_EH">Engaging Humor</option>
                <option value="Code_MS">Motivational Strategies</option>
                <option value="Code_PI">Persuasive Influence</option>
                <option value="Code_PM">Presentation Mastery</option>
                <option value="Code_VC">Visionary Communication</option>
            </select>
        </div>
        <div class="form-group">
            <label for="level">Level:</label>
            <select id="level" name="level">
                <option value="">All Levels</option>
                {% for i in range(1, 6) %}
                <option value="{{ i }}">Level {{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="project">Project:</label>
            <select id="project" name="project">
                <option value="">-- Select a Project --</option>
            </select>
        </div>
    </div>

    <div id="project-details" class="project-details-container" style="display: none;">
        <div class="project-header">
            <h2 id="project-name"></h2>
            {% if session.get('user_role') == 'Admin' %}
            <div class="button-group">
                <button id="cancel-project-btn" class="icon-btn" style="display: none;" title="Cancel"><i class="fas fa-times"></i></button>
                <button id="edit-project-btn" class="icon-btn" title="Edit"><i class="fas fa-edit"></i></button>
            </div>
            {% endif %}
        </div>
        <div class="path-codes">
            <div class="path-code-box path-dl" id="dl-code" data-path="Code_DL">DL: <span></span></div>
            <div class="path-code-box path-eh" id="eh-code" data-path="Code_EH">EH: <span></span></div>
            <div class="path-code-box path-ms" id="ms-code" data-path="Code_MS">MS: <span></span></div>
            <div class="path-code-box path-pi" id="pi-code" data-path="Code_PI">PI: <span></span></div>
            <div class="path-code-box path-pm" id="pm-code" data-path="Code_PM">PM: <span></span></div>
            <div class="path-code-box path-vc" id="vc-code" data-path="Code_VC">VC: <span></span></div>
        </div>
        <br/>
        <div class="project-section">
            <h3>Purpose</h3>
            <p id="project-purpose"></p>
            <textarea id="edit-purpose" class="edit-textarea" style="display: none;" rows="3"></textarea>
        </div>
        <div class="project-section">
            <h3>Introduction</h3>
            <p id="project-introduction"></p>
            <textarea id="edit-introduction" class="edit-textarea" style="display: none;" rows="3"></textarea>
        </div>
        <div class="project-section">
            <h3>Overview</h3>
            <p id="project-overview"></p>
            <textarea id="edit-overview" class="edit-textarea" style="display: none;" rows="3"></textarea>
        </div>
        <div class="project-section">
            <h3>Requirements</h3>
            <p id="project-requirements"></p>
            <textarea id="edit-requirements" class="edit-textarea" style="display: none;" rows="3"></textarea>
        </div>
        <div class="project-section">
            <h3>Resources</h3>
            <p id="project-resources"></p>
            <textarea id="edit-resources" class="edit-textarea" style="display: none;" rows="3"></textarea>
        </div>
    </div>
</div>
    <script>
        const projects = {{ projects|tojson }};
        let isEditing = false;

        const pathSelect = document.getElementById('path');
        const levelSelect = document.getElementById('level'); // Changed from levelRadios
        const projectSelect = document.getElementById('project');
        const projectDetails = document.getElementById('project-details');
        const pathBoxes = document.querySelectorAll('.path-code-box');
        const editButton = document.getElementById('edit-project-btn');
        const cancelButton = document.getElementById('cancel-project-btn');
        const textareas = document.querySelectorAll('#project-details .project-section textarea');

        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function filterProjects() {
            const selectedPath = pathSelect.value;
            const levelValue = levelSelect.value; // Changed from querySelector

            projectSelect.innerHTML = '<option value="">-- Select a Project --</option>';
            projectDetails.style.display = 'none';
            clearPathCodes();
            if (isEditing) {
                toggleEditView();
            }

            if (levelValue) { // Check if a level is selected
                const filteredProjects = projects.filter(p => {
                    const code = p[selectedPath];
                    return code && code.startsWith(levelValue);
                });

                filteredProjects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.ID;
                    option.textContent = p.Project_Name;
                    projectSelect.appendChild(option);
                });

                if (projectSelect.options.length > 1) {
                    projectSelect.selectedIndex = 1;
                    displayProjectDetails();
                }
            }
        }

        function displayProjectDetails() {
            const projectId = parseInt(projectSelect.value, 10);
            const project = projects.find(p => p.ID === projectId);

            if (project) {
                document.getElementById('project-name').textContent = project.Project_Name;
                document.getElementById('project-purpose').textContent = project.Purpose;
                document.getElementById('project-introduction').textContent = project.Introduction;
                document.getElementById('project-overview').textContent = project.Overview;
                document.getElementById('project-requirements').textContent = project.Requirements;
                document.getElementById('project-resources').textContent = project.Resources;

                updatePathCodes(project);
                projectDetails.style.display = 'block';
            } else {
                projectDetails.style.display = 'none';
                clearPathCodes();
            }

            if (isEditing) {
                toggleEditView();
            }
        }

        function updatePathCodes(project) {
            document.querySelector('#dl-code span').textContent = project.Code_DL || 'N/A';
            document.querySelector('#eh-code span').textContent = project.Code_EH || 'N/A';
            document.querySelector('#ms-code span').textContent = project.Code_MS || 'N/A';
            document.querySelector('#pi-code span').textContent = project.Code_PI || 'N/A';
            document.querySelector('#pm-code span').textContent = project.Code_PM || 'N/A';
            document.querySelector('#vc-code span').textContent = project.Code_VC || 'N/A';
        }

        function clearPathCodes() {
            document.querySelectorAll('.path-code-box span').forEach(span => span.textContent = '');
        }

        function toggleEditView() {
            isEditing = !isEditing;

            const pTags = document.querySelectorAll('#project-details .project-section p');

            if (isEditing) {
                editButton.innerHTML = '<i class="fas fa-check"></i>';
                cancelButton.style.display = 'inline-block';
                pTags.forEach(p => p.style.display = 'none');
                textareas.forEach(textarea => {
                    const pId = textarea.id.replace('edit-', 'project-');
                    const pElement = document.getElementById(pId);
                    textarea.value = pElement.textContent;
                    textarea.style.display = 'block';
                    autoResizeTextarea({ target: textarea });
                });
            } else {
                editButton.innerHTML = '<i class="fas fa-edit"></i>';
                cancelButton.style.display = 'none';
                pTags.forEach(p => p.style.display = 'block');
                textareas.forEach(textarea => textarea.style.display = 'none');
                displayProjectDetails();
            }
        }

        function saveProjectChanges() {
            const projectId = parseInt(projectSelect.value, 10);
            if (!projectId) return;

            const data = {
                Introduction: document.getElementById('edit-introduction').value,
                Overview: document.getElementById('edit-overview').value,
                Purpose: document.getElementById('edit-purpose').value,
                Requirements: document.getElementById('edit-requirements').value,
                Resources: document.getElementById('edit-resources').value
            };

            fetch(`/pathway_library/update_project/${projectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const projectIndex = projects.findIndex(p => p.ID === projectId);
                    if (projectIndex > -1) {
                        projects[projectIndex].Introduction = data.Introduction;
                        projects[projectIndex].Overview = data.Overview;
                        projects[projectIndex].Purpose = data.Purpose;
                        projects[projectIndex].Requirements = data.Requirements;
                        projects[projectIndex].Resources = data.Resources;
                    }
                    toggleEditView();
                } else {
                     alert('Failed to save changes.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while saving.');
            });
        }

        window.onload = function() {
            pathSelect.value = 'Code_PM';
            levelSelect.value = '1'; // Set default level
            filterProjects();
        };

        pathSelect.addEventListener('change', filterProjects);
        levelSelect.addEventListener('change', filterProjects); // Changed from levelRadios
        projectSelect.addEventListener('change', displayProjectDetails);

        pathBoxes.forEach(box => {
            box.addEventListener('click', function() {
                pathSelect.value = this.dataset.path;
                filterProjects();
            });
        });

        if (editButton) {
            editButton.addEventListener('click', () => {
                if (isEditing) {
                    saveProjectChanges();
                } else {
                    toggleEditView();
                }
            });
        }

        if (cancelButton) {
            cancelButton.addEventListener('click', () => {
                toggleEditView();
            });
        }

        textareas.forEach(textarea => {
            textarea.addEventListener('input', autoResizeTextarea);
        });

    </script>
{% endblock %}